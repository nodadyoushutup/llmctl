<p class="muted" style="margin-top: 6px; font-size: 12px;">
  Add scripts to each stage and reorder within that stage.
</p>
<div class="grid grid-2" style="margin-top: 16px;">
  {% for script_type, label in script_type_choices %}
    {% set field_name = script_type_fields.get(script_type, "script_ids") %}
    {% set available_scripts = scripts_by_type.get(script_type, []) %}
    {% set selected_scripts = selected_scripts_by_type.get(script_type, []) %}
    <div class="subcard" data-script-bucket data-field-name="{{ field_name }}">
      <p class="eyebrow">{{ label }}</p>
      <div class="row" style="margin-top: 10px; gap: 8px; align-items: center;">
        <select class="input" data-script-select>
          <option value="">Select script</option>
          {% for script in available_scripts %}
            <option
              value="{{ script.id }}"
              data-label="{{ script.file_name }}"
              data-description="{{ script.description or '' }}"
            >
              {{ script.file_name }}
            </option>
          {% endfor %}
        </select>
        <button type="button" class="btn btn-secondary" data-script-add>
          <i class="fa-solid fa-plus"></i>
          add
        </button>
      </div>
      {% if not available_scripts %}
        <p class="muted" style="margin-top: 8px; font-size: 12px;">
          No scripts available for this stage.
        </p>
      {% endif %}
      <ul data-script-list style="margin-top: 12px; list-style: none; padding: 0;">
        {% for script in selected_scripts %}
          <li data-script-id="{{ script.id }}" style="margin-bottom: 8px;">
            <input type="hidden" name="{{ field_name }}" value="{{ script.id }}" />
            <div class="row" style="gap: 12px; justify-content: space-between; align-items: center;">
              <div>
                <p>{{ script.file_name }}</p>
                <p class="muted" style="font-size: 12px; margin-top: 4px;">
                  {{ script.description or "No description." }}
                </p>
              </div>
              <div class="row" style="gap: 6px;">
                <button type="button" class="btn btn-secondary" data-action="up" aria-label="Move up">
                  <i class="fa-solid fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-secondary" data-action="down" aria-label="Move down">
                  <i class="fa-solid fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-danger" data-action="remove" aria-label="Remove script">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
      <p
        class="muted"
        data-script-empty
        style="margin-top: 8px; font-size: 12px; {% if selected_scripts %}display: none;{% endif %}"
      >
        No scripts added yet.
      </p>
    </div>
  {% endfor %}
</div>

<script>
  (() => {
    const buckets = document.querySelectorAll("[data-script-bucket]");
    if (!buckets.length) {
      return;
    }

    const toggleEmptyState = (bucket) => {
      const list = bucket.querySelector("[data-script-list]");
      const empty = bucket.querySelector("[data-script-empty]");
      if (!list || !empty) {
        return;
      }
      empty.style.display = list.children.length ? "none" : "block";
    };

    const buildListItem = (fieldName, scriptId, label, description) => {
      const item = document.createElement("li");
      item.dataset.scriptId = scriptId;
      item.style.marginBottom = "8px";

      const input = document.createElement("input");
      input.type = "hidden";
      input.name = fieldName;
      input.value = scriptId;

      const row = document.createElement("div");
      row.className = "row";
      row.style.gap = "12px";
      row.style.justifyContent = "space-between";
      row.style.alignItems = "center";

      const text = document.createElement("div");
      const name = document.createElement("p");
      name.textContent = label;
      const desc = document.createElement("p");
      desc.className = "muted";
      desc.style.fontSize = "12px";
      desc.style.marginTop = "4px";
      desc.textContent = description || "No description.";
      text.appendChild(name);
      text.appendChild(desc);

      const actions = document.createElement("div");
      actions.className = "row";
      actions.style.gap = "6px";

      const makeButton = (action, iconClass, labelText, danger = false) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = danger ? "btn btn-danger" : "btn btn-secondary";
        button.dataset.action = action;
        button.setAttribute("aria-label", labelText);
        const icon = document.createElement("i");
        icon.className = iconClass;
        button.appendChild(icon);
        return button;
      };

      actions.appendChild(makeButton("up", "fa-solid fa-arrow-up", "Move up"));
      actions.appendChild(makeButton("down", "fa-solid fa-arrow-down", "Move down"));
      actions.appendChild(
        makeButton("remove", "fa-solid fa-trash", "Remove script", true)
      );

      row.appendChild(text);
      row.appendChild(actions);

      item.appendChild(input);
      item.appendChild(row);
      return item;
    };

    const addSelectedScript = (bucket, select, list, fieldName) => {
      const selectedOption = select.options[select.selectedIndex];
      if (!selectedOption || !selectedOption.value) {
        return;
      }
      const scriptId = selectedOption.value;
      if (list.querySelector(`[data-script-id="${scriptId}"]`)) {
        return;
      }
      const label = selectedOption.dataset.label || selectedOption.textContent.trim();
      const description = selectedOption.dataset.description || "";
      const item = buildListItem(fieldName, scriptId, label, description);
      list.appendChild(item);
      select.value = "";
      toggleEmptyState(bucket);
    };

    buckets.forEach((bucket) => {
      const select = bucket.querySelector("[data-script-select]");
      const addButton = bucket.querySelector("[data-script-add]");
      const list = bucket.querySelector("[data-script-list]");
      const fieldName = bucket.dataset.fieldName || "script_ids";

      if (!select || !addButton || !list) {
        return;
      }

      toggleEmptyState(bucket);

      addButton.addEventListener("click", () => {
        addSelectedScript(bucket, select, list, fieldName);
      });

      list.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) {
          return;
        }
        const action = button.dataset.action;
        const item = button.closest("li[data-script-id]");
        if (!item) {
          return;
        }
        if (action === "remove") {
          item.remove();
          toggleEmptyState(bucket);
          return;
        }
        if (action === "up") {
          const prev = item.previousElementSibling;
          if (prev) {
            list.insertBefore(item, prev);
          }
          return;
        }
        if (action === "down") {
          const next = item.nextElementSibling;
          if (next) {
            list.insertBefore(next, item);
          }
        }
      });

      const form = bucket.closest("form");
      if (form) {
        form.addEventListener("submit", () => {
          addSelectedScript(bucket, select, list, fieldName);
        });
      }
    });
  })();
</script>
