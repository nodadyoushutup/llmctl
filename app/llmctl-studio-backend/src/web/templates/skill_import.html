{% extends "base.html" %}

{% block topbar_actions %}
  <a class="btn btn-secondary" href="{{ url_for('agents.list_skills') }}">
    <i class="fa-solid fa-arrow-left"></i>
    all skills
  </a>
{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Import Skill</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Import from bundle upload or local package directory. Git sources are deferred.
  </p>
  <form
    method="post"
    action="{{ url_for('agents.import_skill_submit') }}"
    class="form-grid"
    enctype="multipart/form-data"
    style="margin-top: 20px;"
  >
    {% set source_kind = form_values.get('source_kind', 'upload') %}
    <label class="label">
      source
      <select name="source_kind" class="input" id="sourceKindSelect">
        <option value="upload" {% if source_kind == 'upload' %}selected{% endif %}>upload bundle JSON</option>
        <option value="path" {% if source_kind == 'path' %}selected{% endif %}>local package path</option>
        <option value="git" {% if source_kind == 'git' %}selected{% endif %}>git source (deferred)</option>
      </select>
    </label>
    <label class="label" data-source-field="upload">
      bundle file
      <input type="file" name="bundle_file" class="input" />
    </label>
    <label class="label" data-source-field="path">
      local path
      <input
        type="text"
        name="local_path"
        class="input"
        value="{{ form_values.get('local_path', '') }}"
        placeholder="/path/to/skill-package"
      />
    </label>
    <label class="label" data-source-field="git">
      git url (v1.1)
      <input
        type="text"
        name="git_url"
        class="input"
        value="{{ form_values.get('git_url', '') }}"
        placeholder="https://github.com/org/repo.git"
      />
    </label>
    <label class="label">
      source ref (optional)
      <input
        type="text"
        name="source_ref"
        class="input"
        value="{{ form_values.get('source_ref', '') }}"
        placeholder="release-2026-02"
      />
    </label>
    <label class="label">
      actor (optional)
      <input
        type="text"
        name="actor"
        class="input"
        value="{{ form_values.get('actor', '') }}"
        placeholder="ops-user"
      />
    </label>
    <div class="form-actions">
      <button type="submit" name="action" value="preview" class="btn btn-secondary">
        <i class="fa-solid fa-list-check"></i>
        validate preview
      </button>
      <button type="submit" name="action" value="import" class="btn btn-primary">
        <i class="fa-solid fa-file-import"></i>
        import
      </button>
    </div>
  </form>
</section>

{% if validation_errors %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Validation Errors</h2>
  </div>
  <div style="margin-top: 14px; overflow-x: auto;">
    <table class="table">
      <thead>
        <tr>
          <th>Code</th>
          <th>Message</th>
          <th>Path</th>
          <th>Field</th>
        </tr>
      </thead>
      <tbody>
        {% for error in validation_errors %}
          <tr>
            <td><p>{{ error.code }}</p></td>
            <td><p>{{ error.message }}</p></td>
            <td><p class="muted">{{ error.path or '-' }}</p></td>
            <td><p class="muted">{{ error.field or '-' }}</p></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

{% if preview %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Validation Preview</h2>
  </div>
  <div class="grid grid-2" style="margin-top: 16px;">
    <div class="subcard">
      <p class="eyebrow">metadata</p>
      <div class="stack" style="margin-top: 10px; font-size: 12px;">
        <p class="muted">Slug: {{ preview.metadata.name }}</p>
        <p class="muted">Display: {{ preview.metadata.display_name }}</p>
        <p class="muted">Version: {{ preview.metadata.version }}</p>
        <p class="muted">Status: {{ preview.metadata.status }}</p>
        <p class="muted">Manifest hash: {{ preview.manifest_hash }}</p>
      </div>
    </div>
    <div class="subcard">
      <p class="eyebrow">compatibility hints</p>
      {% if preview.compatibility_hints %}
        <ul style="margin: 10px 0 0 18px; padding: 0;">
          {% for hint in preview.compatibility_hints %}
            <li style="margin: 4px 0;">{{ hint }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted" style="margin-top: 10px;">No compatibility hints.</p>
      {% endif %}
      {% if preview.warnings %}
        <p class="eyebrow" style="margin-top: 16px;">warnings</p>
        <ul style="margin: 10px 0 0 18px; padding: 0;">
          {% for warning in preview.warnings %}
            <li style="margin: 4px 0;">{{ warning }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  </div>
  <div style="margin-top: 16px; overflow-x: auto;">
    <table class="table">
      <thead>
        <tr>
          <th>Path</th>
          <th>Size</th>
          <th>Checksum</th>
        </tr>
      </thead>
      <tbody>
        {% for file in preview.files %}
          <tr>
            <td><p>{{ file.path }}</p></td>
            <td><p>{{ file.size_bytes }}</p></td>
            <td><p class="muted">{{ file.checksum }}</p></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

<script>
  const sourceSelect = document.getElementById("sourceKindSelect");
  const sourceFields = document.querySelectorAll("[data-source-field]");

  function syncSourceFields() {
    const selected = String(sourceSelect ? sourceSelect.value : "upload").trim().toLowerCase();
    sourceFields.forEach((field) => {
      const key = String(field.getAttribute("data-source-field") || "").trim().toLowerCase();
      field.style.display = key === selected ? "block" : "none";
    });
  }

  if (sourceSelect) {
    sourceSelect.addEventListener("change", syncSourceFields);
  }
  syncSourceFields();
</script>
{% endblock %}
