{% extends "base.html" %}

{% macro pagination_controls(pagination) %}
  <nav class="pagination" aria-label="Plans pages">
    {% if pagination.prev_url %}
      <a class="pagination-btn" href="{{ pagination.prev_url }}">Prev</a>
    {% else %}
      <span class="pagination-btn is-disabled" aria-disabled="true">Prev</span>
    {% endif %}
    <div class="pagination-pages">
      {% for item in pagination.page_items %}
        {% if item.is_gap %}
          <span class="pagination-ellipsis">&hellip;</span>
        {% elif item.is_current %}
          <span class="pagination-link is-active" aria-current="page">{{ item.label }}</span>
        {% else %}
          <a class="pagination-link" href="{{ item.url }}">{{ item.label }}</a>
        {% endif %}
      {% endfor %}
    </div>
    {% if pagination.next_url %}
      <a class="pagination-btn" href="{{ pagination.next_url }}">Next</a>
    {% else %}
      <span class="pagination-btn is-disabled" aria-disabled="true">Next</span>
    {% endif %}
  </nav>
{% endmacro %}

{% block action_header %}
  <div class="pagination-bar pagination-bar-header">
    {{ pagination_controls(pagination) }}
  </div>
{% endblock %}

{% block content %}
<section class="card workflow-list-card">
  <div class="card-header">
    <h2 class="section-title">Plans</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Track multi-stage plans and task completion with explicit completion timestamps.
  </p>
  {% if plans %}
    <div class="workflow-list-table-shell">
      <table class="table">
        <thead>
          <tr>
            <th>Plan</th>
            <th>Completed</th>
            <th>Stages</th>
            <th>Tasks</th>
            <th class="table-actions-cell">Edit</th>
          </tr>
        </thead>
        <tbody>
          {% for item in plans %}
            {% set plan = item.plan %}
            <tr
              class="table-row-link"
              data-href="{{ url_for('agents.view_plan', plan_id=plan.id) }}"
            >
              <td>
                <a href="{{ url_for('agents.view_plan', plan_id=plan.id) }}">
                  <p>{{ plan.name }}</p>
                </a>
                {% if plan.description %}
                  <p class="muted" style="margin-top: 6px; font-size: 12px;">
                    {{ plan.description | truncate(140, True, "...") }}
                  </p>
                {% endif %}
              </td>
              <td class="muted">
                {{ human_time(plan.completed_at) }}
              </td>
              <td class="muted">{{ item.stage_count }}</td>
              <td class="muted">{{ item.task_count }}</td>
              <td class="table-actions-cell">
                <a
                  class="icon-button"
                  href="{{ url_for('agents.edit_plan', plan_id=plan.id) }}"
                  aria-label="Edit plan"
                >
                  <i class="fa-solid fa-pen-to-square"></i>
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 16px;">
      No plans found yet. Add a Plan node in a flowchart to create one.
    </p>
  {% endif %}
</section>

<script>
  const planRows = document.querySelectorAll(".table-row-link");
  planRows.forEach((row) => {
    row.addEventListener("click", (event) => {
      const target = event.target;
      if (
        target.closest("a") ||
        target.closest("button") ||
        target.closest("input") ||
        target.closest("select") ||
        target.closest("textarea") ||
        target.closest("label") ||
        target.closest("summary") ||
        target.closest("details")
      ) {
        return;
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });
  });
</script>
{% endblock %}
