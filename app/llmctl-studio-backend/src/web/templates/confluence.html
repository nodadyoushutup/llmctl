{% extends "base.html" %}

{% block content %}
<style>
  .confluence-layout {
    display: grid;
    grid-template-columns: 300px minmax(0, 1fr);
    gap: 16px;
    align-items: start;
  }
  .confluence-pages {
    max-height: calc(100vh - 230px);
    overflow: auto;
    padding-right: 4px;
  }
  .confluence-page-link {
    display: block;
    border: 1px solid var(--line);
    border-radius: 10px;
    margin-bottom: 6px;
    padding: 8px 10px;
    background: rgba(17, 24, 33, 0.72);
    transition: border-color 0.16s ease, background 0.16s ease;
    padding-left: calc(10px + (var(--depth, 0) * 14px));
  }
  .confluence-page-link:hover {
    border-color: rgba(255, 122, 24, 0.5);
    background: rgba(255, 122, 24, 0.08);
  }
  .confluence-page-link.is-active {
    border-color: rgba(255, 122, 24, 0.62);
    background: rgba(255, 122, 24, 0.14);
  }
  .confluence-page-title {
    display: block;
    font-size: 13px;
    line-height: 1.3;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .confluence-preview-shell {
    border: 1px solid var(--line);
    border-radius: 12px;
    background: rgba(10, 15, 22, 0.65);
    padding: 0;
    overflow: hidden;
  }
  .confluence-preview-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--line);
    background: rgba(19, 28, 38, 0.8);
  }
  .confluence-preview-body {
    padding: 18px 20px 28px;
    max-height: calc(100vh - 270px);
    overflow: auto;
    line-height: 1.55;
  }
  .confluence-preview-body h1,
  .confluence-preview-body h2,
  .confluence-preview-body h3,
  .confluence-preview-body h4,
  .confluence-preview-body h5,
  .confluence-preview-body h6 {
    margin: 18px 0 10px;
    line-height: 1.25;
  }
  .confluence-preview-body p {
    margin: 0 0 10px;
  }
  .confluence-preview-body ul,
  .confluence-preview-body ol {
    margin: 8px 0 10px 18px;
    padding-left: 12px;
  }
  .confluence-preview-body li {
    margin: 4px 0;
  }
  .confluence-preview-body table {
    width: 100%;
    border-collapse: collapse;
    margin: 12px 0;
    font-size: 13px;
  }
  .confluence-preview-body th,
  .confluence-preview-body td {
    border: 1px solid var(--line);
    padding: 7px 8px;
    vertical-align: top;
  }
  .confluence-preview-body blockquote {
    margin: 10px 0;
    border-left: 3px solid rgba(255, 122, 24, 0.7);
    padding: 6px 12px;
    color: var(--muted);
    background: rgba(255, 122, 24, 0.06);
  }
  .confluence-preview-body code {
    font-family: "JetBrains Mono", monospace;
    font-size: 12px;
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid var(--line);
    border-radius: 4px;
    padding: 1px 4px;
  }
  .confluence-preview-body pre {
    margin: 12px 0;
    padding: 12px;
    overflow: auto;
    border-radius: 8px;
    border: 1px solid var(--line);
    background: rgba(5, 10, 16, 0.88);
  }
  .confluence-preview-body pre code {
    border: 0;
    background: transparent;
    padding: 0;
  }
  .confluence-preview-body a {
    color: #9cd1ff;
    text-decoration: underline;
  }
  @media (max-width: 1100px) {
    .confluence-layout {
      grid-template-columns: 1fr;
    }
    .confluence-pages,
    .confluence-preview-body {
      max-height: none;
    }
  }
</style>

<section class="confluence-layout">
  <div class="card">
    <div class="card-header">
      <div>
        <p class="eyebrow">space</p>
        <h2 class="section-title">{{ confluence_space_name }}</h2>
        {% if confluence_space_key %}
          <p class="muted" style="margin-top: 6px; font-size: 12px;">Key: {{ confluence_space_key }}</p>
        {% endif %}
      </div>
    </div>
    {% if confluence_error %}
      <p class="muted" style="margin-top: 10px; font-size: 12px;">{{ confluence_error }}</p>
    {% elif not confluence_pages %}
      <p class="muted" style="margin-top: 10px; font-size: 12px;">No pages returned for this space.</p>
    {% else %}
      <div class="confluence-pages" style="margin-top: 12px;">
        {% for page in confluence_pages %}
          <a
            class="confluence-page-link{% if page.id == confluence_page_id %} is-active{% endif %}"
            style="--depth: {{ page.depth or 0 }};"
            href="{{ url_for('agents.confluence_workspace', page=page.id) }}"
          >
            <span class="confluence-page-title">{{ page.title }}</span>
          </a>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <div class="card">
    <div class="card-header">
      <div>
        <p class="eyebrow">preview</p>
        <h2 class="section-title">
          {% if confluence_selected_page %}{{ confluence_selected_page.title }}{% else %}Confluence Page{% endif %}
        </h2>
      </div>
      {% if confluence_selected_page and confluence_selected_page.url %}
        <a
          class="btn btn-secondary"
          href="{{ confluence_selected_page.url }}"
          target="_blank"
          rel="noreferrer"
        >
          open in confluence
        </a>
      {% endif %}
    </div>
    {% if confluence_selected_page %}
      <div class="confluence-preview-shell" style="margin-top: 12px;">
        <div class="confluence-preview-header">
          <p class="muted" style="font-size: 12px;">
            Updated {{ confluence_selected_page.updated_at }}{% if confluence_selected_page.updated_by %} by {{ confluence_selected_page.updated_by }}{% endif %}
            {% if confluence_selected_page.version %} Â· v{{ confluence_selected_page.version }}{% endif %}
          </p>
        </div>
        <article class="confluence-preview-body">
          {% if confluence_selected_page.body_html %}
            {{ confluence_selected_page.body_html | safe }}
          {% elif confluence_selected_page.body_text %}
            <p style="white-space: pre-wrap;">{{ confluence_selected_page.body_text }}</p>
          {% else %}
            <p class="muted" style="font-size: 12px;">No preview content available for this page.</p>
          {% endif %}
        </article>
      </div>
    {% elif confluence_error %}
      <p class="muted" style="margin-top: 10px; font-size: 12px;">
        Resolve the Confluence configuration issue to load preview content.
      </p>
    {% else %}
      <p class="muted" style="margin-top: 10px; font-size: 12px;">Select a page to preview.</p>
    {% endif %}
  </div>
</section>
{% endblock %}
