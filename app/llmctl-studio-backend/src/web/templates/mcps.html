{% extends "base.html" %}

{% block action_header %}
  <div class="action-header-actions">
    <a class="btn btn-primary" href="{{ url_for('agents.new_mcp') }}" aria-label="Create custom MCP server">
      <i class="fa-solid fa-plus"></i>
      create custom
    </a>
  </div>
{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Integrated MCP Servers</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    System-managed servers provisioned from Integration settings.
  </p>
  {% if integrated_mcp_servers %}
    <div style="margin-top: 20px; overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Key</th>
            <th>Description</th>
            <th>Bindings</th>
          </tr>
        </thead>
        <tbody>
          {% for mcp in integrated_mcp_servers %}
            <tr
              class="table-row-link"
              data-href="{{ url_for('agents.view_mcp', mcp_id=mcp.id) }}"
            >
              <td>
                <a href="{{ url_for('agents.view_mcp', mcp_id=mcp.id) }}">
                  <p>{{ mcp.name }}</p>
                </a>
              </td>
              <td class="muted">{{ mcp.server_key }}</td>
              <td class="muted">{{ mcp.description or "-" }}</td>
              <td>{{ (mcp.task_templates | length) + (mcp.flowchart_nodes | length) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 16px;">No integrated MCP servers available.</p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">
    <h2 class="section-title">Custom MCP Servers</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    User-managed servers that can be attached to task templates and flowchart nodes.
  </p>
  {% if custom_mcp_servers %}
    <div style="margin-top: 20px; overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Key</th>
            <th>Description</th>
            <th>Bindings</th>
            <th class="table-actions-cell"><i class="fa-solid fa-trash" aria-hidden="true"></i></th>
          </tr>
        </thead>
        <tbody>
          {% for mcp in custom_mcp_servers %}
            <tr
              class="table-row-link"
              data-href="{{ url_for('agents.view_mcp', mcp_id=mcp.id) }}"
            >
              <td>
                <a href="{{ url_for('agents.view_mcp', mcp_id=mcp.id) }}">
                  <p>{{ mcp.name }}</p>
                </a>
              </td>
              <td class="muted">{{ mcp.server_key }}</td>
              <td class="muted">{{ mcp.description or "-" }}</td>
              <td>{{ (mcp.task_templates | length) + (mcp.flowchart_nodes | length) }}</td>
              <td class="table-actions-cell">
                <form
                  method="post"
                  action="{{ url_for('agents.delete_mcp', mcp_id=mcp.id) }}"
                  onsubmit="return confirm('Delete this MCP server?');"
                >
                  <input type="hidden" name="next" value="{{ request.path }}" />
                  <button type="submit" class="btn btn-danger" aria-label="Delete MCP server">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 16px;">No custom MCP servers created yet.</p>
  {% endif %}
</section>

<script>
  const mcpRows = document.querySelectorAll(".table-row-link");
  mcpRows.forEach((row) => {
    row.addEventListener("click", (event) => {
      const target = event.target;
      if (
        target.closest("a") ||
        target.closest("button") ||
        target.closest("input") ||
        target.closest("select") ||
        target.closest("textarea") ||
        target.closest("label") ||
        target.closest("summary") ||
        target.closest("details")
      ) {
        return;
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });
  });
</script>
{% endblock %}
