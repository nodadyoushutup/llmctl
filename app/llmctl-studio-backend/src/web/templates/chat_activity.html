{% extends "base.html" %}

{% block content %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Chat Activity</h2>
    <a class="btn btn-secondary" href="{{ url_for('agents.chat_page') }}">
      <i class="fa-solid fa-comments"></i>
      back to chat
    </a>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Thread lifecycle, turn, retrieval/tool, compaction, and failure audit events.
  </p>

  <form method="get" action="{{ url_for('agents.chat_activity') }}" style="margin-top: 14px;">
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
      <input type="text" name="event_class" placeholder="event class" value="{{ selected_event_class }}" />
      <input type="text" name="event_type" placeholder="event type" value="{{ selected_event_type }}" />
      <input type="text" name="reason_code" placeholder="reason code" value="{{ selected_reason_code }}" />
      <select name="thread_id">
        <option value="">all threads</option>
        {% for thread in threads %}
          <option value="{{ thread.id }}" {% if selected_thread_id == thread.id %}selected{% endif %}>
            {{ thread.title }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div style="display: flex; gap: 8px; margin-top: 10px;">
      <button type="submit" class="btn btn-secondary">
        <i class="fa-solid fa-filter"></i>
        filter
      </button>
      <a class="btn" href="{{ url_for('agents.chat_activity') }}">
        <i class="fa-solid fa-rotate-right"></i>
        reset
      </a>
    </div>
  </form>

  {% if events %}
    <div style="margin-top: 16px; overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Thread</th>
            <th>Class</th>
            <th>Type</th>
            <th>Reason</th>
            <th>When</th>
          </tr>
        </thead>
        <tbody>
          {% for item in events %}
            <tr
              class="table-row-link"
              data-href="{{ url_for('agents.chat_page', thread_id=item.thread_id) }}"
            >
              <td>
                <p>{{ item.thread_title }}</p>
                {% if item.turn_id %}
                  <p class="muted" style="font-size: 12px; margin-top: 4px;">turn {{ item.turn_id }}</p>
                {% endif %}
              </td>
              <td><p>{{ item.event_class }}</p></td>
              <td><p>{{ item.event_type }}</p></td>
              <td>
                {% if item.reason_code %}
                  <code>{{ item.reason_code }}</code>
                {% else %}
                  <span class="muted">-</span>
                {% endif %}
              </td>
              <td>
                <p>{{ human_time(item.created_at) }}</p>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 16px;">No chat activity events yet.</p>
  {% endif %}
</section>

<script>
  const activityRows = document.querySelectorAll(".table-row-link");
  activityRows.forEach((row) => {
    row.addEventListener("click", (event) => {
      const target = event.target;
      if (
        target.closest("a") ||
        target.closest("button") ||
        target.closest("input") ||
        target.closest("select") ||
        target.closest("textarea") ||
        target.closest("label") ||
        target.closest("summary") ||
        target.closest("details")
      ) {
        return;
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });
  });
</script>
{% endblock %}
