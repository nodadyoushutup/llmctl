{% extends "base.html" %}

{% block action_header %}
  <div class="action-header-actions">
    <button class="btn btn-secondary" type="button" id="rag-chat-clear-btn">
      <i class="fa-solid fa-broom"></i>
      clear
    </button>
  </div>
{% endblock %}

{% block content %}
<section class="grid grid-2" style="align-items: start; gap: 16px;">
  <div class="card">
    <div class="card-header">
      <div>
        <h2 class="section-title">Chat</h2>
        <p class="muted" style="margin-top: 6px;">Ask questions against your indexed sources.</p>
      </div>
      <span class="status status-idle" id="rag-chat-status">Ready</span>
    </div>

    {% if missing_api_key %}
      <div class="alert alert-warning" style="margin-top: 12px;">{{ missing_api_key }}</div>
    {% endif %}

    <div
      id="rag-chat-root"
      data-top-k="{{ chat_top_k }}"
      data-verbosity="{{ chat_verbosity }}"
      data-max-history="{{ chat_max_history }}"
      data-context-budget-tokens="{{ chat_context_budget_tokens }}"
      style="margin-top: 14px;"
    >
      <div id="rag-chat-log" style="max-height: 440px; overflow-y: auto; border: 1px solid var(--color-border, #ddd); border-radius: 10px; padding: 12px;"></div>

      <form id="rag-chat-form" style="margin-top: 12px;">
        <label class="label" style="margin-bottom: 10px;">
          Message
          <textarea class="input" id="rag-chat-input" rows="4" placeholder="Ask about your docs..." required></textarea>
        </label>
        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); align-items: end; gap: 10px;">
          <label class="label">
            Verbosity
            <select class="input" id="rag-chat-verbosity">
              <option value="low" {% if chat_verbosity == 'low' %}selected{% endif %}>Low</option>
              <option value="medium" {% if chat_verbosity == 'medium' %}selected{% endif %}>Medium</option>
              <option value="high" {% if chat_verbosity == 'high' %}selected{% endif %}>High</option>
            </select>
          </label>
          <label class="label">
            Top K
            <input class="input" type="number" id="rag-chat-top-k" min="1" max="20" value="{{ chat_top_k }}" />
          </label>
          <label class="label">
            History Limit
            <input class="input" type="number" id="rag-chat-history-limit" min="1" max="50" value="{{ chat_max_history }}" />
          </label>
          <label class="label">
            Context Budget
            <input class="input" type="number" id="rag-chat-context-budget" min="256" value="{{ chat_context_budget_tokens }}" />
          </label>
          <button class="btn btn-primary" type="submit" id="rag-chat-send-btn">
            <i class="fa-solid fa-paper-plane"></i>
            send
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div>
        <h2 class="section-title">Retrieval Collections</h2>
        <p class="muted" style="margin-top: 6px;">Select which collections can be used for retrieval.</p>
      </div>
      <span class="status status-idle">{{ collections|length }} collections</span>
    </div>

    {% if collections %}
      <div id="rag-chat-sources-panel" style="margin-top: 14px; max-height: 440px; overflow-y: auto;">
        {% for collection in collections %}
          <label class="label" style="display: flex; align-items: start; gap: 10px; padding: 10px 8px; border-bottom: 1px solid var(--color-border, #ddd);">
            <input type="checkbox" class="rag-chat-collection-checkbox" value="{{ collection.id }}" checked />
            <span>
              <span style="display: block; font-weight: 600;">{{ collection.name }}</span>
              <span class="muted" style="font-size: 12px;">status {{ collection.status or "ready" }}</span>
            </span>
          </label>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted" style="margin-top: 16px;">No collections available. Create and index sources first.</p>
    {% endif %}
  </div>
</section>

<script src="{{ url_for('static', filename='rag/app.js') }}"></script>
{% endblock %}
