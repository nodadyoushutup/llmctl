{% extends "base.html" %}

{% block action_header %}
  <div class="action-header-actions">
    <a class="btn btn-primary" href="{{ url_for('rag.new_source_page') }}">
      <i class="fa-solid fa-plus"></i>
      create source
    </a>
  </div>
{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header">
    <div>
      <h2 class="section-title">Sources</h2>
      <p class="muted" style="margin-top: 6px;">
        Click a source row for detail view.
      </p>
    </div>
  </div>
  {% if rag_health and rag_health.state == "configured_unhealthy" %}
    <div class="alert alert-warning" style="margin-top: 12px;">
      RAG integration is configured but unhealthy. Workflow RAG node execution is disabled until connectivity is restored.
    </div>
  {% endif %}

  {% if sources %}
    <div style="margin-top: 20px; overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Kind</th>
            <th>Location</th>
            <th>Schedule</th>
            <th>Last Indexed</th>
            <th>Status</th>
            <th class="table-actions-cell">Index</th>
            <th class="table-actions-cell">Delta</th>
            <th class="table-actions-cell">Edit</th>
            <th class="table-actions-cell">Delete</th>
          </tr>
        </thead>
        <tbody>
          {% for source in sources %}
            {% set source_status = "Not indexed" %}
            {% set source_is_active = source.id in active_source_job_ids %}
            {% if source_is_active %}
              {% set source_status = "Indexing" %}
            {% elif source.last_error %}
              {% set source_status = "Error" %}
            {% elif source.last_indexed_at %}
              {% set source_status = "Indexed" %}
            {% endif %}
            <tr
              class="table-row-link"
              data-href="{{ url_for('rag.source_detail_page', source_id=source.id) }}"
            >
              <td>
                <a href="{{ url_for('rag.source_detail_page', source_id=source.id) }}">
                  {{ source.name }}
                </a>
              </td>
              <td><span class="chip">{{ source.kind }}</span></td>
              <td class="mono truncate">{{ source_location(source) }}</td>
              <td>{{ source_schedule_text(source) }}</td>
              <td class="muted" data-rag-source-last-indexed data-source-id="{{ source.id }}">
                {{ format_source_time(source.last_indexed_at) }}
              </td>
              <td data-rag-source-status data-source-id="{{ source.id }}">{{ source_status }}</td>
              <td class="table-actions-cell">
                <button
                  type="button"
                  class="icon-button"
                  data-rag-quick-run
                  data-rag-quick-run-mode="fresh"
                  data-rag-source-id="{{ source.id }}"
                  data-rag-source-name="{{ source.name }}"
                  aria-label="Run source index"
                  title="Run source index"
                  {% if source_is_active %}disabled{% endif %}
                >
                  <i class="fa-solid fa-database"></i>
                </button>
              </td>
              <td class="table-actions-cell">
                <button
                  type="button"
                  class="icon-button"
                  data-rag-quick-run
                  data-rag-quick-run-mode="delta"
                  data-rag-source-id="{{ source.id }}"
                  data-rag-source-name="{{ source.name }}"
                  aria-label="Run source delta index"
                  title="Run source delta index"
                  {% if source_is_active %}disabled{% endif %}
                >
                  <i class="fa-solid fa-arrows-rotate"></i>
                </button>
              </td>
              <td class="table-actions-cell">
                <a
                  class="icon-button"
                  href="{{ url_for('rag.edit_source_page', source_id=source.id) }}"
                  aria-label="Edit source"
                  title="Edit source"
                >
                  <i class="fa-solid fa-pen"></i>
                </a>
              </td>
              <td class="table-actions-cell">
                <form
                  method="post"
                  action="{{ url_for('rag.delete_source_page', source_id=source.id) }}"
                  onsubmit="return confirm('Delete this source?');"
                >
                  <button
                    type="submit"
                    class="icon-button icon-button-danger"
                    aria-label="Delete source"
                    title="Delete source"
                  >
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 16px;">No sources configured yet.</p>
  {% endif %}
</section>

<script src="{{ url_for('static', filename='rag/app.js') }}"></script>
{% endblock %}
