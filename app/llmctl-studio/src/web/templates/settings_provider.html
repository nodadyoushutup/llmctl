{% extends "settings_layout.html" %}

{% block settings_content %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Provider</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Select which CLI powers agent autorun prompts.
  </p>
  <form
    method="post"
    action="{{ url_for('agents.update_provider_settings') }}"
    class="form-grid"
    style="margin-top: 20px;"
  >
    <label class="label" style="grid-column: 1 / -1;">
      Active provider
      <select class="input" name="provider">
        {% for option in provider_options %}
          <option
            value="{{ option.value }}"
            {% if option.value == provider_summary.provider %}selected{% endif %}
          >
            {{ option.label }}
          </option>
        {% endfor %}
      </select>
    </label>
    <div class="form-actions">
      <button class="btn btn-primary" type="submit">
        <i class="fa-solid fa-floppy-disk"></i>
        save provider
      </button>
    </div>
  </form>
  <div class="stack" style="margin-top: 24px;">
    {% for provider in provider_details %}
      <div class="subcard">
        <div class="row-between">
          <div>
            <p class="eyebrow">{{ provider.label }}</p>
            <p class="muted" style="margin-top: 6px; font-size: 12px;">
              Command {{ provider.command }} with model {{ provider.model }}.
            </p>
          </div>
          <span class="status {% if provider.active %}status-success{% else %}status-idle{% endif %}">
            {% if provider.active %}active{% else %}available{% endif %}
          </span>
        </div>
      </div>
    {% endfor %}
  </div>
</section>
<section class="card" style="margin-top: 24px;" data-codex-settings>
  <div class="card-header">
    <h2 class="section-title">Codex Settings</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Auth and runtime configuration for Codex CLI autoruns.
  </p>
  <form
    method="post"
    action="{{ url_for('agents.update_codex_settings') }}"
    class="form-grid"
    style="margin-top: 20px;"
  >
    <label class="label" style="grid-column: 1 / -1;">
      Codex API key
      <input
        class="input"
        type="password"
        name="codex_api_key"
        value="{{ codex_settings.api_key }}"
        placeholder="sk-..."
      />
    </label>
    <label class="label" style="grid-column: 1 / -1;">
      Model
      <input
        class="input"
        type="text"
        name="codex_model"
        value="{{ codex_settings.model }}"
        placeholder="gpt-5.2-codex"
      />
    </label>
    <label class="label">
      Approval policy
      <select class="input" name="codex_approval_policy">
        {% set approval_selected = codex_settings.approval_policy %}
        {% for option in ["never", "on-failure", "on-request", "untrusted"] %}
          <option value="{{ option }}" {% if option == approval_selected %}selected{% endif %}>
            {{ option }}
          </option>
        {% endfor %}
      </select>
    </label>
    <label class="label">
      Sandbox mode
      <select class="input" name="codex_sandbox_mode">
        {% set sandbox_selected = codex_settings.sandbox_mode %}
        {% for option in ["danger-full-access", "workspace-write", "read-only"] %}
          <option value="{{ option }}" {% if option == sandbox_selected %}selected{% endif %}>
            {{ option }}
          </option>
        {% endfor %}
      </select>
    </label>
    <label class="label">
      Network access
      <select class="input" name="codex_network_access">
        {% set network_selected = codex_settings.network_access %}
        {% for option in ["enabled", "disabled"] %}
          <option value="{{ option }}" {% if option == network_selected %}selected{% endif %}>
            {{ option }}
          </option>
        {% endfor %}
      </select>
    </label>
    <label class="label">
      Reasoning effort
      <select class="input" name="codex_model_reasoning_effort">
        {% set effort_selected = codex_settings.model_reasoning_effort %}
        {% for option in ["high", "medium", "low", "none"] %}
          <option value="{{ option }}" {% if option == effort_selected %}selected{% endif %}>
            {{ option }}
          </option>
        {% endfor %}
      </select>
    </label>
    <label class="label">
      Shell env inherit
      <select class="input" name="codex_shell_env_inherit">
        {% set inherit_selected = codex_settings.shell_env_inherit %}
        {% for option in ["all", "safe", "none"] %}
          <option value="{{ option }}" {% if option == inherit_selected %}selected{% endif %}>
            {{ option }}
          </option>
        {% endfor %}
      </select>
    </label>
    <label class="label" style="grid-column: 1 / -1;">
      <input
        type="checkbox"
        name="codex_shell_env_ignore_default_excludes"
        value="true"
        {% if codex_settings.shell_env_ignore_default_excludes %}checked{% endif %}
      />
      ignore default excludes
    </label>
    <div style="grid-column: 1 / -1; margin-top: 8px;">
      <p class="eyebrow">Notice overrides</p>
      <p class="muted" style="margin-top: 6px; font-size: 12px;">
        Optional suppression and migration prompts for specific models.
      </p>
    </div>
    <label class="label" style="grid-column: 1 / -1;">
      Hide migration prompt key
      <input
        class="input"
        type="text"
        name="codex_notice_hide_key"
        value="{{ codex_settings.notice_hide_key }}"
        placeholder="hide_gpt-5.1-codex-max_migration_prompt"
      />
    </label>
    <label class="label" style="grid-column: 1 / -1;">
      <input
        type="checkbox"
        name="codex_notice_hide_enabled"
        value="true"
        {% if codex_settings.notice_hide_enabled %}checked{% endif %}
      />
      enable hide migration prompt
    </label>
    <label class="label">
      Migration from
      <input
        class="input"
        type="text"
        name="codex_notice_migration_from"
        value="{{ codex_settings.notice_migration_from }}"
        placeholder="gpt-5.1-codex-max"
      />
    </label>
    <label class="label">
      Migration to
      <input
        class="input"
        type="text"
        name="codex_notice_migration_to"
        value="{{ codex_settings.notice_migration_to }}"
        placeholder="gpt-5.2-codex"
      />
    </label>
    <div class="form-actions">
      <button class="btn btn-primary" type="submit">
        <i class="fa-solid fa-floppy-disk"></i>
        save codex settings
      </button>
    </div>
  </form>
</section>
<script>
  const providerSelect = document.querySelector('select[name="provider"]');
  const codexSection = document.querySelector("[data-codex-settings]");
  if (providerSelect && codexSection) {
    const toggleCodexSettings = () => {
      codexSection.style.display = providerSelect.value === "codex" ? "block" : "none";
    };
    providerSelect.addEventListener("change", toggleCodexSettings);
    toggleCodexSettings();
  }
</script>
{% endblock %}
