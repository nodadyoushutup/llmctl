{% extends "settings_layout.html" %}

{% block settings_content %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Providers</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Enable providers and choose an optional default for agents without a model.
  </p>
  <form
    method="post"
    action="{{ url_for('agents.update_provider_settings') }}"
    class="form-grid"
    style="margin-top: 20px;"
  >
    <div class="stack" style="grid-column: 1 / -1;">
      {% for provider in provider_details %}
        <div class="subcard" data-provider="{{ provider.id }}">
          <div class="row-between">
            <div>
              <p class="eyebrow">{{ provider.label }}</p>
              <p class="muted" style="margin-top: 6px; font-size: 12px;">
                Command {{ provider.command }}. Default model {{ provider.model }}.
              </p>
            </div>
            <div class="row" style="gap: 20px;">
              <div class="row" style="gap: 8px;">
                <span class="muted" style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.2em;">
                  enabled
                </span>
                <label class="switch">
                  <input
                    type="checkbox"
                    name="provider_enabled_{{ provider.id }}"
                    value="true"
                    class="provider-enabled-toggle"
                    data-provider="{{ provider.id }}"
                    {% if provider.enabled %}checked{% endif %}
                  />
                  <span class="switch-slider"></span>
                </label>
              </div>
              <div class="row" style="gap: 8px;">
                <span class="muted" style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.2em;">
                  default
                </span>
                <label class="switch">
                  <input
                    type="checkbox"
                    name="default_provider"
                    value="{{ provider.id }}"
                    class="default-provider-toggle"
                    data-provider="{{ provider.id }}"
                    {% if provider.is_default %}checked{% endif %}
                  />
                  <span class="switch-slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" type="submit">
        <i class="fa-solid fa-floppy-disk"></i>
        save providers
      </button>
    </div>
  </form>
  <p class="muted" style="margin-top: 16px; font-size: 12px;">
    Default model selection overrides provider defaults when assigned to an agent.
  </p>
</section>
<section class="card" style="margin-top: 24px;">
  <div class="card-header">
    <h2 class="section-title">Codex Auth</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Configure API credentials for Codex.
  </p>
  <form
    method="post"
    action="{{ url_for('agents.update_codex_settings') }}"
    class="form-grid"
    style="margin-top: 20px;"
  >
    <label class="label" style="grid-column: 1 / -1;">
      Codex API key
      <input
        class="input"
        type="password"
        name="codex_api_key"
        value="{{ codex_settings.api_key }}"
        placeholder="sk-..."
      />
    </label>
    <div class="form-actions">
      <button class="btn btn-primary" type="submit">
        <i class="fa-solid fa-floppy-disk"></i>
        save codex auth
      </button>
    </div>
  </form>
</section>
<section class="card" style="margin-top: 24px;">
  <div class="card-header">
    <h2 class="section-title">Gemini Auth</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Configure API credentials for Gemini.
  </p>
  <form
    method="post"
    action="{{ url_for('agents.update_gemini_settings') }}"
    class="form-grid"
    style="margin-top: 20px;"
  >
    <label class="label" style="grid-column: 1 / -1;">
      Gemini API key
      <input
        class="input"
        type="password"
        name="gemini_api_key"
        value="{{ gemini_settings.api_key }}"
        placeholder="AIza..."
      />
    </label>
    <div class="form-actions">
      <button class="btn btn-primary" type="submit">
        <i class="fa-solid fa-floppy-disk"></i>
        save gemini auth
      </button>
    </div>
  </form>
</section>
<section class="card" style="margin-top: 24px;">
  <div class="card-header">
    <h2 class="section-title">Claude Auth</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Configure API credentials for Claude (Anthropic).
  </p>
  <form
    method="post"
    action="{{ url_for('agents.update_claude_settings') }}"
    class="form-grid"
    style="margin-top: 20px;"
  >
    <label class="label" style="grid-column: 1 / -1;">
      Anthropic API key
      <input
        class="input"
        type="password"
        name="claude_api_key"
        value="{{ claude_settings.api_key }}"
        placeholder="sk-ant-..."
      />
    </label>
    <div class="form-actions">
      <button class="btn btn-primary" type="submit">
        <i class="fa-solid fa-floppy-disk"></i>
        save claude auth
      </button>
    </div>
  </form>
</section>
<section class="card" style="margin-top: 24px;">
  <div class="card-header">
    <h2 class="section-title">vLLM Local Provider</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Configure in-container vLLM CLI usage and discovered local default model.
  </p>
  <form
    method="post"
    action="{{ url_for('agents.update_vllm_local_settings') }}"
    class="form-grid"
    style="margin-top: 20px;"
  >
    <label class="label" style="grid-column: 1 / -1;">
      Local CLI command
      <p class="muted" style="margin-top: 8px; font-size: 12px;">
        {{ vllm_local_settings.command }} run-batch
      </p>
    </label>
    <label class="label" style="grid-column: 1 / -1;">
      Local default model
      <select class="input" name="vllm_local_model">
        {% for option in vllm_local_settings.models %}
          <option value="{{ option.value }}" {% if option.value == vllm_local_settings.model %}selected{% endif %}>
            {{ option.label }} ({{ option.source }})
          </option>
        {% endfor %}
      </select>
      <p class="muted" style="margin-top: 6px; font-size: 12px;">
        custom dir: {{ vllm_local_settings.custom_dir }}
      </p>
    </label>
    <div class="form-actions">
      <button class="btn btn-primary" type="submit">
        <i class="fa-solid fa-floppy-disk"></i>
        save vllm local settings
      </button>
    </div>
  </form>
</section>
<section class="card" style="margin-top: 24px;">
  <div class="card-header">
    <h2 class="section-title">vLLM Remote Provider</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Configure remote vLLM endpoint/auth and default remote model options.
  </p>
  <form
    method="post"
    action="{{ url_for('agents.update_vllm_remote_settings') }}"
    class="form-grid"
    style="margin-top: 20px;"
  >
    <label class="label">
      Remote base URL
      <input
        class="input"
        type="text"
        name="vllm_remote_base_url"
        value="{{ vllm_remote_settings.base_url }}"
        placeholder="https://vllm.example.com/v1"
      />
    </label>
    <label class="label">
      Remote API key (optional)
      <input
        class="input"
        type="password"
        name="vllm_remote_api_key"
        value="{{ vllm_remote_settings.api_key }}"
        placeholder="optional"
      />
    </label>
    <label class="label" style="grid-column: 1 / -1;">
      Remote default model
      <input
        class="input"
        type="text"
        name="vllm_remote_model"
        value="{{ vllm_remote_settings.model }}"
        list="vllm-remote-default-model-options"
        placeholder="GLM-4.7-Flash"
      />
      <datalist id="vllm-remote-default-model-options">
        {% for option in vllm_remote_settings.models %}
          <option value="{{ option }}"></option>
        {% endfor %}
      </datalist>
    </label>
    <label class="label" style="grid-column: 1 / -1;">
      Remote model options (comma or newline separated)
      <textarea
        class="textarea"
        name="vllm_remote_models"
        placeholder="GLM-4.7-Flash"
      >{{ vllm_remote_settings.models | join('\n') }}</textarea>
    </label>
    <div class="form-actions">
      <button class="btn btn-primary" type="submit">
        <i class="fa-solid fa-floppy-disk"></i>
        save vllm remote settings
      </button>
    </div>
  </form>
</section>

<script>
  const defaultProviderToggles = document.querySelectorAll(".default-provider-toggle");
  const enabledProviderToggles = document.querySelectorAll(".provider-enabled-toggle");

  defaultProviderToggles.forEach((toggle) => {
    toggle.addEventListener("change", () => {
      if (!toggle.checked) {
        return;
      }
      defaultProviderToggles.forEach((other) => {
        if (other !== toggle) {
          other.checked = false;
        }
      });
      const provider = toggle.dataset.provider;
      const enabledToggle = document.querySelector(
        `.provider-enabled-toggle[data-provider="${provider}"]`
      );
      if (enabledToggle) {
        enabledToggle.checked = true;
      }
    });
  });

  enabledProviderToggles.forEach((toggle) => {
    toggle.addEventListener("change", () => {
      if (toggle.checked) {
        return;
      }
      const provider = toggle.dataset.provider;
      const defaultToggle = document.querySelector(
        `.default-provider-toggle[data-provider="${provider}"]`
      );
      if (defaultToggle) {
        defaultToggle.checked = false;
      }
    });
  });
</script>
{% endblock %}
