{% extends "base.html" %}

{% block content %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Create Node</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Queue a single run and trigger the celery worker.
  </p>
  <form method="post" action="{{ url_for('agents.create_node') }}" class="form-grid" enctype="multipart/form-data">
    <label class="label">
      agent
      <select name="agent_id" class="input">
        <option value="">Select agent</option>
        {% for agent in agents %}
          <option value="{{ agent.id }}">{{ agent.name }}</option>
        {% endfor %}
      </select>
      {% if not agents %}
        <span class="muted" style="font-size: 12px; margin-top: 6px;">
          Create an agent first to queue a node.
        </span>
      {% endif %}
    </label>
    <div class="label" style="grid-column: 1 / -1;">
      scripts (optional)
      {% include "partials/script_picker.html" %}
    </div>
    <label class="label" style="grid-column: 1 / -1;">
      integrations (optional)
      {% if integration_options %}
        <div class="flow-checkbox-list" style="margin-top: 8px;">
          {% for option in integration_options %}
            <label style="display: flex; align-items: center; gap: 8px;">
              <input
                type="checkbox"
                name="integration_keys"
                value="{{ option.key }}"
                {% if option.key in selected_integration_keys %}checked{% endif %}
              />
              <span>
                {{ option.label }}
                <span class="muted">({% if option.connected %}configured{% else %}not configured{% endif %})</span>
              </span>
            </label>
          {% endfor %}
        </div>
        <span class="muted" style="font-size: 12px; margin-top: 6px;">
          Selected integrations are injected into prompt context. GitHub also enables repo checkout in the integration stage.
        </span>
      {% else %}
        <span class="muted" style="font-size: 12px; margin-top: 6px;">
          No integrations available.
        </span>
      {% endif %}
    </label>
    <label class="label" style="grid-column: 1 / -1;">
      prompt
      <textarea
        name="prompt"
        placeholder="Write the node prompt."
        class="textarea"
        data-attachment-paste
        data-attachment-input-id="task-attachments"
      ></textarea>
    </label>
    <label class="label" style="grid-column: 1 / -1;">
      attachments (optional)
      <input
        type="file"
        name="attachments"
        id="task-attachments"
        class="input"
        multiple
        data-attachment-input
      />
      <span class="muted" style="font-size: 12px; margin-top: 6px;">
        Paste images into the prompt or choose files. Saved to <code>data/attachments</code>.
      </span>
      <div class="muted" style="font-size: 12px; margin-top: 6px;" data-attachment-list="task-attachments"></div>
    </label>
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">
        <i class="fa-solid fa-paper-plane"></i>
        queue node
      </button>
      <a class="btn btn-secondary" href="{{ url_for('agents.list_nodes') }}">
        <i class="fa-solid fa-arrow-left"></i>
        back to nodes
      </a>
    </div>
  </form>
</section>
{% endblock %}
