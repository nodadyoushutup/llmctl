{% extends "base.html" %}

{% block topbar_actions %}
  <a class="btn btn-secondary" href="{{ url_for('agents.pipeline_history') }}">
    <i class="fa-solid fa-arrow-left"></i>
    back to history
  </a>
  {% if pipeline %}
    <a class="btn btn-secondary" href="{{ url_for('agents.view_pipeline', pipeline_id=pipeline.id) }}">
      <i class="fa-solid fa-diagram-project"></i>
      pipeline
    </a>
  {% endif %}
{% endblock %}

{% block action_header %}
  {% if pipeline or pipeline_run.status in ["queued", "running"] %}
    <div class="action-header-actions">
      {% if pipeline %}
        <form method="post" action="{{ url_for('agents.toggle_pipeline_loop', pipeline_id=pipeline.id) }}">
          <input type="hidden" name="next" value="{{ request.path }}" />
          <input
            type="hidden"
            name="loop_enabled"
            value="{% if pipeline.loop_enabled %}0{% else %}1{% endif %}"
          />
          <button
            type="submit"
            class="btn {% if pipeline.loop_enabled %}btn-primary{% else %}btn-secondary{% endif %}"
          >
            <i class="fa-solid fa-arrows-rotate"></i>
            loop {% if pipeline.loop_enabled %}on{% else %}off{% endif %}
          </button>
        </form>
      {% endif %}
      {% if pipeline_run.status in ["queued", "running"] %}
        <form method="post" action="{{ url_for('agents.cancel_pipeline_run', run_id=pipeline_run.id) }}">
          <input type="hidden" name="next" value="{{ request.path }}" />
          <button type="submit" class="btn btn-danger">
            <i class="fa-solid fa-ban"></i>
            cancel run
          </button>
        </form>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header">
    <div>
      <p class="eyebrow">pipeline run {{ pipeline_run.id }}</p>
      <h2 class="section-title">
        {% if pipeline %}
          {{ pipeline.name }}
        {% else %}
          Pipeline {{ pipeline_run.pipeline_id }}
        {% endif %}
      </h2>
    </div>
    <div class="row">
      {% if pipeline_run.status == "running" %}
        <span id="pipeline-run-status" class="status status-running">running</span>
      {% elif pipeline_run.status == "queued" %}
        <span id="pipeline-run-status" class="status status-queued">queued</span>
      {% elif pipeline_run.status == "succeeded" %}
        <span id="pipeline-run-status" class="status status-success">succeeded</span>
      {% elif pipeline_run.status == "failed" %}
        <span id="pipeline-run-status" class="status status-failed">failed</span>
      {% elif pipeline_run.status == "canceled" %}
        <span id="pipeline-run-status" class="status status-canceled">canceled</span>
      {% else %}
        <span id="pipeline-run-status" class="status status-idle">{{ pipeline_run.status }}</span>
      {% endif %}
    </div>
  </div>
  <div class="meta-bar">
    <div class="meta-item">
      <span class="meta-label">Pipeline</span>
      <span class="meta-value">
        {% if pipeline %}
          <a href="{{ url_for('agents.view_pipeline', pipeline_id=pipeline.id) }}">{{ pipeline.name }}</a>
        {% elif pipeline_run.pipeline_id %}
          Pipeline {{ pipeline_run.pipeline_id }}
        {% else %}
          -
        {% endif %}
      </span>
    </div>
    <div class="meta-item">
      <span class="meta-label">Run task</span>
      <span class="meta-value" id="pipeline-run-task-id">
        {{ pipeline_run.celery_task_id or "-" }}
      </span>
    </div>
    <div class="meta-item">
      <span class="meta-label">Created</span>
      <span class="meta-value" id="pipeline-run-created-at">
        {{ human_time(pipeline_run.created_at) }}
      </span>
    </div>
    <div class="meta-item">
      <span class="meta-label">Started</span>
      <span class="meta-value" id="pipeline-run-started-at">
        {{ human_time(pipeline_run.started_at) }}
      </span>
    </div>
    <div class="meta-item">
      <span class="meta-label">Finished</span>
      <span class="meta-value" id="pipeline-run-finished-at">
        {{ human_time(pipeline_run.finished_at) }}
      </span>
    </div>
    {% if pipeline %}
      <div class="meta-item">
        <span class="meta-label">Loop</span>
        <span class="meta-value">
          {% if pipeline.loop_enabled %}Enabled{% else %}Disabled{% endif %}
        </span>
      </div>
    {% endif %}
  </div>
  {% if pipeline_run.status in ["queued", "running"] %}
    <p class="muted" id="pipeline-run-auto-refresh" style="margin-top: 12px;">
      Auto-updating every 5 seconds while the run is active.
    </p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">
    <h2 class="section-title">Tasks</h2>
  </div>
  <div id="pipeline-run-tasks">
    {% include "partials/pipeline_run_tasks.html" %}
  </div>
</section>

{% if pipeline_run.status in ["queued", "running"] %}
  <script>
    (() => {
      const statusUrl = {{ url_for('agents.pipeline_run_status', run_id=pipeline_run.id) | tojson }};
      const statusEl = document.getElementById("pipeline-run-status");
      const runTaskEl = document.getElementById("pipeline-run-task-id");
      const createdAtEl = document.getElementById("pipeline-run-created-at");
      const startedAtEl = document.getElementById("pipeline-run-started-at");
      const finishedAtEl = document.getElementById("pipeline-run-finished-at");
      const tasksContainer = document.getElementById("pipeline-run-tasks");
      const autoRefreshEl = document.getElementById("pipeline-run-auto-refresh");
      const statusClasses = {
        running: "status-running",
        queued: "status-queued",
        succeeded: "status-success",
        failed: "status-failed",
        canceled: "status-canceled",
      };

      const updateText = (el, value) => {
        if (!el) {
          return;
        }
        el.textContent = value || "-";
      };

      const updateStatus = (status) => {
        if (!statusEl) {
          return;
        }
        statusEl.textContent = status || "-";
        const className = statusClasses[status] || "status-idle";
        statusEl.className = `status ${className}`;
      };

      let pollTimer = null;
      let polling = true;

      const schedulePoll = () => {
        if (!polling) {
          return;
        }
        pollTimer = window.setTimeout(poll, 1000);
      };

      const stopPolling = () => {
        polling = false;
        if (pollTimer) {
          window.clearTimeout(pollTimer);
          pollTimer = null;
        }
        if (autoRefreshEl) {
          autoRefreshEl.style.display = "none";
        }
      };

      const poll = async () => {
        if (!polling) {
          return;
        }
        try {
          const response = await window.fetch(statusUrl, {
            cache: "no-store",
            headers: {
              Accept: "application/json",
            },
          });
          if (!response.ok) {
            schedulePoll();
            return;
          }
          const data = await response.json();
          updateStatus(data.status);
          updateText(runTaskEl, data.celery_task_id);
          updateText(createdAtEl, data.created_at);
          updateText(startedAtEl, data.started_at);
          updateText(finishedAtEl, data.finished_at);
          if (tasksContainer && typeof data.tasks_html === "string") {
            tasksContainer.innerHTML = data.tasks_html;
          }
          if (!["queued", "running"].includes(data.status)) {
            stopPolling();
            return;
          }
        } catch (error) {
          schedulePoll();
          return;
        }
        schedulePoll();
      };

      poll();
    })();
  </script>
{% endif %}

<script>
  const isInteractiveTarget = (target) =>
    target.closest(
      "a, button, input, select, textarea, label, summary, details"
    );
  document.addEventListener("click", (event) => {
    const row = event.target.closest(".table-row-link");
    if (!row) {
      return;
    }
    if (isInteractiveTarget(event.target)) {
      return;
    }
    const href = row.dataset.href;
    if (href) {
      window.location.href = href;
    }
  });
</script>
{% endblock %}
