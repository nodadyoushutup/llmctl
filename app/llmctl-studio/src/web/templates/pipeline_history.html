{% extends "base.html" %}

{% block content %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Pipeline History</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Recent pipeline executions.
  </p>
  {% if pipeline_runs %}
    <div style="margin-top: 20px; overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Pipeline</th>
            <th>Status</th>
            <th>Started</th>
            <th>Finished</th>
            <th>Task</th>
          </tr>
        </thead>
        <tbody>
          {% for run in pipeline_runs %}
            <tr
              class="table-row-link"
              data-href="{{ url_for('agents.view_pipeline_run', run_id=run.id) }}"
            >
              <td>
                <a href="{{ url_for('agents.view_pipeline_run', run_id=run.id) }}">
                  {{ pipelines_by_id.get(run.pipeline_id, "Pipeline " ~ run.pipeline_id) }}
                </a>
              </td>
              <td>
                {% if run.status == "running" %}
                  <span class="status status-running">running</span>
                {% elif run.status == "succeeded" %}
                  <span class="status status-success">succeeded</span>
                {% elif run.status == "failed" %}
                  <span class="status status-failed">failed</span>
                {% elif run.status == "canceled" %}
                  <span class="status status-canceled">canceled</span>
                {% else %}
                  <span class="status status-idle">{{ run.status }}</span>
                {% endif %}
              </td>
              <td class="muted">{{ human_time(run.started_at) }}</td>
              <td class="muted">{{ human_time(run.finished_at) }}</td>
              <td class="muted" style="font-size: 12px;">{{ run.celery_task_id or "-" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 16px;">No pipeline runs yet.</p>
  {% endif %}
</section>

<script>
  const pipelineRunRows = document.querySelectorAll(".table-row-link");
  const isInteractiveTarget = (target) =>
    target.closest(
      "a, button, input, select, textarea, label, summary, details"
    );
  pipelineRunRows.forEach((row) => {
    row.addEventListener("click", (event) => {
      if (isInteractiveTarget(event.target)) {
        return;
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });
  });
</script>
{% endblock %}
