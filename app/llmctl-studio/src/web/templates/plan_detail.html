{% extends "base.html" %}

{% block topbar_actions %}
  <a class="btn btn-secondary" href="{{ url_for('agents.list_plans') }}">
    <i class="fa-solid fa-arrow-left"></i>
    back to plans
  </a>
{% endblock %}

{% block action_header %}
  <div class="action-header-actions">
    <a
      class="icon-button"
      href="{{ url_for('agents.edit_plan', plan_id=plan.id) }}"
      aria-label="Edit plan"
      title="Edit plan"
    >
      <i class="fa-solid fa-pen-to-square"></i>
    </a>
    <form
      method="post"
      action="{{ url_for('agents.delete_plan', plan_id=plan.id) }}"
      onsubmit="return confirm('Delete this plan?');"
    >
      <input type="hidden" name="next" value="{{ url_for('agents.list_plans') }}" />
      <button
        type="submit"
        class="icon-button icon-button-danger"
        aria-label="Delete plan"
        title="Delete plan"
      >
        <i class="fa-solid fa-trash"></i>
      </button>
    </form>
  </div>
{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header">
    <div>
      <p class="eyebrow">plan {{ plan.id }}</p>
      <h2 class="section-title">{{ plan.name }}</h2>
    </div>
  </div>
  <dl class="meta-list meta-list-compact">
    <div class="meta-span">
      <dt>Description</dt>
      <dd>{{ plan.description or "-" }}</dd>
    </div>
    <div>
      <dt>Completed</dt>
      <dd>{{ human_time(plan.completed_at) }}</dd>
    </div>
    <div>
      <dt>Stages</dt>
      <dd>{{ stage_count }}</dd>
    </div>
    <div>
      <dt>Tasks</dt>
      <dd>{{ task_count }}</dd>
    </div>
    <div>
      <dt>Created</dt>
      <dd>{{ human_time(plan.created_at) }}</dd>
    </div>
    <div>
      <dt>Updated</dt>
      <dd>{{ human_time(plan.updated_at) }}</dd>
    </div>
  </dl>
</section>

<section class="card">
  <div class="card-header">
    <h2 class="section-title">Plan Outline</h2>
    <button
      type="button"
      class="btn btn-secondary"
      data-toggle-panel="add-stage-panel"
    >
      <i class="fa-solid fa-plus"></i>
      add stage
    </button>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Expand each stage to browse subtasks, notes, and update progress.
  </p>
  {% if plan.stages %}
    <div class="stack" style="margin-top: 20px;">
      {% for stage in plan.stages %}
        <details class="subcard plan-stage {% if stage.completed_at %}is-complete{% endif %}" {% if loop.first %}open{% endif %}>
          <summary class="plan-stage-summary">
            <div>
              <p class="eyebrow">stage {{ loop.index }}</p>
              <p class="plan-node-title">{{ stage.name }}</p>
            </div>
            <div class="row" style="gap: 10px; align-items: center;">
              <span class="chip">{{ stage.tasks|length }} task{{ "" if stage.tasks|length == 1 else "s" }}</span>
              <span class="plan-completed-meta{% if stage.completed_at %} is-complete{% endif %}">
                completed: {{ human_time(stage.completed_at) }}
              </span>
              <div class="plan-stage-actions">
                <button
                  type="button"
                  class="icon-button"
                  data-toggle-panel="stage-add-task-{{ stage.id }}"
                  data-summary-action
                  aria-label="Add task"
                  title="Add task"
                >
                  <i class="fa-solid fa-plus"></i>
                </button>
                <button
                  type="button"
                  class="icon-button"
                  data-toggle-panel="stage-edit-{{ stage.id }}"
                  data-summary-action
                  aria-label="Edit stage"
                  title="Edit stage"
                >
                  <i class="fa-solid fa-pen-to-square"></i>
                </button>
                <form
                  method="post"
                  action="{{ url_for('agents.delete_plan_stage', plan_id=plan.id, stage_id=stage.id) }}"
                  onsubmit="return confirm('Delete this stage and its tasks?');"
                  data-summary-action
                >
                  <input type="hidden" name="next" value="{{ request.path }}" />
                  <button
                    type="submit"
                    class="icon-button icon-button-danger"
                    aria-label="Delete stage"
                    title="Delete stage"
                  >
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </form>
              </div>
            </div>
          </summary>

          {% if stage.description %}
            <p class="muted" style="margin-top: 12px; white-space: pre-wrap;">
              {{ stage.description }}
            </p>
          {% endif %}

          <div class="plan-tree">
            {% if stage.tasks %}
              {% for task in stage.tasks %}
                <details class="plan-task {% if task.completed_at %}is-complete{% endif %}">
                  <summary class="plan-task-summary">
                    <span class="plan-node-title">{{ task.name }}</span>
                    <div class="row" style="gap: 10px; align-items: center;">
                      <span class="plan-completed-meta{% if task.completed_at %} is-complete{% endif %}">
                        completed: {{ human_time(task.completed_at) }}
                      </span>
                      <div class="plan-task-actions">
                        <button
                          type="button"
                          class="icon-button"
                          data-toggle-panel="task-edit-{{ task.id }}"
                          data-summary-action
                          aria-label="Edit task"
                          title="Edit task"
                        >
                          <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <form
                          method="post"
                          action="{{ url_for('agents.delete_plan_task', plan_id=plan.id, stage_id=stage.id, task_id=task.id) }}"
                          onsubmit="return confirm('Delete this task?');"
                          data-summary-action
                        >
                          <input type="hidden" name="next" value="{{ request.path }}" />
                          <button
                            type="submit"
                            class="icon-button icon-button-danger"
                            aria-label="Delete task"
                            title="Delete task"
                          >
                            <i class="fa-solid fa-trash"></i>
                          </button>
                        </form>
                      </div>
                    </div>
                  </summary>
                  {% if task.description %}
                    <p class="muted" style="margin-top: 8px; white-space: pre-wrap;">
                      {{ task.description }}
                    </p>
                  {% endif %}
                  <div
                    id="task-edit-{{ task.id }}"
                    class="inline-edit plan-inline-panel is-hidden"
                  >
                    <form
                      method="post"
                      action="{{ url_for('agents.update_plan_task', plan_id=plan.id, stage_id=stage.id, task_id=task.id) }}"
                      class="form-grid"
                      style="margin-top: 10px;"
                    >
                      <input type="hidden" name="next" value="{{ request.path }}" />
                      <label class="label">
                        task name
                        <input type="text" name="name" value="{{ task.name }}" class="input" required />
                      </label>
                      <label class="label">
                        completed at (optional)
                        <input
                          type="datetime-local"
                          name="completed_at"
                          value="{{ task.completed_at.astimezone().strftime('%Y-%m-%dT%H:%M') if task.completed_at else '' }}"
                          class="input"
                        />
                      </label>
                      <label class="label" style="grid-column: 1 / -1;">
                        description (optional)
                        <textarea name="description" class="textarea">{{ task.description or "" }}</textarea>
                      </label>
                      <div class="form-actions">
                        <button type="submit" class="btn btn-secondary">
                          <i class="fa-solid fa-floppy-disk"></i>
                          save task
                        </button>
                      </div>
                    </form>
                  </div>
                </details>
              {% endfor %}
            {% else %}
              <p class="muted">No tasks for this stage yet.</p>
            {% endif %}
          </div>

          <div
            id="stage-add-task-{{ stage.id }}"
            class="inline-edit plan-inline-panel is-hidden"
            style="margin-top: 12px;"
          >
            <p class="muted" style="font-size: 12px;">add task</p>
            <form
              method="post"
              action="{{ url_for('agents.create_plan_task', plan_id=plan.id, stage_id=stage.id) }}"
              class="form-grid"
              style="margin-top: 10px;"
            >
              <input type="hidden" name="next" value="{{ request.path }}" />
              <label class="label">
                task name
                <input type="text" name="name" class="input" required />
              </label>
              <label class="label">
                completed at (optional)
                <input type="datetime-local" name="completed_at" class="input" />
              </label>
              <label class="label" style="grid-column: 1 / -1;">
                description (optional)
                <textarea name="description" class="textarea"></textarea>
              </label>
              <div class="form-actions">
                <button type="submit" class="btn btn-secondary">
                  <i class="fa-solid fa-plus"></i>
                  add task
                </button>
              </div>
            </form>
          </div>

          <div
            id="stage-edit-{{ stage.id }}"
            class="inline-edit plan-inline-panel is-hidden"
            style="margin-top: 12px;"
          >
            <p class="muted" style="font-size: 12px;">edit stage</p>
            <form
              method="post"
              action="{{ url_for('agents.update_plan_stage', plan_id=plan.id, stage_id=stage.id) }}"
              class="form-grid"
              style="margin-top: 10px;"
            >
              <input type="hidden" name="next" value="{{ request.path }}" />
              <label class="label">
                stage name
                <input type="text" name="name" value="{{ stage.name }}" class="input" required />
              </label>
              <label class="label">
                completed at (optional)
                <input
                  type="datetime-local"
                  name="completed_at"
                  value="{{ stage.completed_at.astimezone().strftime('%Y-%m-%dT%H:%M') if stage.completed_at else '' }}"
                  class="input"
                />
              </label>
              <label class="label" style="grid-column: 1 / -1;">
                description (optional)
                <textarea name="description" class="textarea">{{ stage.description or "" }}</textarea>
              </label>
              <div class="form-actions">
                <button type="submit" class="btn btn-secondary">
                  <i class="fa-solid fa-floppy-disk"></i>
                  save stage
                </button>
              </div>
            </form>
          </div>
        </details>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted" style="margin-top: 16px;">No stages yet.</p>
  {% endif %}

  <div id="add-stage-panel" class="inline-edit plan-inline-panel is-hidden" style="margin-top: 16px;">
    <p class="muted" style="font-size: 12px;">add stage</p>
    <form
      method="post"
      action="{{ url_for('agents.create_plan_stage', plan_id=plan.id) }}"
      class="form-grid"
      style="margin-top: 10px;"
    >
      <input type="hidden" name="next" value="{{ request.path }}" />
      <label class="label">
        stage name
        <input type="text" name="name" class="input" required />
      </label>
      <label class="label">
        completed at (optional)
        <input type="datetime-local" name="completed_at" class="input" />
      </label>
      <label class="label" style="grid-column: 1 / -1;">
        description (optional)
        <textarea name="description" class="textarea"></textarea>
      </label>
      <div class="form-actions">
        <button type="submit" class="btn btn-secondary">
          <i class="fa-solid fa-plus"></i>
          add stage
        </button>
      </div>
    </form>
  </div>
</section>

<style>
  .plan-stage > summary,
  .plan-task > summary,
  .inline-edit > summary {
    list-style: none;
    cursor: pointer;
  }

  .plan-stage > summary::-webkit-details-marker,
  .plan-task > summary::-webkit-details-marker,
  .inline-edit > summary::-webkit-details-marker {
    display: none;
  }

  .plan-stage-summary,
  .plan-task-summary {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin: 0;
  }

  .plan-node-title {
    margin-top: 6px;
    font-weight: 600;
  }

  .plan-completed-meta {
    font-size: 12px;
    color: var(--muted);
  }

  .plan-completed-meta.is-complete {
    color: #bff5d4;
  }

  .plan-stage-actions {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .plan-stage-actions form {
    margin: 0;
  }

  .plan-task-actions {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .plan-task-actions form {
    margin: 0;
  }

  .plan-tree {
    margin-top: 12px;
    margin-left: 10px;
    padding-left: 14px;
    border-left: 1px solid var(--line);
    display: grid;
    gap: 10px;
  }

  .plan-task {
    padding: 10px;
    border: 1px solid var(--line);
    border-radius: 10px;
    background: rgba(24, 33, 43, 0.25);
  }

  .plan-stage.is-complete {
    border-color: rgba(34, 197, 94, 0.45);
    background: rgba(34, 197, 94, 0.1);
  }

  .plan-stage.is-complete .chip {
    border-color: rgba(34, 197, 94, 0.45);
    background: rgba(34, 197, 94, 0.16);
    color: #bff5d4;
  }

  .plan-task.is-complete {
    border-color: rgba(34, 197, 94, 0.45);
    background: rgba(34, 197, 94, 0.14);
  }

  .inline-edit {
    margin-top: 8px;
    border-top: 1px dashed var(--line);
    padding-top: 8px;
  }

  .plan-inline-panel.is-hidden {
    display: none;
  }
</style>

<script>
  const summaryActions = document.querySelectorAll("[data-summary-action]");
  summaryActions.forEach((el) => {
    el.addEventListener("click", (event) => {
      event.stopPropagation();
    });
  });

  const panelToggles = document.querySelectorAll("[data-toggle-panel]");
  panelToggles.forEach((button) => {
    button.addEventListener("click", (event) => {
      event.preventDefault();
      event.stopPropagation();
      const panelId = button.dataset.togglePanel;
      if (!panelId) return;
      const panel = document.getElementById(panelId);
      if (!panel) return;
      const detailsContainer = button.closest("details");
      if (detailsContainer && !detailsContainer.open) {
        detailsContainer.open = true;
      }
      panel.classList.toggle("is-hidden");
    });
  });
</script>
{% endblock %}
