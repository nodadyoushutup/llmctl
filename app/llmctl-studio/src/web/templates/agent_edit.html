{% extends "base.html" %}

{% block topbar_actions %}
  <a class="btn btn-secondary" href="{{ url_for('agents.view_agent', agent_id=agent.id) }}">
    <i class="fa-solid fa-arrow-left"></i>
    back to agent
  </a>
  <a class="btn btn-secondary" href="{{ url_for('agents.list_agents') }}">
    <i class="fa-solid fa-list"></i>
    all agents
  </a>
{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header">
    <div>
      <p class="eyebrow">agent {{ agent.id }}</p>
      <h2 class="section-title">Edit Agent</h2>
    </div>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Update the agent description, role, and runtime configuration.
  </p>
  <form
    method="post"
    action="{{ url_for('agents.update_agent', agent_id=agent.id) }}"
    class="form-grid"
    style="margin-top: 20px;"
  >
    <label class="label">
      name (optional)
      <input type="text" name="name" value="{{ agent.name }}" class="input" />
    </label>
    <label class="label">
      description
      <textarea name="description" class="textarea" required>{{ agent.description or "" }}</textarea>
    </label>
    <label class="label">
      role (optional)
      <select name="role_id" class="input">
        <option value="">No role</option>
        {% for role in roles %}
          <option
            value="{{ role.id }}"
            {% if agent.role_id == role.id %}selected{% endif %}
          >
            {{ role.name }}
          </option>
        {% endfor %}
      </select>
      {% if not roles %}
        <span class="muted" style="font-size: 12px; margin-top: 6px;">
          Create a role in
          <a href="{{ url_for('agents.list_roles') }}" style="text-decoration: underline;">
            roles
          </a>
          to reuse shared prompts.
        </span>
      {% endif %}
    </label>
    <label class="label">
      autoprompt (autorun loop)
      <textarea name="autonomous_prompt" class="textarea">{{ agent.autonomous_prompt or "" }}</textarea>
    </label>
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">
        <i class="fa-solid fa-floppy-disk"></i>
        save
      </button>
      <a class="btn btn-secondary" href="{{ url_for('agents.view_agent', agent_id=agent.id) }}">
        <i class="fa-solid fa-arrow-left"></i>
        cancel
      </a>
    </div>
  </form>
</section>

<section class="card" style="margin-top: 20px;">
  <div class="card-header">
    <h2 class="section-title">Priorities</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Ordered priorities are compiled into autorun instruction markdown only.
  </p>
  {% if priorities %}
    <div style="margin-top: 16px; overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Content</th>
            <th class="table-actions-cell">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for priority in priorities %}
            {% set form_id = "priority-form-" ~ priority.id %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>
                <form
                  id="{{ form_id }}"
                  method="post"
                  action="{{ url_for('agents.update_agent_priority', agent_id=agent.id, priority_id=priority.id) }}"
                >
                  <input type="hidden" name="next" value="{{ request.path }}" />
                  <textarea
                    name="content"
                    class="textarea"
                    style="min-height: 84px;"
                    required
                  >{{ priority.content }}</textarea>
                </form>
              </td>
              <td class="table-actions-cell">
                <div class="table-actions">
                  <button
                    type="submit"
                    form="{{ form_id }}"
                    class="icon-button"
                    aria-label="Save priority"
                    title="Save priority"
                  >
                    <i class="fa-solid fa-floppy-disk"></i>
                  </button>
                  <form
                    method="post"
                    action="{{ url_for('agents.move_agent_priority', agent_id=agent.id, priority_id=priority.id) }}"
                  >
                    <input type="hidden" name="next" value="{{ request.path }}" />
                    <input type="hidden" name="direction" value="up" />
                    <button
                      type="submit"
                      class="icon-button"
                      aria-label="Move priority up"
                      title="Move priority up"
                      {% if loop.first %}disabled{% endif %}
                    >
                      <i class="fa-solid fa-arrow-up"></i>
                    </button>
                  </form>
                  <form
                    method="post"
                    action="{{ url_for('agents.move_agent_priority', agent_id=agent.id, priority_id=priority.id) }}"
                  >
                    <input type="hidden" name="next" value="{{ request.path }}" />
                    <input type="hidden" name="direction" value="down" />
                    <button
                      type="submit"
                      class="icon-button"
                      aria-label="Move priority down"
                      title="Move priority down"
                      {% if loop.last %}disabled{% endif %}
                    >
                      <i class="fa-solid fa-arrow-down"></i>
                    </button>
                  </form>
                  <form
                    method="post"
                    action="{{ url_for('agents.delete_agent_priority', agent_id=agent.id, priority_id=priority.id) }}"
                    onsubmit="return confirm('Delete this priority?');"
                  >
                    <input type="hidden" name="next" value="{{ request.path }}" />
                    <button
                      type="submit"
                      class="icon-button icon-button-danger"
                      aria-label="Delete priority"
                      title="Delete priority"
                    >
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 12px;">No priorities configured yet.</p>
  {% endif %}

  <form
    method="post"
    action="{{ url_for('agents.create_agent_priority', agent_id=agent.id) }}"
    class="form-grid"
    style="margin-top: 16px;"
  >
    <input type="hidden" name="next" value="{{ request.path }}" />
    <label class="label" style="grid-column: 1 / -1;">
      add priority
      <textarea
        name="content"
        class="textarea"
        placeholder="Describe a high-level decision priority."
        required
      ></textarea>
    </label>
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">
        <i class="fa-solid fa-plus"></i>
        add
      </button>
    </div>
  </form>
</section>

<section class="card" style="margin-top: 20px;">
  <div class="card-header">
    <h2 class="section-title">Skills</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    Assign ordered skills on the Agent. Nodes inherit these skills from their resolved Agent.
  </p>
  {% if assigned_skills %}
    <div style="margin-top: 16px; overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Status</th>
            <th>Latest version</th>
            <th class="table-actions-cell">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for skill in assigned_skills %}
            {% set versions = (skill.versions | sort(attribute='id')) %}
            {% set latest_version = versions[-1] if versions else None %}
            <tr class="table-row-link" data-href="{{ url_for('agents.view_skill', skill_id=skill.id) }}">
              <td><p>{{ skill.display_name }}</p></td>
              <td><p>{{ skill.status }}</p></td>
              <td><p>{{ latest_version.version if latest_version else "-" }}</p></td>
              <td class="table-actions-cell">
                <div class="table-actions">
                  <form method="post" action="{{ url_for('agents.move_agent_skill', agent_id=agent.id, skill_id=skill.id) }}">
                    <input type="hidden" name="next" value="{{ request.path }}" />
                    <input type="hidden" name="direction" value="up" />
                    <button type="submit" class="icon-button" aria-label="Move skill up" title="Move skill up" {% if loop.first %}disabled{% endif %}>
                      <i class="fa-solid fa-arrow-up"></i>
                    </button>
                  </form>
                  <form method="post" action="{{ url_for('agents.move_agent_skill', agent_id=agent.id, skill_id=skill.id) }}">
                    <input type="hidden" name="next" value="{{ request.path }}" />
                    <input type="hidden" name="direction" value="down" />
                    <button type="submit" class="icon-button" aria-label="Move skill down" title="Move skill down" {% if loop.last %}disabled{% endif %}>
                      <i class="fa-solid fa-arrow-down"></i>
                    </button>
                  </form>
                  <form method="post" action="{{ url_for('agents.detach_agent_skill', agent_id=agent.id, skill_id=skill.id) }}" onsubmit="return confirm('Remove this skill from the agent?');">
                    <input type="hidden" name="next" value="{{ request.path }}" />
                    <button type="submit" class="icon-button icon-button-danger" aria-label="Remove skill" title="Remove skill">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 12px;">No skills assigned yet.</p>
  {% endif %}

  <form method="post" action="{{ url_for('agents.attach_agent_skill', agent_id=agent.id) }}" class="form-grid" style="margin-top: 16px;">
    <input type="hidden" name="next" value="{{ request.path }}" />
    <label class="label" style="grid-column: 1 / -1;">
      add skill
      <select name="skill_id" class="input" {% if not available_skills %}disabled{% endif %}>
        <option value="">Select a skill</option>
        {% for skill in available_skills %}
          <option value="{{ skill.id }}">{{ skill.display_name }} ({{ skill.status }})</option>
        {% endfor %}
      </select>
    </label>
    <div class="form-actions">
      <button type="submit" class="btn btn-primary" {% if not available_skills %}disabled{% endif %}>
        <i class="fa-solid fa-plus"></i>
        assign
      </button>
    </div>
  </form>
</section>

<script>
  const agentEditSkillRows = document.querySelectorAll(".table-row-link[data-href]");
  agentEditSkillRows.forEach((row) => {
    row.addEventListener("click", (event) => {
      const target = event.target;
      if (
        target.closest("a") ||
        target.closest("button") ||
        target.closest("input") ||
        target.closest("select") ||
        target.closest("textarea") ||
        target.closest("label") ||
        target.closest("summary") ||
        target.closest("details")
      ) {
        return;
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });
  });
</script>
{% endblock %}
