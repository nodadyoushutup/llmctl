{% extends "base.html" %}

{% block topbar_actions %}
  <a class="btn btn-secondary" href="{{ url_for('agents.chat_activity') }}">
    <i class="fa-solid fa-timeline"></i>
    activity
  </a>
{% endblock %}

{% block content %}
{% set default_response_complexity = chat_default_settings.default_response_complexity or 'medium' %}

<style>
  .chat-live-layout {
    display: grid;
    grid-template-columns: minmax(300px, 360px) minmax(0, 1fr);
    gap: 16px;
    min-height: 0;
    height: 100%;
    transition: gap 0.18s ease, grid-template-columns 0.18s ease;
  }

  .chat-live-layout.chat-side-collapsed {
    grid-template-columns: minmax(0, 1fr);
    gap: 0;
  }

  .chat-live-layout.chat-side-collapsed .chat-side-panel {
    display: none;
  }

  .chat-panel {
    display: flex;
    flex-direction: column;
    min-height: 0;
    padding: 18px;
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: linear-gradient(
      180deg,
      rgba(19, 28, 38, 0.95) 0%,
      rgba(16, 23, 31, 0.96) 100%
    );
    box-shadow: 0 22px 48px rgba(0, 0, 0, 0.52);
  }

  .chat-threads-header {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(38, 49, 64, 0.72);
  }

  .chat-thread-create-form {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .chat-thread-create-button {
    width: 100%;
    justify-content: center;
  }

  .chat-checklist {
    max-height: 140px;
    overflow-y: auto;
    padding-right: 4px;
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .chat-checklist label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
  }

  .chat-thread-list-shell {
    margin-top: 12px;
    flex: 1;
    min-height: 0;
    overflow: auto;
  }

  .chat-thread-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .chat-thread-row {
    display: grid;
    grid-template-columns: minmax(0, 1fr) auto;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border: 1px solid rgba(38, 49, 64, 0.72);
    border-radius: 10px;
    background: rgba(9, 13, 18, 0.42);
  }

  .chat-thread-row-selected {
    border-color: rgba(56, 189, 248, 0.6);
    background: rgba(18, 30, 43, 0.55);
  }

  .chat-thread-title {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 13px;
  }

  .chat-main-topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(38, 49, 64, 0.72);
  }

  .chat-main-title {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .chat-main-actions {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chat-session-controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: stretch;
  }

  .chat-session-drawer {
    margin-top: 12px;
    border: 1px solid rgba(38, 49, 64, 0.72);
    border-radius: 12px;
    background: rgba(10, 14, 19, 0.42);
    overflow: hidden;
  }

  .chat-session-drawer summary {
    list-style: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 10px 12px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.22em;
    color: var(--muted);
    min-height: 38px;
  }

  .chat-session-drawer summary::-webkit-details-marker {
    display: none;
  }

  .chat-session-drawer[open] summary {
    border-bottom: 1px solid rgba(38, 49, 64, 0.62);
  }

  .chat-session-summary {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .chat-session-content {
    padding: 10px 12px 12px;
  }

  .chat-control {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    color: var(--muted);
  }

  .chat-control select {
    margin-top: 0;
  }

  .chat-session-save {
    width: 100%;
    justify-content: center;
  }

  .chat-picker {
    border: 1px solid var(--line);
    border-radius: 10px;
    background: rgba(24, 33, 43, 0.58);
    padding: 8px 10px;
    min-height: 44px;
  }

  .chat-picker summary {
    cursor: pointer;
    font-size: 12px;
    text-transform: none;
    letter-spacing: normal;
    color: var(--text);
  }

  .chat-picker-summary {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .chat-picker .chat-checklist {
    max-height: 132px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(38, 49, 64, 0.62);
  }

  .chat-compaction {
    margin-top: 10px;
    border: 1px solid rgba(38, 49, 64, 0.75);
    border-radius: 12px;
    background: rgba(10, 14, 19, 0.5);
    padding: 10px 12px;
  }

  .chat-compaction summary {
    cursor: pointer;
    color: var(--muted);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.2em;
  }

  .chat-compaction pre {
    margin-top: 8px;
    white-space: pre-wrap;
    font-size: 12px;
  }

  .chat-message-log {
    margin-top: 12px;
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding-right: 4px;
  }

  .chat-message {
    --chat-message-max-width: min(78%, 760px);
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(38, 49, 64, 0.7);
    background: rgba(13, 19, 26, 0.8);
    max-width: var(--chat-message-max-width);
    width: fit-content;
    align-self: flex-start;
  }

  .chat-message-user {
    border-color: rgba(251, 191, 36, 0.36);
    background: linear-gradient(180deg, rgba(251, 191, 36, 0.1), rgba(13, 19, 26, 0.85));
    align-self: flex-end;
    border-bottom-right-radius: 6px;
  }

  .chat-message-assistant {
    --chat-message-max-width: min(92%, 1160px);
    border-color: rgba(56, 189, 248, 0.36);
    background: linear-gradient(180deg, rgba(56, 189, 248, 0.1), rgba(13, 19, 26, 0.85));
    border-bottom-left-radius: 6px;
  }

  .chat-message-header {
    margin-bottom: 8px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.24em;
    color: var(--muted);
  }

  .chat-message-content {
    white-space: normal;
    word-break: break-word;
    line-height: 1.45;
  }

  .chat-message-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 0 0 10px;
    display: block;
    overflow-x: auto;
  }

  .chat-message-content th,
  .chat-message-content td {
    border: 1px solid rgba(38, 49, 64, 0.72);
    padding: 6px 8px;
    text-align: left;
    vertical-align: top;
  }

  .chat-message-content th {
    background: rgba(24, 33, 43, 0.72);
  }

  .chat-input-form {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(38, 49, 64, 0.72);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .chat-input-textarea {
    width: 100%;
    min-height: 40px;
    max-height: 132px;
    padding: 12px 14px;
    border: 1px solid rgba(38, 49, 64, 0.9);
    border-radius: 16px;
    background: rgba(9, 13, 18, 0.62);
    color: var(--text);
    font-size: 14px;
    font-family: "Space Grotesk", sans-serif;
    line-height: 1.45;
    resize: none;
    overflow-y: hidden;
    outline: none;
    transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
  }

  .chat-input-textarea::placeholder {
    color: rgba(168, 179, 194, 0.72);
  }

  .chat-input-textarea:focus,
  .chat-input-textarea:focus-visible {
    border-color: rgba(56, 189, 248, 0.5);
    box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.16);
    background: rgba(11, 16, 23, 0.82);
  }

  .chat-input-textarea:disabled {
    opacity: 0.65;
    cursor: not-allowed;
  }

  .chat-message-pending {
    opacity: 0.82;
  }

  .chat-empty {
    display: grid;
    place-items: center;
    color: var(--muted);
    flex: 1;
    min-height: 0;
    text-align: center;
    padding: 24px;
  }

  @media (max-width: 1080px) {
    .chat-live-layout {
      grid-template-columns: 1fr;
    }

    .chat-panel {
      min-height: 360px;
    }
  }
</style>

{% if selected_thread %}
  {% set selected_mcp_ids = selected_thread.mcp_servers | map(attribute='id') | list %}
  {% set selected_collections = selected_thread.rag_collections or [] %}
  {% set selected_mcp_count = selected_mcp_ids | length %}
  {% set selected_rag_count = selected_collections | length %}
  {% set selected_response_complexity = selected_thread.response_complexity or default_response_complexity %}
  {% set selected_response_complexity_label = selected_thread.response_complexity_label or "Medium" %}
  {% set usage_pct = 0 %}
  {% if selected_thread.latest_turn and selected_thread.latest_turn.context_limit_tokens %}
    {% set usage_pct = ((selected_thread.latest_turn.context_usage_after or 0) * 100 / selected_thread.latest_turn.context_limit_tokens) | round(1) %}
  {% endif %}
{% else %}
  {% set selected_mcp_ids = [] %}
  {% set selected_collections = [] %}
  {% set selected_mcp_count = 0 %}
  {% set selected_rag_count = 0 %}
  {% set selected_response_complexity = default_response_complexity %}
  {% set selected_response_complexity_label = "Medium" %}
  {% set usage_pct = 0 %}
{% endif %}

<section class="chat-live-layout" id="chat-live-layout">
  <aside class="chat-panel chat-side-panel">
    <div class="chat-threads-header">
      <form method="post" action="{{ url_for('agents.create_chat_thread_route') }}" class="chat-thread-create-form">
        <button
          type="submit"
          class="btn btn-primary chat-thread-create-button"
          aria-label="Create thread"
        >
          <i class="fa-solid fa-plus"></i>
          new chat
        </button>
      </form>
    </div>

    {% if selected_thread %}
      <details class="chat-session-drawer" open>
        <summary>
          <span>session controls</span>
          <span class="chat-session-summary">
            <span>{{ selected_thread.model_name or "default model" }}</span>
            <span>{{ selected_response_complexity_label }}</span>
            <span>rag {{ selected_rag_count }}</span>
            <span>mcp {{ selected_mcp_count }}</span>
          </span>
        </summary>
        <div class="chat-session-content">
          <form method="post" action="{{ url_for('agents.update_chat_thread_route', thread_id=selected_thread.id) }}" class="chat-session-controls">
            <label class="chat-control">
              model
              <select name="model_id">
                <option value="">Default model</option>
                {% for model in models %}
                  <option value="{{ model.id }}" {% if selected_thread.model_id == model.id %}selected{% endif %}>
                    {{ model.name }} ({{ model.provider }})
                  </option>
                {% endfor %}
              </select>
            </label>
            <label class="chat-control">
              complexity
              <select name="response_complexity">
                <option value="low" {% if selected_response_complexity == 'low' %}selected{% endif %}>Low</option>
                <option value="medium" {% if selected_response_complexity == 'medium' %}selected{% endif %}>Medium</option>
                <option value="high" {% if selected_response_complexity == 'high' %}selected{% endif %}>High</option>
                <option value="extra_high" {% if selected_response_complexity == 'extra_high' %}selected{% endif %}>Extra High</option>
              </select>
            </label>

            <div class="chat-control">
              rag
              <details class="chat-picker">
                <summary>
                  <span class="chat-picker-summary">
                    <i class="fa-solid fa-database"></i>
                    {{ selected_rag_count }} selected
                  </span>
                </summary>
                {% if rag_health.state == 'configured_healthy' and rag_collections %}
                  <div class="chat-checklist">
                    {% for collection in rag_collections %}
                      <label>
                        <input
                          type="checkbox"
                          name="rag_collections"
                          value="{{ collection.id }}"
                          {% if collection.id in selected_collections %}checked{% endif %}
                        />
                        <span>{{ collection.name }}</span>
                      </label>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="muted" style="margin-top: 8px; font-size: 12px;">
                    RAG state: {{ rag_health.state }}{% if rag_health.error %} ({{ rag_health.error }}){% endif %}
                  </p>
                {% endif %}
              </details>
            </div>

            <div class="chat-control">
              mcp
              <details class="chat-picker">
                <summary>
                  <span class="chat-picker-summary">
                    <i class="fa-solid fa-plug"></i>
                    {{ selected_mcp_count }} selected
                  </span>
                </summary>
                <div class="chat-checklist">
                  {% for mcp in mcp_servers %}
                    <label>
                      <input
                        type="checkbox"
                        name="mcp_server_ids"
                        value="{{ mcp.id }}"
                        {% if mcp.id in selected_mcp_ids %}checked{% endif %}
                      />
                      <span>{{ mcp.name }}</span>
                    </label>
                  {% endfor %}
                </div>
              </details>
            </div>

            <button type="submit" class="btn btn-secondary chat-session-save">
              <i class="fa-solid fa-floppy-disk"></i>
              save
            </button>
          </form>
        </div>
      </details>
    {% endif %}

    {% if threads %}
      <div class="chat-thread-list-shell">
        <div class="chat-thread-list">
          {% for thread in threads %}
            <div
              class="chat-thread-row table-row-link {% if selected_thread and selected_thread.id == thread.id %}chat-thread-row-selected{% endif %}"
              data-href="{{ url_for('agents.chat_page', thread_id=thread.id) }}"
            >
              <p class="chat-thread-title">{{ thread.title }}</p>
              <form
                method="post"
                action="{{ url_for('agents.archive_chat_thread_route', thread_id=thread.id) }}"
                onsubmit="return confirm('Remove this thread from the list?');"
              >
                <button type="submit" class="icon-button icon-button-danger" aria-label="Delete thread">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </form>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <p class="muted" style="margin-top: 14px;">No chat threads yet.</p>
    {% endif %}
  </aside>

  <article class="chat-panel">
    <div class="chat-main-topbar">
      <div class="chat-main-title">
        <h2 class="section-title">{{ selected_thread.title if selected_thread else "Live Chat" }}</h2>
        <p class="muted" style="font-size: 12px;">
          {% if selected_thread %}
            {{ usage_pct }}%
          {% else %}
            select a thread to start
          {% endif %}
        </p>
      </div>
      <div class="chat-main-actions">
        <button
          type="button"
          id="chat-panel-toggle"
          class="icon-button"
          data-chat-panel-toggle
          aria-label="Collapse side panel"
          title="Collapse side panel"
        >
          <i class="fa-solid fa-angles-left" data-chat-panel-toggle-icon></i>
        </button>
        {% if selected_thread %}
          <form method="post" action="{{ url_for('agents.clear_chat_thread_route', thread_id=selected_thread.id) }}" onsubmit="return confirm('Clear this thread context and messages?');">
            <button type="submit" class="icon-button" aria-label="Clear thread">
              <i class="fa-solid fa-eraser"></i>
            </button>
          </form>
          <button id="chat-send-btn" type="submit" form="chat-turn-form" class="btn btn-primary">
            <i class="fa-solid fa-paper-plane"></i>
            send
          </button>
        {% endif %}
      </div>
    </div>

    {% if selected_thread %}
      {% if selected_thread.compaction_summary_text %}
        <details class="chat-compaction">
          <summary>compaction summary</summary>
          <pre>{{ selected_thread.compaction_summary_text }}</pre>
        </details>
      {% endif %}

      <div id="chat-error" class="alert alert-error" style="display: none; margin-top: 12px;"></div>

      <div class="chat-message-log" id="chat-message-log">
        {% for item in selected_thread.messages %}
          <div class="chat-message {% if item.role == 'user' %}chat-message-user{% else %}chat-message-assistant{% endif %}">
            <p class="chat-message-header">
              {% if item.role == 'user' %}
                you
              {% elif item.role == 'assistant' %}
                LLMCTL
              {% else %}
                {{ item.role }}
              {% endif %}
            </p>
            <div class="chat-message-content markdown-content" data-chat-markdown="true">{{ item.content }}</div>
          </div>
        {% endfor %}
      </div>

      <form id="chat-turn-form" data-thread-id="{{ selected_thread.id }}" class="chat-input-form">
        <textarea
          id="chat-message"
          name="message"
          rows="1"
          class="chat-input-textarea"
          placeholder="Send a message..."
        ></textarea>
      </form>
    {% else %}
      <div class="chat-empty">
        <p>Create or select a thread to start chatting.</p>
      </div>
    {% endif %}
  </article>
</section>

<script>
  const rowLinks = document.querySelectorAll(".table-row-link");
  rowLinks.forEach((row) => {
    row.addEventListener("click", (event) => {
      const target = event.target;
      if (
        target.closest("a") ||
        target.closest("button") ||
        target.closest("input") ||
        target.closest("select") ||
        target.closest("textarea") ||
        target.closest("label") ||
        target.closest("summary") ||
        target.closest("details")
      ) {
        return;
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });
  });

  const chatLiveLayout = document.getElementById("chat-live-layout");
  const chatPanelToggle = document.querySelector("[data-chat-panel-toggle]");
  if (chatLiveLayout && chatPanelToggle) {
    const toggleIcon = chatPanelToggle.querySelector("[data-chat-panel-toggle-icon]");
    const collapsedClass = "chat-side-collapsed";
    const storageKey = "llmctl-chat-side-collapsed";
    const applyPanelState = (collapsed, persist = true) => {
      chatLiveLayout.classList.toggle(collapsedClass, collapsed);
      const label = collapsed ? "Expand side panel" : "Collapse side panel";
      chatPanelToggle.setAttribute("aria-label", label);
      chatPanelToggle.setAttribute("title", label);
      if (toggleIcon) {
        toggleIcon.classList.toggle("fa-angles-right", collapsed);
        toggleIcon.classList.toggle("fa-angles-left", !collapsed);
      }
      if (!persist) {
        return;
      }
      try {
        window.localStorage.setItem(storageKey, collapsed ? "1" : "0");
      } catch (error) {
      }
    };

    let initialCollapsed = false;
    try {
      initialCollapsed = window.localStorage.getItem(storageKey) === "1";
    } catch (error) {
    }
    applyPanelState(initialCollapsed, false);
    chatPanelToggle.addEventListener("click", () => {
      const collapsed = !chatLiveLayout.classList.contains(collapsedClass);
      applyPanelState(collapsed);
    });
  }

  const escapeHtml = (value) =>
    String(value || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");

  const sanitizeUrl = (rawValue) => {
    const raw = String(rawValue || "").trim();
    if (!raw) {
      return null;
    }
    if (
      raw.startsWith("/") ||
      raw.startsWith("#") ||
      raw.startsWith("./") ||
      raw.startsWith("../")
    ) {
      return raw;
    }
    try {
      const parsed = new URL(raw);
      if (["http:", "https:", "mailto:"].includes(parsed.protocol)) {
        return parsed.toString();
      }
    } catch (error) {
    }
    return null;
  };

  const renderInlineMarkdown = (value) => {
    if (!value) {
      return "";
    }
    const inlineCodeTokens = [];
    let rendered = value.replace(/`([^`\n]+)`/g, (_, code) => {
      const token = `@@INLINE_CODE_${inlineCodeTokens.length}@@`;
      inlineCodeTokens.push(`<code>${code}</code>`);
      return token;
    });

    rendered = rendered.replace(
      /\[([^\]]+)\]\(([^)\s]+)(?:\s+"([^"]*)")?\)/g,
      (_, label, href, title) => {
        const safeHref = sanitizeUrl(href);
        const labelText = label || href;
        if (!safeHref) {
          return labelText;
        }
        const escapedHref = escapeHtml(safeHref);
        const escapedTitle = title ? ` title="${escapeHtml(title)}"` : "";
        return `<a href="${escapedHref}"${escapedTitle} target="_blank" rel="noopener noreferrer">${labelText}</a>`;
      },
    );
    rendered = rendered.replace(/\*\*([^*\n]+)\*\*/g, "<strong>$1</strong>");
    rendered = rendered.replace(/\*([^*\n]+)\*/g, "<em>$1</em>");
    rendered = rendered.replace(/~~([^~\n]+)~~/g, "<del>$1</del>");
    return rendered.replace(/@@INLINE_CODE_(\d+)@@/g, (_, index) => {
      const token = inlineCodeTokens[Number(index)];
      return token || "";
    });
  };

  const parseTableCells = (line) => {
    const normalized = String(line || "").trim();
    if (!normalized.includes("|")) {
      return [];
    }
    const withoutEdgePipes = normalized.replace(/^\|/, "").replace(/\|$/, "");
    return withoutEdgePipes.split("|").map((item) => item.trim());
  };

  const tableAlignStyle = (delimiterCell) => {
    const token = String(delimiterCell || "").trim();
    if (token.startsWith(":") && token.endsWith(":")) {
      return "center";
    }
    if (token.endsWith(":")) {
      return "right";
    }
    return "left";
  };

  const renderMarkdown = (rawValue) => {
    const normalized = String(rawValue || "").replace(/\r\n/g, "\n");
    if (!normalized.trim()) {
      return "";
    }
    const escaped = escapeHtml(normalized);
    const codeBlockTokens = [];
    let working = escaped.replace(
      /```([A-Za-z0-9_+-]*)[ \t]*\n?([\s\S]*?)```/g,
      (_, language, code) => {
        const token = `@@CODE_BLOCK_${codeBlockTokens.length}@@`;
        const className = language ? ` class="language-${escapeHtml(language)}"` : "";
        const codeBody = code.endsWith("\n") ? code.slice(0, -1) : code;
        codeBlockTokens.push(`<pre><code${className}>${codeBody}</code></pre>`);
        return token;
      },
    );
    const blocks = working
      .split(/\n{2,}/)
      .map((block) => block.trim())
      .filter(Boolean);

    const renderedBlocks = blocks.map((block) => {
      if (/^@@CODE_BLOCK_\d+@@$/.test(block)) {
        return block;
      }
      if (/^([-*_]\s*){3,}$/.test(block)) {
        return "<hr />";
      }
      const heading = block.match(/^(#{1,6})\s+(.+)$/);
      if (heading) {
        const level = heading[1].length;
        const text = renderInlineMarkdown(heading[2].trim());
        return `<h${level}>${text}</h${level}>`;
      }

      const lines = block.split("\n");
      if (lines.length >= 2) {
        const headerCells = parseTableCells(lines[0]);
        const delimiterCells = parseTableCells(lines[1]);
        const isTable =
          headerCells.length > 0 &&
          headerCells.length === delimiterCells.length &&
          delimiterCells.every((cell) => /^:?-{3,}:?$/.test(cell));
        if (isTable) {
          const headerHtml = headerCells
            .map((cell, index) => {
              const align = tableAlignStyle(delimiterCells[index]);
              return `<th style="text-align: ${align};">${renderInlineMarkdown(cell)}</th>`;
            })
            .join("");
          const bodyRows = lines.slice(2).filter((line) => line.trim());
          const bodyHtml = bodyRows
            .map((row) => {
              const rowCells = parseTableCells(row);
              while (rowCells.length < headerCells.length) {
                rowCells.push("");
              }
              return (
                "<tr>" +
                headerCells
                  .map((_, index) => {
                    const align = tableAlignStyle(delimiterCells[index]);
                    const cellText = rowCells[index] || "";
                    return `<td style="text-align: ${align};">${renderInlineMarkdown(cellText)}</td>`;
                  })
                  .join("") +
                "</tr>"
              );
            })
            .join("");
          return `<table><thead><tr>${headerHtml}</tr></thead><tbody>${bodyHtml}</tbody></table>`;
        }
      }

      if (lines.every((line) => /^\s*[-*]\s+/.test(line))) {
        const items = lines
          .map((line) => line.replace(/^\s*[-*]\s+/, ""))
          .map((line) => `<li>${renderInlineMarkdown(line)}</li>`)
          .join("");
        return `<ul>${items}</ul>`;
      }
      if (lines.every((line) => /^\s*\d+\.\s+/.test(line))) {
        const items = lines
          .map((line) => line.replace(/^\s*\d+\.\s+/, ""))
          .map((line) => `<li>${renderInlineMarkdown(line)}</li>`)
          .join("");
        return `<ol>${items}</ol>`;
      }
      if (lines.every((line) => /^\s*>\s?/.test(line))) {
        const quote = lines
          .map((line) => line.replace(/^\s*>\s?/, ""))
          .map((line) => renderInlineMarkdown(line))
          .join("<br>");
        return `<blockquote>${quote}</blockquote>`;
      }
      return `<p>${lines.map((line) => renderInlineMarkdown(line)).join("<br>")}</p>`;
    });

    const html = renderedBlocks.join("\n");
    return html.replace(/@@CODE_BLOCK_(\d+)@@/g, (_, index) => {
      const token = codeBlockTokens[Number(index)];
      return token || "";
    });
  };

  document.querySelectorAll("[data-chat-markdown='true']").forEach((targetEl) => {
    const raw = targetEl.textContent || "";
    targetEl.dataset.rawMarkdown = raw;
    targetEl.innerHTML = renderMarkdown(raw);
  });

  const messageLog = document.getElementById("chat-message-log");
  const scrollMessageLogToBottom = () => {
    if (!messageLog) {
      return;
    }
    messageLog.scrollTop = messageLog.scrollHeight;
  };
  scrollMessageLogToBottom();

  const form = document.getElementById("chat-turn-form");
  const sendButton = document.getElementById("chat-send-btn");
  const messageInput = document.getElementById("chat-message");
  const errorBox = document.getElementById("chat-error");
  const threadTitle = document.querySelector(".chat-main-title .section-title");
  const threadUsage = document.querySelector(".chat-main-title .muted");
  const selectedThreadTitle = document.querySelector(".chat-thread-row-selected .chat-thread-title");
  if (form && sendButton && messageInput && errorBox) {
    const renderMarkdownInto = (target, raw) => {
      target.dataset.rawMarkdown = raw;
      target.innerHTML = renderMarkdown(raw);
    };

    const appendChatMessage = (role, content, options = {}) => {
      if (!messageLog) {
        return null;
      }
      const messageWrap = document.createElement("div");
      messageWrap.className = `chat-message ${role === "user" ? "chat-message-user" : "chat-message-assistant"}`;
      if (options.pending) {
        messageWrap.classList.add("chat-message-pending");
      }

      const header = document.createElement("p");
      header.className = "chat-message-header";
      if (role === "user") {
        header.textContent = "you";
      } else if (role === "assistant") {
        header.textContent = "LLMCTL";
      } else {
        header.textContent = role;
      }

      const body = document.createElement("div");
      body.className = "chat-message-content markdown-content";
      body.dataset.chatMarkdown = "true";
      renderMarkdownInto(body, content);

      messageWrap.appendChild(header);
      messageWrap.appendChild(body);
      messageLog.appendChild(messageWrap);
      scrollMessageLogToBottom();
      return { wrap: messageWrap, body };
    };

    const setComposerBusy = (isBusy) => {
      sendButton.disabled = isBusy;
      messageInput.disabled = isBusy;
      if (isBusy) {
        form.setAttribute("aria-busy", "true");
      } else {
        form.removeAttribute("aria-busy");
      }
    };

    const updateThreadMeta = (thread) => {
      if (!thread || typeof thread !== "object") {
        return;
      }
      const title = String(thread.title || "").trim();
      if (title) {
        if (threadTitle) {
          threadTitle.textContent = title;
        }
        if (selectedThreadTitle) {
          selectedThreadTitle.textContent = title;
        }
      }

      const latestTurn = thread.latest_turn;
      const limit = Number(latestTurn && latestTurn.context_limit_tokens);
      if (!threadUsage || !Number.isFinite(limit) || limit <= 0) {
        return;
      }
      const usageAfter = Number(latestTurn.context_usage_after) || 0;
      const usagePct = ((usageAfter * 100) / limit).toFixed(1);
      threadUsage.textContent = `${usagePct}%`;
    };

    const autosizeMessageInput = () => {
      const styles = window.getComputedStyle(messageInput);
      const lineHeight = Number.parseFloat(styles.lineHeight) || 22;
      const paddingTop = Number.parseFloat(styles.paddingTop) || 0;
      const paddingBottom = Number.parseFloat(styles.paddingBottom) || 0;
      const maxHeight = lineHeight * 4 + paddingTop + paddingBottom;
      messageInput.style.height = "auto";
      if (messageInput.scrollHeight > maxHeight) {
        messageInput.style.height = `${maxHeight}px`;
        messageInput.style.overflowY = "auto";
      } else {
        messageInput.style.height = `${messageInput.scrollHeight}px`;
        messageInput.style.overflowY = "hidden";
      }
    };

    messageInput.addEventListener("input", autosizeMessageInput);
    messageInput.addEventListener("keydown", (event) => {
      if (event.isComposing) {
        return;
      }
      if (messageInput.disabled) {
        return;
      }
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        if (typeof form.requestSubmit === "function") {
          form.requestSubmit();
        } else {
          form.dispatchEvent(
            new Event("submit", {
              bubbles: true,
              cancelable: true,
            })
          );
        }
      }
    });
    autosizeMessageInput();

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      errorBox.style.display = "none";
      const message = messageInput.value.trim();
      if (!message) {
        errorBox.textContent = "Message is required.";
        errorBox.style.display = "";
        return;
      }
      const threadId = form.dataset.threadId;
      if (!threadId) {
        return;
      }
      const userMessage = message;
      messageInput.value = "";
      autosizeMessageInput();
      appendChatMessage("user", userMessage);
      const pendingReply = appendChatMessage("assistant", "Thinking...", { pending: true });
      setComposerBusy(true);
      try {
        const response = await fetch(`/api/chat/threads/${threadId}/turn`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: userMessage }),
        });
        const payload = await response.json();
        if (!response.ok || !payload.ok) {
          let failureMessage = payload.error || "Chat request failed.";
          if (payload.reason_code) {
            failureMessage += ` (${payload.reason_code})`;
          }
          errorBox.textContent = failureMessage;
          if (pendingReply) {
            pendingReply.wrap.classList.remove("chat-message-pending");
            renderMarkdownInto(
              pendingReply.body,
              `Error: ${failureMessage}`,
            );
          }
          errorBox.style.display = "";
          return;
        }
        const replyText = String(payload.reply || "").trim() || "(no response)";
        if (pendingReply) {
          pendingReply.wrap.classList.remove("chat-message-pending");
          renderMarkdownInto(pendingReply.body, replyText);
        } else {
          appendChatMessage("assistant", replyText);
        }
        updateThreadMeta(payload.thread);
      } catch (error) {
        errorBox.textContent = "Chat request failed.";
        errorBox.style.display = "";
        if (pendingReply) {
          pendingReply.wrap.classList.remove("chat-message-pending");
          renderMarkdownInto(pendingReply.body, "Error: Chat request failed.");
        }
      } finally {
        setComposerBusy(false);
        messageInput.focus();
      }
    });
  }
</script>
{% endblock %}
