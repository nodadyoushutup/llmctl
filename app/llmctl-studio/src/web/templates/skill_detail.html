{% extends "base.html" %}

{% block topbar_actions %}
  <a class="btn btn-secondary" href="{{ url_for('agents.list_skills') }}">
    <i class="fa-solid fa-arrow-left"></i>
    all skills
  </a>
{% endblock %}

{% block action_header %}
  <div class="action-header-actions">
    <a class="btn btn-secondary" href="{{ url_for('agents.edit_skill', skill_id=skill.id) }}">
      <i class="fa-solid fa-pen-to-square"></i>
      edit
    </a>
    <a
      class="btn btn-secondary"
      href="{{ url_for('agents.export_skill', skill_id=skill.id, version=(selected_version.version if selected_version else None)) }}"
    >
      <i class="fa-solid fa-file-export"></i>
      export bundle
    </a>
    <form
      method="post"
      action="{{ url_for('agents.delete_skill', skill_id=skill.id) }}"
      onsubmit="return confirm('Delete this skill?');"
    >
      <input type="hidden" name="next" value="{{ url_for('agents.list_skills') }}" />
      <button type="submit" class="btn btn-danger">
        <i class="fa-solid fa-trash"></i>
        delete
      </button>
    </form>
  </div>
{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header">
    <div>
      <p class="eyebrow">skill {{ skill.id }}</p>
      <h2 class="section-title">{{ skill.display_name }}</h2>
    </div>
  </div>
  <div class="grid grid-2" style="margin-top: 16px;">
    <div class="subcard">
      <p class="eyebrow">metadata</p>
      <div class="stack" style="margin-top: 10px; font-size: 12px;">
        <p class="muted">Slug: {{ skill.name }}</p>
        <p class="muted">Status: {{ skill.status }}</p>
        <p class="muted">Description: {{ skill.description or '-' }}</p>
        <p class="muted">Versions: {{ versions | length }}</p>
        <p class="muted">Agent bindings: {{ attached_agents | length }}</p>
        <p class="muted">Created: {{ human_time(skill.created_at) }}</p>
        <p class="muted">Updated: {{ human_time(skill.updated_at) }}</p>
      </div>
    </div>
    <div class="subcard">
      <p class="eyebrow">version selector</p>
      <form method="get" action="{{ url_for('agents.view_skill', skill_id=skill.id) }}" style="margin-top: 10px;">
        <label class="label" style="margin-top: 0;">
          version
          <select name="version" class="input" onchange="this.form.submit()">
            {% for version in versions %}
              <option value="{{ version.version }}" {% if selected_version and selected_version.id == version.id %}selected{% endif %}>
                {{ version.version }}
              </option>
            {% endfor %}
          </select>
        </label>
      </form>
      {% if selected_version %}
        <p class="muted" style="margin-top: 8px; font-size: 12px;">
          Selected version id {{ selected_version.id }}
        </p>
      {% endif %}
    </div>
  </div>
</section>

{% if preview %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Version {{ preview.version }}</h2>
  </div>
  <p class="muted" style="margin-top: 12px; font-size: 12px;">
    Manifest hash: {{ preview.manifest_hash or '-' }}
  </p>
  {% if preview.skill_md %}
    <div class="subcard" style="margin-top: 14px;">
      <p class="eyebrow">SKILL.md</p>
      <pre style="margin-top: 10px; white-space: pre-wrap;">{{ preview.skill_md }}</pre>
    </div>
  {% endif %}
  <div style="margin-top: 14px; overflow-x: auto;">
    <table class="table">
      <thead>
        <tr>
          <th>Path</th>
          <th>Size</th>
          <th>Checksum</th>
          <th>Preview</th>
        </tr>
      </thead>
      <tbody>
        {% for file in preview.files %}
          <tr>
            <td><p>{{ file.path }}</p></td>
            <td><p>{{ file.size_bytes or '-' }}</p></td>
            <td><p class="muted">{{ file.checksum or '-' }}</p></td>
            <td>
              <details>
                <summary class="muted" style="cursor: pointer;">view</summary>
                <pre style="margin-top: 8px; white-space: pre-wrap;">{{ file.content_preview }}</pre>
              </details>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

<section class="card">
  <div class="card-header">
    <h2 class="section-title">Agent Bindings</h2>
  </div>
  {% if attached_agents %}
    <div style="margin-top: 14px; overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Agent</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for agent in attached_agents %}
            <tr class="table-row-link" data-href="{{ url_for('agents.view_agent', agent_id=agent.id) }}">
              <td>
                <p>{{ agent.name }}</p>
              </td>
              <td>
                <p class="muted">{{ agent.description or "-" }}</p>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 14px;">No agents currently bind this skill.</p>
  {% endif %}
</section>

<script>
  const skillAgentRows = document.querySelectorAll(".table-row-link[data-href]");
  skillAgentRows.forEach((row) => {
    row.addEventListener("click", (event) => {
      const target = event.target;
      if (
        target.closest("a") ||
        target.closest("button") ||
        target.closest("input") ||
        target.closest("select") ||
        target.closest("textarea") ||
        target.closest("label") ||
        target.closest("summary") ||
        target.closest("details")
      ) {
        return;
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });
  });
</script>
{% endblock %}
