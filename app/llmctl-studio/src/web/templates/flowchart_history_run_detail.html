{% extends "base.html" %}

{% block topbar_actions %}
  <a class="btn btn-secondary" href="{{ url_for('agents.view_flowchart_history', flowchart_id=flowchart.id) }}">
    <i class="fa-solid fa-arrow-left"></i>
    back to history
  </a>
  <a class="btn btn-secondary" href="{{ url_for('agents.view_flowchart', flowchart_id=flowchart.id) }}">
    <i class="fa-solid fa-diagram-project"></i>
    open flowchart
  </a>
{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Run {{ flowchart_run.id }}</h2>
  </div>
  <div style="margin-top: 20px; overflow-x: auto;">
    <table class="table">
      <thead>
        <tr>
          <th>Status</th>
          <th>Cycles</th>
          <th>Node runs</th>
          <th>Created</th>
          <th>Started</th>
          <th>Finished</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <span class="status {{ status_class(flowchart_run.status) }}">{{ flowchart_run.status }}</span>
          </td>
          <td class="muted">{{ flowchart_run.cycle_count }}</td>
          <td class="muted">{{ flowchart_run.node_run_count }}</td>
          <td class="muted">{{ flowchart_run.created_at or "-" }}</td>
          <td class="muted">{{ flowchart_run.started_at or "-" }}</td>
          <td class="muted">{{ flowchart_run.finished_at or "-" }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

{% if flowchart_run.status in ["queued", "running", "stopping"] %}
  <section class="card">
    <div class="card-header">
      <h2 class="section-title">Run Controls</h2>
    </div>
    <div class="row" style="margin-top: 16px; gap: 10px; flex-wrap: wrap;">
      {% if flowchart_run.status in ["queued", "running"] %}
        <form method="post" action="{{ url_for('agents.cancel_flowchart_run', run_id=flowchart_run.id) }}">
          <input type="hidden" name="next" value="{{ request.path }}" />
          <button type="submit" class="btn btn-secondary">
            <i class="fa-solid fa-stop"></i>
            stop after current node
          </button>
        </form>
      {% endif %}
      <form
        method="post"
        action="{{ url_for('agents.cancel_flowchart_run', run_id=flowchart_run.id) }}"
        onsubmit="return confirm('Force stop this run immediately?');"
      >
        <input type="hidden" name="next" value="{{ request.path }}" />
        <input type="hidden" name="force" value="true" />
        <button type="submit" class="btn btn-danger">
          <i class="fa-solid fa-power-off"></i>
          force stop now
        </button>
      </form>
    </div>
    {% if flowchart_run.status == "stopping" %}
      <p class="muted" style="margin-top: 12px;">
        Stop requested. This run will stop after the current node finishes.
      </p>
    {% endif %}
  </section>
{% endif %}

<section class="card">
  <div class="card-header">
    <h2 class="section-title">Node Runs</h2>
  </div>
  {% if node_runs %}
    <div style="margin-top: 20px; overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Node run</th>
            <th>Cycle</th>
            <th>Node</th>
            <th>Status</th>
            <th>Execution</th>
            <th>Node task</th>
            <th>Started</th>
            <th>Finished</th>
          </tr>
        </thead>
        <tbody>
          {% for node_run in node_runs %}
            <tr
              {% if node_run.agent_task_id %}
                class="table-row-link"
                data-href="{{ url_for('agents.view_node', task_id=node_run.agent_task_id) }}"
              {% endif %}
            >
              <td>
                {% if node_run.agent_task_id %}
                  <a href="{{ url_for('agents.view_node', task_id=node_run.agent_task_id) }}">
                    {{ node_run.id }}
                  </a>
                {% else %}
                  {{ node_run.id }}
                {% endif %}
              </td>
              <td class="muted">{{ node_run.cycle_index }}</td>
              <td>
                <p>{{ node_run.node_title }}</p>
                <p class="muted" style="font-size: 12px; margin-top: 4px;">{{ node_run.node_type }}</p>
              </td>
              <td>
                <span class="status {{ status_class(node_run.status) }}">{{ node_run.status }}</span>
              </td>
              <td class="muted">{{ node_run.execution_index }}</td>
              <td>
                {% if node_run.agent_task_id %}
                  <a href="{{ url_for('agents.view_node', task_id=node_run.agent_task_id) }}">
                    {{ node_run.agent_task_id }}
                  </a>
                {% else %}
                  <span class="muted">-</span>
                {% endif %}
              </td>
              <td class="muted">{{ node_run.started_at or "-" }}</td>
              <td class="muted">{{ node_run.finished_at or "-" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 12px;">No node runs recorded for this flowchart run yet.</p>
  {% endif %}
</section>

{% if flowchart_run.status in ["queued", "running", "stopping"] %}
  <script>
    setTimeout(() => {
      window.location.reload();
    }, 4000);
  </script>
{% endif %}

<script>
  const nodeRunRows = document.querySelectorAll(".table-row-link");
  const isInteractiveTarget = (target) =>
    target.closest(
      "a, button, input, select, textarea, label, summary, details"
    );
  nodeRunRows.forEach((row) => {
    row.addEventListener("click", (event) => {
      if (isInteractiveTarget(event.target)) {
        return;
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });
  });
</script>
{% endblock %}
