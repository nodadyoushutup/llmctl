services:
  llmctl-redis:
    image: redis:7.2-alpine
    command: ["redis-server", "--appendonly", "yes", "--port", "6380"]
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "6380:6380"
  github-mcp:
    build:
      context: ..
      dockerfile: app/llmctl-mcp/docker/github-mcp-proxy.Dockerfile
    container_name: github-mcp
    environment:
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN}
      - GITHUB_HOST=${GITHUB_HOST:-}
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    entrypoint: ["/bin/busybox", "sleep", "infinity"]
    restart: unless-stopped
  jira-mcp:
    image: ghcr.io/sooperset/mcp-atlassian:latest
    container_name: jira-mcp
    environment:
      - JIRA_URL=${JIRA_URL}
      - JIRA_USERNAME=${JIRA_USERNAME}
      - JIRA_API_TOKEN=${JIRA_API_TOKEN}
      - CONFLUENCE_URL=${CONFLUENCE_URL}
      - CONFLUENCE_USERNAME=${CONFLUENCE_USERNAME}
      - CONFLUENCE_API_TOKEN=${CONFLUENCE_API_TOKEN}
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    entrypoint: ["sleep", "infinity"]
    restart: unless-stopped
  chromadb-mcp:
    image: llmctl-chromadb-mcp:latest
    build:
      context: ..
      dockerfile: app/llmctl-mcp/docker/chromadb-mcp-proxy.Dockerfile
    container_name: chromadb-mcp
    environment:
      - CHROMA_CLIENT_TYPE=${CHROMA_CLIENT_TYPE:-http}
      - CHROMA_HOST=${CHROMA_HOST:-chromadb}
      - CHROMA_PORT=${CHROMA_PORT:-8000}
      - CHROMA_SSL=${CHROMA_SSL:-false}
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    entrypoint: ["sleep", "infinity"]
    depends_on:
      - chromadb
    restart: unless-stopped
  llmctl-mcp:
    image: llmctl-mcp:latest
    build:
      context: ..
      dockerfile: app/llmctl-mcp/docker/llmctl-mcp.Dockerfile
    container_name: llmctl-mcp
    environment:
      - LLMCTL_MCP_HOST=0.0.0.0
      - LLMCTL_MCP_PORT=${LLMCTL_MCP_PORT:-9020}
      - LLMCTL_MCP_PATH=${LLMCTL_MCP_PATH:-/mcp}
      - LLMCTL_MCP_TRANSPORT=${LLMCTL_MCP_TRANSPORT:-stdio}
      - LLMCTL_STUDIO_DATA_DIR=/app/data
      - CELERY_REDIS_HOST=${CELERY_REDIS_HOST:-llmctl-redis}
      - CELERY_REDIS_PORT=${CELERY_REDIS_PORT:-6380}
      - CELERY_REDIS_BROKER_DB=${CELERY_REDIS_BROKER_DB:-0}
      - CELERY_REDIS_BACKEND_DB=${CELERY_REDIS_BACKEND_DB:-1}
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    entrypoint: ["sleep", "infinity"]
    volumes:
      - ../data:/app/data
      - ../app/llmctl-mcp:/app/app/llmctl-mcp
      - ../app/llmctl-studio/src:/app/app/llmctl-studio/src
    restart: unless-stopped
  chromadb:
    image: chromadb/chroma:latest
    container_name: chromadb
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "${CHROMA_HOST_PORT:-8000}:8000"
    volumes:
      - chroma_data:/chroma/chroma
    restart: unless-stopped
  llmctl-rag:
    build:
      context: ..
      dockerfile: app/llmctl-rag/docker/llmctl-rag.Dockerfile
    container_name: llmctl-rag
    environment:
      - CHROMA_HOST=${CHROMA_HOST:-}
      - CHROMA_PORT=${CHROMA_PORT:-}
      - CHROMA_COLLECTION=${CHROMA_COLLECTION:-}
      - RAG_EMBED_PROVIDER=${RAG_EMBED_PROVIDER:-}
      - RAG_CHAT_PROVIDER=${RAG_CHAT_PROVIDER:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_EMBED_MODEL=${OPENAI_EMBED_MODEL:-}
      - RAG_EMBED_MAX_TOKENS_PER_REQUEST=${RAG_EMBED_MAX_TOKENS_PER_REQUEST:-120000}
      - RAG_EMBED_TARGET_TOKENS_PER_MINUTE=${RAG_EMBED_TARGET_TOKENS_PER_MINUTE:-250000}
      - RAG_EMBED_MIN_REQUEST_INTERVAL_S=${RAG_EMBED_MIN_REQUEST_INTERVAL_S:-0.75}
      - RAG_EMBED_RATE_LIMIT_MAX_RETRIES=${RAG_EMBED_RATE_LIMIT_MAX_RETRIES:-8}
      - OPENAI_CHAT_MODEL=${OPENAI_CHAT_MODEL:-}
      - OPENAI_CHAT_TEMPERATURE=${OPENAI_CHAT_TEMPERATURE:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GEMINI_EMBED_MODEL=${GEMINI_EMBED_MODEL:-}
      - GEMINI_CHAT_MODEL=${GEMINI_CHAT_MODEL:-}
      - RAG_CHAT_TEMPERATURE=${RAG_CHAT_TEMPERATURE:-}
      - RAG_CHAT_RESPONSE_STYLE=${RAG_CHAT_RESPONSE_STYLE:-}
      - RAG_DRIVE_SYNC_WORKERS=${RAG_DRIVE_SYNC_WORKERS:-4}
      - RAG_INDEX_PARALLEL_WORKERS=${RAG_INDEX_PARALLEL_WORKERS:-1}
      - RAG_PDF_PAGE_WORKERS=${RAG_PDF_PAGE_WORKERS:-1}
      - RAG_EMBED_PARALLEL_REQUESTS=${RAG_EMBED_PARALLEL_REQUESTS:-6}
      - CELERY_REDIS_HOST=${CELERY_REDIS_HOST:-llmctl-redis}
      - CELERY_REDIS_PORT=${CELERY_REDIS_PORT:-6380}
      - CELERY_REDIS_BROKER_DB=${CELERY_REDIS_BROKER_DB:-0}
      - CELERY_REDIS_BACKEND_DB=${CELERY_REDIS_BACKEND_DB:-1}
      - CELERY_WORKER_CONCURRENCY=${CELERY_WORKER_CONCURRENCY:-6}
      - CELERY_WORKER_QUEUES=${CELERY_WORKER_QUEUES:-llmctl_rag,llmctl_rag_index,llmctl_rag_drive,llmctl_rag_git}
      - LLMCTL_RAG_CELERY_BROKER_URL=redis://${CELERY_REDIS_HOST:-llmctl-redis}:${CELERY_REDIS_PORT:-6380}/${CELERY_REDIS_BROKER_DB:-0}
      - LLMCTL_RAG_CELERY_RESULT_BACKEND=redis://${CELERY_REDIS_HOST:-llmctl-redis}:${CELERY_REDIS_PORT:-6380}/${CELERY_REDIS_BACKEND_DB:-1}
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "5050:5050"
    volumes:
      - ../app/llmctl-rag:/app/app/llmctl-rag
      - ../data/llmctl-rag:/data/llmctl-rag
      - ../example:/example:ro
    depends_on:
      - chromadb
    restart: unless-stopped
  llmctl-studio:
    image: llmctl-studio:latest
    build:
      context: ..
      dockerfile: app/llmctl-studio/docker/Dockerfile
      args:
        APP_UID: ${APP_UID:-1000}
        APP_GID: ${APP_GID:-1000}
        DOCKER_GID: ${DOCKER_GID:-999}
    container_name: llmctl-studio
    environment:
      - CELERY_REDIS_HOST=${CELERY_REDIS_HOST:-llmctl-redis}
      - CELERY_REDIS_PORT=${CELERY_REDIS_PORT:-6380}
      - CELERY_REDIS_BROKER_DB=${CELERY_REDIS_BROKER_DB:-0}
      - CELERY_REDIS_BACKEND_DB=${CELERY_REDIS_BACKEND_DB:-1}
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "5055:5055"
    volumes:
      - ../app/llmctl-studio/run.py:/app/app/llmctl-studio/run.py
      - ../app/llmctl-studio/src:/app/app/llmctl-studio/src
      - ../data:/app/data
      - ${HOME}/.gitconfig:/home/llmctl-studio/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    environment:
      - DOZZLE_NO_ANALYTICS=true
    ports:
      - "18080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
volumes:
  chroma_data:
