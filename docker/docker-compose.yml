services:
  # Database services
  llmctl-redis:
    image: redis:7.2-alpine
    command: ["redis-server", "--appendonly", "yes", "--port", "6380"]
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "6380:6380"

  llmctl-chromadb:
    image: chromadb/chroma:latest
    container_name: llmctl-chromadb
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "${CHROMA_HOST_PORT:-8000}:8000"
    networks:
      default:
        aliases:
          - chromadb
    volumes:
      - chroma_data:/chroma/chroma
    restart: unless-stopped

  # App services
  llmctl-rag:
    build:
      context: ..
      dockerfile: app/llmctl-rag/docker/llmctl-rag.Dockerfile
    container_name: llmctl-rag
    environment:
      - CHROMA_HOST=${CHROMA_HOST:-}
      - CHROMA_PORT=${CHROMA_PORT:-}
      - CHROMA_COLLECTION=${CHROMA_COLLECTION:-}
      - RAG_EMBED_PROVIDER=${RAG_EMBED_PROVIDER:-}
      - RAG_CHAT_PROVIDER=${RAG_CHAT_PROVIDER:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_EMBED_MODEL=${OPENAI_EMBED_MODEL:-}
      - RAG_EMBED_MAX_TOKENS_PER_REQUEST=${RAG_EMBED_MAX_TOKENS_PER_REQUEST:-120000}
      - RAG_EMBED_TARGET_TOKENS_PER_MINUTE=${RAG_EMBED_TARGET_TOKENS_PER_MINUTE:-250000}
      - RAG_EMBED_MIN_REQUEST_INTERVAL_S=${RAG_EMBED_MIN_REQUEST_INTERVAL_S:-0.75}
      - RAG_EMBED_RATE_LIMIT_MAX_RETRIES=${RAG_EMBED_RATE_LIMIT_MAX_RETRIES:-8}
      - OPENAI_CHAT_MODEL=${OPENAI_CHAT_MODEL:-}
      - OPENAI_CHAT_TEMPERATURE=${OPENAI_CHAT_TEMPERATURE:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GEMINI_EMBED_MODEL=${GEMINI_EMBED_MODEL:-}
      - GEMINI_CHAT_MODEL=${GEMINI_CHAT_MODEL:-}
      - RAG_CHAT_TEMPERATURE=${RAG_CHAT_TEMPERATURE:-}
      - RAG_CHAT_RESPONSE_STYLE=${RAG_CHAT_RESPONSE_STYLE:-}
      - RAG_DRIVE_SYNC_WORKERS=${RAG_DRIVE_SYNC_WORKERS:-4}
      - RAG_INDEX_PARALLEL_WORKERS=${RAG_INDEX_PARALLEL_WORKERS:-1}
      - RAG_PDF_PAGE_WORKERS=${RAG_PDF_PAGE_WORKERS:-1}
      - RAG_EMBED_PARALLEL_REQUESTS=${RAG_EMBED_PARALLEL_REQUESTS:-6}
      - CELERY_REDIS_HOST=${CELERY_REDIS_HOST:-llmctl-redis}
      - CELERY_REDIS_PORT=${CELERY_REDIS_PORT:-6380}
      - CELERY_REDIS_BROKER_DB=${CELERY_REDIS_BROKER_DB:-0}
      - CELERY_REDIS_BACKEND_DB=${CELERY_REDIS_BACKEND_DB:-1}
      - CELERY_WORKER_CONCURRENCY=${CELERY_WORKER_CONCURRENCY:-6}
      - CELERY_WORKER_QUEUES=${CELERY_WORKER_QUEUES:-llmctl_rag,llmctl_rag_index,llmctl_rag_drive,llmctl_rag_git}
      - LLMCTL_RAG_CELERY_BROKER_URL=redis://${CELERY_REDIS_HOST:-llmctl-redis}:${CELERY_REDIS_PORT:-6380}/${CELERY_REDIS_BROKER_DB:-0}
      - LLMCTL_RAG_CELERY_RESULT_BACKEND=redis://${CELERY_REDIS_HOST:-llmctl-redis}:${CELERY_REDIS_PORT:-6380}/${CELERY_REDIS_BACKEND_DB:-1}
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "5050:5050"
    volumes:
      - ../app/llmctl-rag:/app/app/llmctl-rag
      - ../data/llmctl-rag:/data/llmctl-rag
      - ../example:/example:ro
    depends_on:
      - llmctl-chromadb
    restart: unless-stopped

  llmctl-studio:
    image: llmctl-studio:latest
    build:
      context: ..
      dockerfile: app/llmctl-studio/docker/Dockerfile
      args:
        APP_UID: ${APP_UID:-1000}
        APP_GID: ${APP_GID:-1000}
        DOCKER_GID: ${DOCKER_GID:-999}
        INSTALL_VLLM: ${INSTALL_VLLM:-true}
    container_name: llmctl-studio
    environment:
      - CELERY_REDIS_HOST=${CELERY_REDIS_HOST:-llmctl-redis}
      - CELERY_REDIS_PORT=${CELERY_REDIS_PORT:-6380}
      - CELERY_REDIS_BROKER_DB=${CELERY_REDIS_BROKER_DB:-0}
      - CELERY_REDIS_BACKEND_DB=${CELERY_REDIS_BACKEND_DB:-1}
      - CHROMA_HOST=${CHROMA_HOST:-}
      - CHROMA_PORT=${CHROMA_PORT:-}
      - CHROMA_SSL=${CHROMA_SSL:-false}
      - LLMCTL_STUDIO_VLLM_LOCAL_CUSTOM_MODELS_DIR=${LLMCTL_STUDIO_VLLM_LOCAL_CUSTOM_MODELS_DIR:-/app/models/custom}
      - VLLM_LOCAL_FALLBACK_MODEL=${VLLM_LOCAL_FALLBACK_MODEL:-/app/models/custom/qwen2.5-0.5b-instruct}
      - VLLM_LOCAL_CMD=${VLLM_LOCAL_CMD:-vllm}
      - VLLM_REMOTE_BASE_URL=${VLLM_REMOTE_BASE_URL:-}
    gpus: all
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "5055:5055"
    volumes:
      - ../app/llmctl-studio/run.py:/app/app/llmctl-studio/run.py
      - ../app/llmctl-studio/src:/app/app/llmctl-studio/src
      - ../app/llmctl-mcp:/app/app/llmctl-mcp
      - ../data:/app/data
      - ${LLMCTL_VLLM_MODELS_DIR:-../models}:/app/models/custom
      - ${HOME}/.gitconfig:/home/llmctl-studio/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock

  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    environment:
      - DOZZLE_NO_ANALYTICS=true
    ports:
      - "18080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped

volumes:
  chroma_data:
