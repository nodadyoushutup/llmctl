services:
  # Database services
  llmctl-redis:
    image: redis:7.2-alpine
    command: ["redis-server", "--appendonly", "yes", "--port", "6380"]
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "6380:6380"

  llmctl-postgres:
    image: postgres:16-alpine
    container_name: llmctl-postgres
    environment:
      - POSTGRES_DB=${LLMCTL_POSTGRES_DB:-llmctl_studio}
      - POSTGRES_USER=${LLMCTL_POSTGRES_USER:-llmctl}
      - POSTGRES_PASSWORD=${LLMCTL_POSTGRES_PASSWORD:-llmctl}
    ports:
      - "${LLMCTL_POSTGRES_HOST_PORT:-15432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U ${LLMCTL_POSTGRES_USER:-llmctl} -d ${LLMCTL_POSTGRES_DB:-llmctl_studio}
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  llmctl-chromadb:
    image: chromadb/chroma:latest
    container_name: llmctl-chromadb
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "${CHROMA_HOST_PORT:-8000}:8000"
    networks:
      default:
        aliases:
          - chromadb
    volumes:
      - chroma_data:/chroma/chroma
    restart: unless-stopped

  # App services
  llmctl-rag:
    build:
      context: ..
      dockerfile: app/llmctl-rag/docker/llmctl-rag.Dockerfile
    container_name: llmctl-rag
    environment:
      - CHROMA_HOST=${CHROMA_HOST:-}
      - CHROMA_PORT=${CHROMA_PORT:-}
      - CHROMA_COLLECTION=${CHROMA_COLLECTION:-}
      - RAG_EMBED_PROVIDER=${RAG_EMBED_PROVIDER:-}
      - RAG_CHAT_PROVIDER=${RAG_CHAT_PROVIDER:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_EMBED_MODEL=${OPENAI_EMBED_MODEL:-}
      - RAG_EMBED_MAX_TOKENS_PER_REQUEST=${RAG_EMBED_MAX_TOKENS_PER_REQUEST:-120000}
      - RAG_EMBED_TARGET_TOKENS_PER_MINUTE=${RAG_EMBED_TARGET_TOKENS_PER_MINUTE:-250000}
      - RAG_EMBED_MIN_REQUEST_INTERVAL_S=${RAG_EMBED_MIN_REQUEST_INTERVAL_S:-0.75}
      - RAG_EMBED_RATE_LIMIT_MAX_RETRIES=${RAG_EMBED_RATE_LIMIT_MAX_RETRIES:-8}
      - OPENAI_CHAT_MODEL=${OPENAI_CHAT_MODEL:-}
      - OPENAI_CHAT_TEMPERATURE=${OPENAI_CHAT_TEMPERATURE:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GEMINI_EMBED_MODEL=${GEMINI_EMBED_MODEL:-}
      - GEMINI_CHAT_MODEL=${GEMINI_CHAT_MODEL:-}
      - RAG_CHAT_TEMPERATURE=${RAG_CHAT_TEMPERATURE:-}
      - RAG_CHAT_RESPONSE_STYLE=${RAG_CHAT_RESPONSE_STYLE:-}
      - RAG_DRIVE_SYNC_WORKERS=${RAG_DRIVE_SYNC_WORKERS:-4}
      - RAG_INDEX_PARALLEL_WORKERS=${RAG_INDEX_PARALLEL_WORKERS:-1}
      - RAG_PDF_PAGE_WORKERS=${RAG_PDF_PAGE_WORKERS:-1}
      - RAG_EMBED_PARALLEL_REQUESTS=${RAG_EMBED_PARALLEL_REQUESTS:-6}
      - CELERY_REDIS_HOST=${CELERY_REDIS_HOST:-llmctl-redis}
      - CELERY_REDIS_PORT=${CELERY_REDIS_PORT:-6380}
      - CELERY_REDIS_BROKER_DB=${CELERY_REDIS_BROKER_DB:-0}
      - CELERY_REDIS_BACKEND_DB=${CELERY_REDIS_BACKEND_DB:-1}
      - CELERY_WORKER_CONCURRENCY=${CELERY_WORKER_CONCURRENCY:-6}
      - CELERY_WORKER_QUEUES=${CELERY_WORKER_QUEUES:-llmctl_rag,llmctl_rag_index,llmctl_rag_drive,llmctl_rag_git}
      - FLASK_DEBUG=${FLASK_DEBUG:-false}
      - LLMCTL_RAG_CELERY_BROKER_URL=redis://${CELERY_REDIS_HOST:-llmctl-redis}:${CELERY_REDIS_PORT:-6380}/${CELERY_REDIS_BROKER_DB:-0}
      - LLMCTL_RAG_CELERY_RESULT_BACKEND=redis://${CELERY_REDIS_HOST:-llmctl-redis}:${CELERY_REDIS_PORT:-6380}/${CELERY_REDIS_BACKEND_DB:-1}
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "5050:5050"
    volumes:
      - ../app/llmctl-rag:/app/app/llmctl-rag
      - ../data/llmctl-rag:/data/llmctl-rag
      - ../example:/example:ro
    depends_on:
      - llmctl-chromadb
    restart: unless-stopped

  llmctl-studio:
    image: llmctl-studio:latest
    build:
      context: ..
      dockerfile: app/llmctl-studio/docker/Dockerfile
      args:
        APP_UID: ${APP_UID:-1000}
        APP_GID: ${APP_GID:-1000}
        DOCKER_GID: ${DOCKER_GID:-999}
        INSTALL_VLLM: ${INSTALL_VLLM:-true}
        INSTALL_CLAUDE: ${INSTALL_CLAUDE:-true}
    container_name: llmctl-studio
    user: "${LLMCTL_STUDIO_RUN_USER:-1000:1000}"
    environment:
      - CELERY_REDIS_HOST=${CELERY_REDIS_HOST:-llmctl-redis}
      - CELERY_REDIS_PORT=${CELERY_REDIS_PORT:-6380}
      - CELERY_REDIS_BROKER_DB=${CELERY_REDIS_BROKER_DB:-0}
      - CELERY_REDIS_BACKEND_DB=${CELERY_REDIS_BACKEND_DB:-1}
      - LLMCTL_POSTGRES_HOST=${LLMCTL_POSTGRES_HOST:-llmctl-postgres}
      - LLMCTL_POSTGRES_PORT=${LLMCTL_POSTGRES_PORT:-5432}
      - LLMCTL_POSTGRES_DB=${LLMCTL_POSTGRES_DB:-llmctl_studio}
      - LLMCTL_POSTGRES_USER=${LLMCTL_POSTGRES_USER:-llmctl}
      - LLMCTL_POSTGRES_PASSWORD=${LLMCTL_POSTGRES_PASSWORD:-llmctl}
      - LLMCTL_STUDIO_DATABASE_URI=${LLMCTL_STUDIO_DATABASE_URI:-}
      - CHROMA_HOST=${CHROMA_HOST:-}
      - CHROMA_PORT=${CHROMA_PORT:-}
      - CHROMA_SSL=${CHROMA_SSL:-false}
      - CHAT_RAG_CONTRACT_BASE_URL=${CHAT_RAG_CONTRACT_BASE_URL:-http://127.0.0.1:5055}
      - LLMCTL_STUDIO_VLLM_LOCAL_CUSTOM_MODELS_DIR=${LLMCTL_STUDIO_VLLM_LOCAL_CUSTOM_MODELS_DIR:-/app/data/models}
      - VLLM_LOCAL_FALLBACK_MODEL=${VLLM_LOCAL_FALLBACK_MODEL:-}
      - VLLM_LOCAL_CMD=${VLLM_LOCAL_CMD:-vllm}
      - VLLM_REMOTE_BASE_URL=${VLLM_REMOTE_BASE_URL:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CLAUDE_CLI_AUTO_INSTALL=${CLAUDE_CLI_AUTO_INSTALL:-false}
      - CLAUDE_CLI_REQUIRE_READY=${CLAUDE_CLI_REQUIRE_READY:-true}
      - CLAUDE_CLI_INSTALL_SCRIPT=${CLAUDE_CLI_INSTALL_SCRIPT:-scripts/install/install-claude-cli.sh}
      - CLAUDE_AUTH_REQUIRE_API_KEY=${CLAUDE_AUTH_REQUIRE_API_KEY:-true}
      - FLASK_DEBUG=${FLASK_DEBUG:-false}
      - FLASK_HOST=${FLASK_HOST:-0.0.0.0}
      - FLASK_PORT=${FLASK_PORT:-5055}
      - LLMCTL_STUDIO_PREFERRED_URL_SCHEME=${LLMCTL_STUDIO_PREFERRED_URL_SCHEME:-http}
      - LLMCTL_STUDIO_PROXY_FIX_ENABLED=${LLMCTL_STUDIO_PROXY_FIX_ENABLED:-true}
      - LLMCTL_STUDIO_PROXY_FIX_X_FOR=${LLMCTL_STUDIO_PROXY_FIX_X_FOR:-1}
      - LLMCTL_STUDIO_PROXY_FIX_X_PROTO=${LLMCTL_STUDIO_PROXY_FIX_X_PROTO:-1}
      - LLMCTL_STUDIO_PROXY_FIX_X_HOST=${LLMCTL_STUDIO_PROXY_FIX_X_HOST:-1}
      - LLMCTL_STUDIO_PROXY_FIX_X_PORT=${LLMCTL_STUDIO_PROXY_FIX_X_PORT:-1}
      - LLMCTL_STUDIO_PROXY_FIX_X_PREFIX=${LLMCTL_STUDIO_PROXY_FIX_X_PREFIX:-1}
      - LLMCTL_STUDIO_SOCKETIO_REDIS_DB=${LLMCTL_STUDIO_SOCKETIO_REDIS_DB:-0}
      - LLMCTL_STUDIO_SOCKETIO_MESSAGE_QUEUE=${LLMCTL_STUDIO_SOCKETIO_MESSAGE_QUEUE:-redis://${CELERY_REDIS_HOST:-llmctl-redis}:${CELERY_REDIS_PORT:-6380}/${LLMCTL_STUDIO_SOCKETIO_REDIS_DB:-0}}
      - LLMCTL_STUDIO_SOCKETIO_ASYNC_MODE=${LLMCTL_STUDIO_SOCKETIO_ASYNC_MODE:-threading}
      - LLMCTL_STUDIO_SOCKETIO_PATH=${LLMCTL_STUDIO_SOCKETIO_PATH:-socket.io}
      - LLMCTL_STUDIO_SOCKETIO_CORS_ALLOWED_ORIGINS=${LLMCTL_STUDIO_SOCKETIO_CORS_ALLOWED_ORIGINS:-*}
      - LLMCTL_STUDIO_SOCKETIO_TRANSPORTS=${LLMCTL_STUDIO_SOCKETIO_TRANSPORTS:-websocket,polling}
      - LLMCTL_STUDIO_SOCKETIO_PING_INTERVAL=${LLMCTL_STUDIO_SOCKETIO_PING_INTERVAL:-25}
      - LLMCTL_STUDIO_SOCKETIO_PING_TIMEOUT=${LLMCTL_STUDIO_SOCKETIO_PING_TIMEOUT:-60}
      - LLMCTL_STUDIO_SOCKETIO_MONITOR_CLIENTS=${LLMCTL_STUDIO_SOCKETIO_MONITOR_CLIENTS:-true}
      - LLMCTL_STUDIO_SOCKETIO_LOGGER=${LLMCTL_STUDIO_SOCKETIO_LOGGER:-false}
      - LLMCTL_STUDIO_SOCKETIO_ENGINEIO_LOGGER=${LLMCTL_STUDIO_SOCKETIO_ENGINEIO_LOGGER:-false}
      - LLMCTL_STUDIO_USE_GUNICORN=${LLMCTL_STUDIO_USE_GUNICORN:-true}
      - GUNICORN_BIND=${GUNICORN_BIND:-0.0.0.0:5055}
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
      - GUNICORN_THREADS=${GUNICORN_THREADS:-4}
      - GUNICORN_WORKER_CLASS=${GUNICORN_WORKER_CLASS:-gthread}
      - GUNICORN_WORKER_CONNECTIONS=${GUNICORN_WORKER_CONNECTIONS:-1000}
      - GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT:-120}
      - GUNICORN_GRACEFUL_TIMEOUT=${GUNICORN_GRACEFUL_TIMEOUT:-30}
      - GUNICORN_KEEPALIVE=${GUNICORN_KEEPALIVE:-5}
      - GUNICORN_LOG_LEVEL=${GUNICORN_LOG_LEVEL:-info}
      - GUNICORN_ACCESS_LOG=${GUNICORN_ACCESS_LOG:--}
      - GUNICORN_ERROR_LOG=${GUNICORN_ERROR_LOG:--}
      - GUNICORN_MAX_REQUESTS=${GUNICORN_MAX_REQUESTS:-1000}
      - GUNICORN_MAX_REQUESTS_JITTER=${GUNICORN_MAX_REQUESTS_JITTER:-100}
      - GUNICORN_CERTFILE=${GUNICORN_CERTFILE:-}
      - GUNICORN_KEYFILE=${GUNICORN_KEYFILE:-}
      - GUNICORN_CA_CERTS=${GUNICORN_CA_CERTS:-}
    gpus: all
    dns:
      - 192.168.1.1
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "5055:5055"
    depends_on:
      llmctl-postgres:
        condition: service_healthy
    volumes:
      - ../app/llmctl-studio/run.py:/app/app/llmctl-studio/run.py
      - ../app/llmctl-studio/src:/app/app/llmctl-studio/src
      - ../app/llmctl-mcp:/app/app/llmctl-mcp
      - ../data:/app/data
      - ${HOME}/.gitconfig:/home/llmctl-studio/.gitconfig:ro
      - /var/run/docker.sock:/var/run/docker.sock

  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    environment:
      - DOZZLE_NO_ANALYTICS=true
    ports:
      - "18080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped

  # Harbor bootstrap registry profile.
  # This gives us a local "remote" OCI registry endpoint now; full Harbor services can be layered later.
  llmctl-harbor-registry:
    profiles: ["harbor"]
    image: registry:2.8.3
    container_name: llmctl-harbor-registry
    environment:
      - REGISTRY_HTTP_ADDR=0.0.0.0:${HARBOR_REGISTRY_CONTAINER_PORT:-5000}
      - REGISTRY_STORAGE_DELETE_ENABLED=true
      - REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=/var/lib/registry
    ports:
      - "${HARBOR_REGISTRY_HOST_PORT:-15000}:${HARBOR_REGISTRY_CONTAINER_PORT:-5000}"
    volumes:
      - harbor_registry_data:/var/lib/registry
    restart: unless-stopped

volumes:
  chroma_data:
  postgres_data:
  harbor_registry_data:
