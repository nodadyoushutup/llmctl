

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>core.db &mdash; llmctl technical API documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            llmctl
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Runtime Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chat_runtime.html">Launch Chat Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../provider_runtime.html">Provider Runtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rag_flowchart_node.html">RAG Flowchart Node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">Studio API Packages</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">llmctl</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">core.db</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for core.db</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">text</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">sessionmaker</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">storage.script_storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">write_script_file</span>

<span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">SessionLocal</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">NODE_EXECUTOR_PROVIDER_ALLOWED_VALUES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;workspace&quot;</span><span class="p">,</span> <span class="s2">&quot;docker&quot;</span><span class="p">,</span> <span class="s2">&quot;kubernetes&quot;</span><span class="p">)</span>
<span class="n">NODE_EXECUTOR_DISPATCH_STATUS_ALLOWED_VALUES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;dispatch_pending&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dispatch_submitted&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dispatch_confirmed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dispatch_failed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fallback_started&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">NODE_EXECUTOR_FALLBACK_REASON_ALLOWED_VALUES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;provider_unavailable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;preflight_failed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dispatch_timeout&quot;</span><span class="p">,</span>
    <span class="s2">&quot;create_failed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;image_pull_failed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;config_error&quot;</span><span class="p">,</span>
    <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">NODE_EXECUTOR_API_FAILURE_CATEGORY_ALLOWED_VALUES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;socket_missing&quot;</span><span class="p">,</span>
    <span class="s2">&quot;socket_unreachable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;api_unreachable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;auth_error&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tls_error&quot;</span><span class="p">,</span>
    <span class="s2">&quot;timeout&quot;</span><span class="p">,</span>
    <span class="s2">&quot;preflight_failed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">NODE_EXECUTOR_AGENT_TASK_CHECKS</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_selected_provider_allowed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;selected_provider IN (&#39;workspace&#39;,&#39;docker&#39;,&#39;kubernetes&#39;)&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_final_provider_allowed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;final_provider IN (&#39;workspace&#39;,&#39;docker&#39;,&#39;kubernetes&#39;)&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_dispatch_status_allowed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dispatch_status IN (&#39;dispatch_pending&#39;,&#39;dispatch_submitted&#39;,&#39;dispatch_confirmed&#39;,&#39;dispatch_failed&#39;,&#39;fallback_started&#39;)&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_provider_dispatch_required&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dispatch_status NOT IN (&#39;dispatch_submitted&#39;,&#39;dispatch_confirmed&#39;) OR provider_dispatch_id IS NOT NULL&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_provider_dispatch_namespace&quot;</span><span class="p">,</span>
        <span class="s2">&quot;provider_dispatch_id IS NULL &quot;</span>
        <span class="s2">&quot;OR provider_dispatch_id LIKE &#39;workspace:%&#39; &quot;</span>
        <span class="s2">&quot;OR provider_dispatch_id LIKE &#39;docker:%&#39; &quot;</span>
        <span class="s2">&quot;OR provider_dispatch_id LIKE &#39;kubernetes:%&#39;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_cli_preflight_requires_fallback&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cli_fallback_used = 1 OR cli_preflight_passed IS NULL&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_fallback_reason_required&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dispatch_status != &#39;fallback_started&#39; OR fallback_reason IS NOT NULL&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_fallback_reason_consistency&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fallback_attempted = 1 OR fallback_reason IS NULL&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_uncertain_no_fallback&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dispatch_uncertain = 0 OR (fallback_attempted = 0 AND fallback_reason IS NULL)&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_fallback_terminal_provider&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fallback_attempted = 0 OR final_provider = &#39;workspace&#39;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_fallback_reason_allowed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fallback_reason IS NULL OR fallback_reason IN (&#39;provider_unavailable&#39;,&#39;preflight_failed&#39;,&#39;dispatch_timeout&#39;,&#39;create_failed&#39;,&#39;image_pull_failed&#39;,&#39;config_error&#39;,&#39;unknown&#39;)&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_api_failure_category_allowed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;api_failure_category IS NULL OR api_failure_category IN (&#39;socket_missing&#39;,&#39;socket_unreachable&#39;,&#39;api_unreachable&#39;,&#39;auth_error&#39;,&#39;tls_error&#39;,&#39;timeout&#39;,&#39;preflight_failed&#39;,&#39;unknown&#39;)&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span>
        <span class="s2">&quot;ck_node_runs_workspace_identity_format&quot;</span><span class="p">,</span>
        <span class="s2">&quot;workspace_identity IS NOT NULL AND TRIM(workspace_identity) != &#39;&#39; &quot;</span>
        <span class="s2">&quot;AND workspace_identity NOT LIKE &#39;%/%&#39; &quot;</span>
        <span class="s2">&quot;AND workspace_identity NOT LIKE &#39;%</span><span class="se">\\\\</span><span class="s2">%&#39; &quot;</span>
        <span class="s2">&quot;AND workspace_identity NOT LIKE &#39;%://%&#39;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>


<div class="viewcode-block" id="utcnow">
<a class="viewcode-back" href="../../api/core.db.html#core.db.utcnow">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">utcnow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span></div>



<div class="viewcode-block" id="Base">
<a class="viewcode-back" href="../../api/core.db.html#core.db.Base">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="BaseModel">
<a class="viewcode-back" href="../../api/core.db.html#core.db.BaseModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseModel</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__abstract__</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="BaseModel.get">
<a class="viewcode-back" href="../../api/core.db.html#core.db.BaseModel.get">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">item_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">item_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.list">
<a class="viewcode-back" href="../../api/core.db.html#core.db.BaseModel.list">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseModel.create">
<a class="viewcode-back" href="../../api/core.db.html#core.db.BaseModel.create">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">instance</span></div>


<div class="viewcode-block" id="BaseModel.save">
<a class="viewcode-back" href="../../api/core.db.html#core.db.BaseModel.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="BaseModel.delete">
<a class="viewcode-back" href="../../api/core.db.html#core.db.BaseModel.delete">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="init_engine">
<a class="viewcode-back" href="../../api/core.db.html#core.db.init_engine">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_engine</span><span class="p">(</span><span class="n">database_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_engine</span><span class="p">,</span> <span class="n">SessionLocal</span>
    <span class="k">if</span> <span class="n">_engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
            <span class="n">database_uri</span><span class="p">,</span>
            <span class="n">connect_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;check_same_thread&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="n">future</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">SessionLocal</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">_engine</span><span class="p">,</span> <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="n">Session</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_engine</span></div>



<div class="viewcode-block" id="init_db">
<a class="viewcode-back" href="../../api/core.db.html#core.db.init_db">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_db</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database engine is not initialized&quot;</span><span class="p">)</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">_engine</span><span class="p">)</span>
    <span class="n">_ensure_schema</span><span class="p">()</span></div>



<div class="viewcode-block" id="create_session">
<a class="viewcode-back" href="../../api/core.db.html#core.db.create_session">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_session</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Session</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">SessionLocal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database session is not initialized&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SessionLocal</span><span class="p">()</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_schema</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">with</span> <span class="n">_engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
        <span class="n">_migrate_roles_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">role_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;details_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;is_system&quot;</span><span class="p">:</span> <span class="s2">&quot;BOOLEAN NOT NULL DEFAULT 0&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;roles&quot;</span><span class="p">,</span> <span class="n">role_columns</span><span class="p">)</span>
        <span class="n">_migrate_role_payloads</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_drop_role_prompt_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">agent_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;autonomous_prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;role_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;is_system&quot;</span><span class="p">:</span> <span class="s2">&quot;BOOLEAN NOT NULL DEFAULT 0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_run_task_id&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;run_max_loops&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;run_end_requested&quot;</span><span class="p">:</span> <span class="s2">&quot;BOOLEAN NOT NULL DEFAULT 0&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;agents&quot;</span><span class="p">,</span> <span class="n">agent_columns</span><span class="p">)</span>
        <span class="n">_migrate_agent_descriptions</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_migrate_agent_status_column</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_drop_agent_is_active_column</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_ensure_agent_priority_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_drop_run_is_active_column</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">run_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;runs&quot;</span><span class="p">,</span> <span class="n">run_columns</span><span class="p">)</span>

        <span class="n">script_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;scripts&quot;</span><span class="p">,</span> <span class="n">script_columns</span><span class="p">)</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;agent_task_scripts&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">})</span>
        <span class="n">_migrate_script_storage</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_migrate_script_positions</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

        <span class="n">task_template_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;task_templates&quot;</span><span class="p">,</span> <span class="n">task_template_columns</span><span class="p">)</span>

        <span class="n">mcp_server_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;server_type&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT NOT NULL DEFAULT &#39;custom&#39;&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;mcp_servers&quot;</span><span class="p">,</span> <span class="n">mcp_server_columns</span><span class="p">)</span>

        <span class="n">flowchart_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(512)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_node_executions&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_runtime_minutes&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_parallel_nodes&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL DEFAULT 1&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;flowcharts&quot;</span><span class="p">,</span> <span class="n">flowchart_columns</span><span class="p">)</span>

        <span class="n">flowchart_node_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;node_type&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT NOT NULL DEFAULT &#39;task&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ref_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(255)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;FLOAT NOT NULL DEFAULT 0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;FLOAT NOT NULL DEFAULT 0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;config_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;flowchart_nodes&quot;</span><span class="p">,</span> <span class="n">flowchart_node_columns</span><span class="p">)</span>

        <span class="n">flowchart_edge_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;source_handle_id&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;target_handle_id&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;edge_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(16) NOT NULL DEFAULT &#39;solid&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;condition_key&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(255)&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;flowchart_edges&quot;</span><span class="p">,</span> <span class="n">flowchart_edge_columns</span><span class="p">)</span>
        <span class="n">_migrate_flowchart_edge_modes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

        <span class="n">flowchart_run_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;celery_task_id&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(255)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32) NOT NULL DEFAULT &#39;queued&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;started_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span>
            <span class="s2">&quot;finished_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;flowchart_runs&quot;</span><span class="p">,</span> <span class="n">flowchart_run_columns</span><span class="p">)</span>

        <span class="n">flowchart_run_node_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;execution_index&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL DEFAULT 1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;agent_task_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32) NOT NULL DEFAULT &#39;queued&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;input_context_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;output_state_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;routing_state_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_skill_ids_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_skill_versions_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_skill_manifest_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;skill_adapter_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_role_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_role_version&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_agent_version&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_instruction_manifest_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;instruction_adapter_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;instruction_materialized_paths_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;started_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span>
            <span class="s2">&quot;finished_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;flowchart_run_nodes&quot;</span><span class="p">,</span> <span class="n">flowchart_run_node_columns</span><span class="p">)</span>

        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;task_template_scripts&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">})</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;flowchart_node_scripts&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">})</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;flowchart_node_skills&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">})</span>
        <span class="n">_ensure_flowchart_node_attachment_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_ensure_agent_skill_binding_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_migrate_flowchart_node_skills_to_agent_bindings</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

        <span class="n">milestone_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT NOT NULL DEFAULT &#39;planned&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT NOT NULL DEFAULT &#39;medium&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_date&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span>
            <span class="s2">&quot;progress_percent&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL DEFAULT 0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;health&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT NOT NULL DEFAULT &#39;green&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;success_criteria&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;links&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latest_update&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;milestones&quot;</span><span class="p">,</span> <span class="n">milestone_columns</span><span class="p">)</span>
        <span class="n">_migrate_milestone_status</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

        <span class="n">existing_agent_task_columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;agent_tasks&quot;</span><span class="p">)</span>
        <span class="n">task_columns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;run_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;task_template_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flowchart_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flowchart_run_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flowchart_node_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;integration_keys_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;current_stage&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stage_logs&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_role_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_role_version&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_agent_version&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_skill_ids_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_skill_versions_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_skill_manifest_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;skill_adapter_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolved_instruction_manifest_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;instruction_adapter_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;instruction_materialized_paths_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;selected_provider&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT NOT NULL DEFAULT &#39;workspace&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;final_provider&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT NOT NULL DEFAULT &#39;workspace&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;provider_dispatch_id&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;workspace_identity&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT NOT NULL DEFAULT &#39;default&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dispatch_status&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT NOT NULL DEFAULT &#39;dispatch_pending&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fallback_attempted&quot;</span><span class="p">:</span> <span class="s2">&quot;BOOLEAN NOT NULL DEFAULT 0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fallback_reason&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dispatch_uncertain&quot;</span><span class="p">:</span> <span class="s2">&quot;BOOLEAN NOT NULL DEFAULT 0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;api_failure_category&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cli_fallback_used&quot;</span><span class="p">:</span> <span class="s2">&quot;BOOLEAN NOT NULL DEFAULT 0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cli_preflight_passed&quot;</span><span class="p">:</span> <span class="s2">&quot;BOOLEAN&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;agent_tasks&quot;</span><span class="p">,</span> <span class="n">task_columns</span><span class="p">)</span>
        <span class="n">_migrate_agent_task_node_executor_fields</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">existing_agent_task_columns</span><span class="p">)</span>
        <span class="n">_ensure_agent_tasks_node_executor_checks_sqlite</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_migrate_agent_task_agent_nullable</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_migrate_agent_task_kind_values</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_drop_pipeline_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_ensure_flowchart_indexes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_ensure_rag_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_ensure_rag_indexes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_ensure_chat_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_ensure_chat_indexes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_drop_agent_utility_ownership</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">_ensure_canonical_workflow_views</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">existing</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA table_info(</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">col_type</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">existing</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ALTER TABLE </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> ADD COLUMN </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">col_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_quote_sqlite_literal</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_in_list_sql</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_quote_sqlite_literal</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_sqlite_table_sql</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;SELECT sql FROM sqlite_master &quot;</span>
            <span class="s2">&quot;WHERE type = &#39;table&#39; AND name = :name&quot;</span>
        <span class="p">),</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">table</span><span class="p">},</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_sqlite_table_has_named_check</span><span class="p">(</span>
    <span class="n">connection</span><span class="p">,</span>
    <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">constraint_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">table_sql</span> <span class="o">=</span> <span class="n">_sqlite_table_sql</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">table_sql</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;constraint </span><span class="si">{</span><span class="n">constraint_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2"> check&quot;</span> <span class="ow">in</span> <span class="n">table_sql</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_agent_task_node_executor_fields</span><span class="p">(</span>
    <span class="n">connection</span><span class="p">,</span>
    <span class="n">existing_columns_before_add</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;agent_tasks&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">provider_values</span> <span class="o">=</span> <span class="n">_in_list_sql</span><span class="p">(</span><span class="n">NODE_EXECUTOR_PROVIDER_ALLOWED_VALUES</span><span class="p">)</span>
    <span class="n">dispatch_values</span> <span class="o">=</span> <span class="n">_in_list_sql</span><span class="p">(</span><span class="n">NODE_EXECUTOR_DISPATCH_STATUS_ALLOWED_VALUES</span><span class="p">)</span>
    <span class="n">fallback_reason_values</span> <span class="o">=</span> <span class="n">_in_list_sql</span><span class="p">(</span><span class="n">NODE_EXECUTOR_FALLBACK_REASON_ALLOWED_VALUES</span><span class="p">)</span>
    <span class="n">api_failure_values</span> <span class="o">=</span> <span class="n">_in_list_sql</span><span class="p">(</span><span class="n">NODE_EXECUTOR_API_FAILURE_CATEGORY_ALLOWED_VALUES</span><span class="p">)</span>

    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET selected_provider = &#39;workspace&#39; &quot;</span>
            <span class="s2">&quot;WHERE selected_provider IS NULL OR selected_provider NOT IN &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">provider_values</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET final_provider = &#39;workspace&#39; &quot;</span>
            <span class="s2">&quot;WHERE final_provider IS NULL OR final_provider NOT IN &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">provider_values</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks &quot;</span>
            <span class="s2">&quot;SET provider_dispatch_id = &quot;</span>
            <span class="s2">&quot;(CASE &quot;</span>
            <span class="s2">&quot;WHEN selected_provider IN (&#39;workspace&#39;,&#39;docker&#39;,&#39;kubernetes&#39;) &quot;</span>
            <span class="s2">&quot;THEN selected_provider &quot;</span>
            <span class="s2">&quot;ELSE &#39;workspace&#39; &quot;</span>
            <span class="s2">&quot;END) || :legacy_prefix || id &quot;</span>
            <span class="s2">&quot;WHERE provider_dispatch_id IS NOT NULL &quot;</span>
            <span class="s2">&quot;AND provider_dispatch_id NOT LIKE &#39;workspace:%&#39; &quot;</span>
            <span class="s2">&quot;AND provider_dispatch_id NOT LIKE &#39;docker:%&#39; &quot;</span>
            <span class="s2">&quot;AND provider_dispatch_id NOT LIKE &#39;kubernetes:%&#39;&quot;</span>
        <span class="p">),</span>
        <span class="p">{</span><span class="s2">&quot;legacy_prefix&quot;</span><span class="p">:</span> <span class="s2">&quot;:legacy-&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET workspace_identity = &#39;default&#39; &quot;</span>
            <span class="s2">&quot;WHERE workspace_identity IS NULL OR TRIM(workspace_identity) = &#39;&#39;&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET workspace_identity = &#39;default&#39; &quot;</span>
            <span class="s2">&quot;WHERE workspace_identity LIKE &#39;%/%&#39; &quot;</span>
            <span class="s2">&quot;OR workspace_identity LIKE &#39;%</span><span class="se">\\\\</span><span class="s2">%&#39; &quot;</span>
            <span class="s2">&quot;OR workspace_identity LIKE &#39;%://%&#39;&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET dispatch_status = &#39;dispatch_pending&#39; &quot;</span>
            <span class="s2">&quot;WHERE dispatch_status IS NULL OR dispatch_status NOT IN &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">dispatch_values</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET fallback_attempted = 0 &quot;</span>
            <span class="s2">&quot;WHERE fallback_attempted IS NULL&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET dispatch_uncertain = 0 &quot;</span>
            <span class="s2">&quot;WHERE dispatch_uncertain IS NULL&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET cli_fallback_used = 0 &quot;</span>
            <span class="s2">&quot;WHERE cli_fallback_used IS NULL&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET fallback_reason = NULL &quot;</span>
            <span class="s2">&quot;WHERE fallback_reason IS NOT NULL AND fallback_reason NOT IN &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">fallback_reason_values</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET api_failure_category = NULL &quot;</span>
            <span class="s2">&quot;WHERE api_failure_category IS NOT NULL AND api_failure_category NOT IN &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">api_failure_values</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET cli_preflight_passed = NULL &quot;</span>
            <span class="s2">&quot;WHERE cli_fallback_used = 0&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET fallback_reason = NULL &quot;</span>
            <span class="s2">&quot;WHERE fallback_attempted = 0&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks SET final_provider = &#39;workspace&#39; &quot;</span>
            <span class="s2">&quot;WHERE fallback_attempted = 1&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks &quot;</span>
            <span class="s2">&quot;SET fallback_reason = &#39;unknown&#39;, fallback_attempted = 1, final_provider = &#39;workspace&#39; &quot;</span>
            <span class="s2">&quot;WHERE dispatch_status = &#39;fallback_started&#39; &quot;</span>
            <span class="s2">&quot;AND (fallback_reason IS NULL OR TRIM(fallback_reason) = &#39;&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks &quot;</span>
            <span class="s2">&quot;SET fallback_reason = &#39;unknown&#39; &quot;</span>
            <span class="s2">&quot;WHERE fallback_attempted = 1 &quot;</span>
            <span class="s2">&quot;AND dispatch_status = &#39;dispatch_failed&#39; &quot;</span>
            <span class="s2">&quot;AND dispatch_uncertain = 0 &quot;</span>
            <span class="s2">&quot;AND (fallback_reason IS NULL OR TRIM(fallback_reason) = &#39;&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks &quot;</span>
            <span class="s2">&quot;SET fallback_attempted = 0, fallback_reason = NULL &quot;</span>
            <span class="s2">&quot;WHERE dispatch_uncertain = 1&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks &quot;</span>
            <span class="s2">&quot;SET provider_dispatch_id = &quot;</span>
            <span class="s2">&quot;(CASE &quot;</span>
            <span class="s2">&quot;WHEN selected_provider IN (&#39;workspace&#39;,&#39;docker&#39;,&#39;kubernetes&#39;) &quot;</span>
            <span class="s2">&quot;THEN selected_provider &quot;</span>
            <span class="s2">&quot;ELSE &#39;workspace&#39; &quot;</span>
            <span class="s2">&quot;END) || :legacy_prefix || id &quot;</span>
            <span class="s2">&quot;WHERE dispatch_status IN (&#39;dispatch_submitted&#39;,&#39;dispatch_confirmed&#39;) &quot;</span>
            <span class="s2">&quot;AND provider_dispatch_id IS NULL&quot;</span>
        <span class="p">),</span>
        <span class="p">{</span><span class="s2">&quot;legacy_prefix&quot;</span><span class="p">:</span> <span class="s2">&quot;:legacy-&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># One-time legacy baseline backfill when new columns first land.</span>
    <span class="k">if</span> <span class="s2">&quot;provider_dispatch_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_columns_before_add</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;UPDATE agent_tasks &quot;</span>
                <span class="s2">&quot;SET provider_dispatch_id = :legacy_workspace_prefix || id &quot;</span>
                <span class="s2">&quot;WHERE provider_dispatch_id IS NULL&quot;</span>
            <span class="p">),</span>
            <span class="p">{</span><span class="s2">&quot;legacy_workspace_prefix&quot;</span><span class="p">:</span> <span class="s2">&quot;workspace:legacy-workspace-&quot;</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;dispatch_status&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_columns_before_add</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;UPDATE agent_tasks SET dispatch_status = &#39;dispatch_confirmed&#39; &quot;</span>
                <span class="s2">&quot;WHERE dispatch_status = &#39;dispatch_pending&#39;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;selected_provider&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_columns_before_add</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;UPDATE agent_tasks SET selected_provider = &#39;workspace&#39; &quot;</span>
                <span class="s2">&quot;WHERE selected_provider IS NULL OR selected_provider = &#39;&#39;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;final_provider&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_columns_before_add</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;UPDATE agent_tasks SET final_provider = &#39;workspace&#39; &quot;</span>
                <span class="s2">&quot;WHERE final_provider IS NULL OR final_provider = &#39;&#39;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;workspace_identity&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_columns_before_add</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;UPDATE agent_tasks SET workspace_identity = &#39;default&#39; &quot;</span>
                <span class="s2">&quot;WHERE workspace_identity IS NULL OR workspace_identity = &#39;&#39;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_agent_tasks_node_executor_checks_sqlite</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="s2">&quot;agent_tasks&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
        <span class="n">_sqlite_table_has_named_check</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;agent_tasks&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_expr</span> <span class="ow">in</span> <span class="n">NODE_EXECUTOR_AGENT_TASK_CHECKS</span>
    <span class="p">):</span>
        <span class="k">return</span>

    <span class="n">dependent_views</span> <span class="o">=</span> <span class="n">_capture_sqlite_views_for_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;agent_tasks&quot;</span><span class="p">)</span>
    <span class="n">foreign_keys_on</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys=OFF&quot;</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_drop_sqlite_views</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">dependent_views</span><span class="p">)</span>
        <span class="n">info_rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA table_info(agent_tasks)&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">column_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pk_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">insert_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">info_rows</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">notnull</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">column_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">col_type</span><span class="p">,</span>
                    <span class="s2">&quot;notnull&quot;</span><span class="p">:</span> <span class="n">notnull</span><span class="p">,</span>
                    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">default</span><span class="p">,</span>
                    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">insert_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pk</span><span class="p">:</span>
                <span class="n">pk_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">column_info</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">column_defs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_info</span><span class="p">:</span>
            <span class="n">col_def</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;notnull&quot;</span><span class="p">]:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="s2">&quot; NOT NULL&quot;</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; DEFAULT </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pk_columns</span><span class="p">:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="s2">&quot; PRIMARY KEY&quot;</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_def</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRIMARY KEY (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">foreign_keys</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_key_list(agent_tasks)&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">foreign_keys</span><span class="p">:</span>
            <span class="n">from_col</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">to_table</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">to_col</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;FOREIGN KEY(</span><span class="si">{</span><span class="n">from_col</span><span class="si">}</span><span class="s2">) REFERENCES </span><span class="si">{</span><span class="n">to_table</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">to_col</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">NODE_EXECUTOR_AGENT_TASK_CHECKS</span><span class="p">:</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CONSTRAINT </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> CHECK (</span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS agent_tasks_new&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE agent_tasks_new (&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_defs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;INSERT INTO agent_tasks_new (&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insert_columns</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;) SELECT &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insert_columns</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; FROM agent_tasks&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE agent_tasks&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE agent_tasks_new RENAME TO agent_tasks&quot;</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_restore_sqlite_views</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">dependent_views</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA foreign_keys=</span><span class="si">{</span><span class="s1">&#39;ON&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">foreign_keys_on</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;OFF&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA table_info(</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_quote_identifier</span><span class="p">(</span><span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_capture_sqlite_views_for_table</span><span class="p">(</span>
    <span class="n">connection</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;SELECT name, sql &quot;</span>
            <span class="s2">&quot;FROM sqlite_master &quot;</span>
            <span class="s2">&quot;WHERE type=&#39;view&#39; &quot;</span>
            <span class="s2">&quot;ORDER BY rowid&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">normalized_table</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">views</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">create_sql</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">create_sql</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">normalized_table</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">create_sql</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">views</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">create_sql</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">views</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_drop_sqlite_views</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">views</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">views</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DROP VIEW IF EXISTS </span><span class="si">{</span><span class="n">_quote_identifier</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_restore_sqlite_views</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">views</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">create_sql</span> <span class="ow">in</span> <span class="n">views</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">create_sql</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_roles_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="n">has_agent_types</span> <span class="o">=</span> <span class="s2">&quot;agent_types&quot;</span> <span class="ow">in</span> <span class="n">tables</span>
    <span class="n">has_roles</span> <span class="o">=</span> <span class="s2">&quot;roles&quot;</span> <span class="ow">in</span> <span class="n">tables</span>

    <span class="k">if</span> <span class="n">has_agent_types</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_roles</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE agent_types RENAME TO roles&quot;</span><span class="p">))</span>
        <span class="n">has_roles</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">has_agent_types</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">has_agent_types</span> <span class="ow">and</span> <span class="n">has_roles</span><span class="p">:</span>
        <span class="n">roles_count</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM roles&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">roles_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">role_columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;roles&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;prompt_json&quot;</span> <span class="ow">in</span> <span class="n">role_columns</span> <span class="ow">or</span> <span class="s2">&quot;prompt_text&quot;</span> <span class="ow">in</span> <span class="n">role_columns</span><span class="p">:</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">(</span>
                        <span class="s2">&quot;INSERT INTO roles (id, name, prompt_json, prompt_text, created_at, updated_at) &quot;</span>
                        <span class="s2">&quot;SELECT id, name, prompt_json, prompt_text, created_at, updated_at FROM agent_types&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">(</span>
                        <span class="s2">&quot;SELECT id, name, prompt_json, prompt_text, created_at, updated_at &quot;</span>
                        <span class="s2">&quot;FROM agent_types&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">_mapping</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">details_payload</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">prompt_json</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;prompt_json&quot;</span><span class="p">]</span>
                    <span class="n">prompt_text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;prompt_text&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">prompt_json</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">prompt_json</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                            <span class="n">payload</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">details_payload</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
                            <span class="n">prompt_value</span> <span class="o">=</span> <span class="n">details_payload</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                                <span class="n">description</span> <span class="o">=</span> <span class="n">prompt_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
                            <span class="n">details_payload</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">details_payload</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">description</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prompt_text</span><span class="p">:</span>
                        <span class="n">description</span> <span class="o">=</span> <span class="n">prompt_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">details_payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">details_payload</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">text</span><span class="p">(</span>
                            <span class="s2">&quot;INSERT INTO roles &quot;</span>
                            <span class="s2">&quot;(id, name, description, details_json, created_at, updated_at) &quot;</span>
                            <span class="s2">&quot;VALUES (:id, :name, :description, :details_json, :created_at, :updated_at)&quot;</span>
                        <span class="p">),</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                            <span class="s2">&quot;details_json&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="n">details_payload</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">],</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE agent_types&quot;</span><span class="p">))</span>

    <span class="n">agent_columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;agents&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;agent_type_id&quot;</span> <span class="ow">in</span> <span class="n">agent_columns</span> <span class="ow">and</span> <span class="s2">&quot;role_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent_columns</span><span class="p">:</span>
        <span class="n">_migrate_agent_role_column</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">agent_columns</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_role_payloads</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">role_columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;roles&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">role_columns</span> <span class="ow">or</span> <span class="s2">&quot;details_json&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">role_columns</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">has_prompt_json</span> <span class="o">=</span> <span class="s2">&quot;prompt_json&quot;</span> <span class="ow">in</span> <span class="n">role_columns</span>
    <span class="n">has_prompt_text</span> <span class="o">=</span> <span class="s2">&quot;prompt_text&quot;</span> <span class="ow">in</span> <span class="n">role_columns</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_prompt_json</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_prompt_text</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">select_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">,</span>
        <span class="s2">&quot;details_json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prompt_json&quot;</span> <span class="k">if</span> <span class="n">has_prompt_json</span> <span class="k">else</span> <span class="s2">&quot;NULL as prompt_json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prompt_text&quot;</span> <span class="k">if</span> <span class="n">has_prompt_text</span> <span class="k">else</span> <span class="s2">&quot;NULL as prompt_text&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">select_columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> FROM roles&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">_mapping</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>
        <span class="n">details_json</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;details_json&quot;</span><span class="p">]</span>
        <span class="n">prompt_json</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;prompt_json&quot;</span><span class="p">]</span>
        <span class="n">prompt_text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;prompt_text&quot;</span><span class="p">]</span>

        <span class="n">updated_fields</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">details_payload</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">details_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prompt_json</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">prompt_json</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">details_payload</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
                <span class="n">prompt_value</span> <span class="o">=</span> <span class="n">details_payload</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="n">prompt_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
                <span class="n">details_payload</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">details_payload</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prompt_text</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">prompt_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">details_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">details_payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">details_payload</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">details_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">details_payload</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;details_json&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">details_json</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">text</span><span class="p">(</span>
                    <span class="s2">&quot;UPDATE roles &quot;</span>
                    <span class="s2">&quot;SET description = :description, details_json = :details_json &quot;</span>
                    <span class="s2">&quot;WHERE id = :id&quot;</span>
                <span class="p">),</span>
                <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                    <span class="s2">&quot;details_json&quot;</span><span class="p">:</span> <span class="n">details_json</span><span class="p">,</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="p">},</span>
            <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_drop_role_prompt_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">role_columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;roles&quot;</span><span class="p">)</span>
    <span class="n">drop_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;prompt_json&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt_text&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">role_columns</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">drop_columns</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">foreign_keys_on</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys=OFF&quot;</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">info_rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA table_info(roles)&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">column_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pk_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">insert_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">info_rows</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">drop_columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">notnull</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">column_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">col_type</span><span class="p">,</span>
                    <span class="s2">&quot;notnull&quot;</span><span class="p">:</span> <span class="n">notnull</span><span class="p">,</span>
                    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">default</span><span class="p">,</span>
                    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">insert_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pk</span><span class="p">:</span>
                <span class="n">pk_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">column_info</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">column_defs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_info</span><span class="p">:</span>
            <span class="n">col_def</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;notnull&quot;</span><span class="p">]:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="s2">&quot; NOT NULL&quot;</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; DEFAULT </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pk_columns</span><span class="p">:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="s2">&quot; PRIMARY KEY&quot;</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_def</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRIMARY KEY (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">foreign_keys</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_key_list(roles)&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">foreign_keys</span><span class="p">:</span>
            <span class="n">from_col</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">to_table</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">to_col</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;FOREIGN KEY(</span><span class="si">{</span><span class="n">from_col</span><span class="si">}</span><span class="s2">) REFERENCES </span><span class="si">{</span><span class="n">to_table</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">to_col</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS roles_new&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE roles_new (&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_defs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;INSERT INTO roles_new (&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insert_columns</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;) SELECT &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insert_columns</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; FROM roles&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE roles&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE roles_new RENAME TO roles&quot;</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA foreign_keys=</span><span class="si">{</span><span class="s1">&#39;ON&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">foreign_keys_on</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;OFF&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_agent_descriptions</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">agent_columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;agents&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent_columns</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">has_prompt_json</span> <span class="o">=</span> <span class="s2">&quot;prompt_json&quot;</span> <span class="ow">in</span> <span class="n">agent_columns</span>
    <span class="n">has_prompt_text</span> <span class="o">=</span> <span class="s2">&quot;prompt_text&quot;</span> <span class="ow">in</span> <span class="n">agent_columns</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_prompt_json</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_prompt_text</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">select_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prompt_json&quot;</span> <span class="k">if</span> <span class="n">has_prompt_json</span> <span class="k">else</span> <span class="s2">&quot;NULL as prompt_json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prompt_text&quot;</span> <span class="k">if</span> <span class="n">has_prompt_text</span> <span class="k">else</span> <span class="s2">&quot;NULL as prompt_text&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">select_columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> FROM agents&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">_mapping</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prompt_json</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;prompt_json&quot;</span><span class="p">]</span>
        <span class="n">prompt_text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;prompt_text&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">prompt_json</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">prompt_json</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">prompt_json</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">description_value</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">description_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="n">description_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prompt_text</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">prompt_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;UPDATE agents SET description = :description WHERE id = :id&quot;</span><span class="p">),</span>
            <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]},</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_agent_status_column</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">agent_columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;agents&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;status&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agent_columns</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">foreign_keys_on</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys=OFF&quot;</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">info_rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA table_info(agents)&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">column_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pk_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">insert_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">info_rows</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">notnull</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">column_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">col_type</span><span class="p">,</span>
                    <span class="s2">&quot;notnull&quot;</span><span class="p">:</span> <span class="n">notnull</span><span class="p">,</span>
                    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">default</span><span class="p">,</span>
                    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">insert_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pk</span><span class="p">:</span>
                <span class="n">pk_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">column_info</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">column_defs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_info</span><span class="p">:</span>
            <span class="n">col_def</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;notnull&quot;</span><span class="p">]:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="s2">&quot; NOT NULL&quot;</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; DEFAULT </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pk_columns</span><span class="p">:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="s2">&quot; PRIMARY KEY&quot;</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_def</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRIMARY KEY (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">foreign_keys</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_key_list(agents)&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">foreign_keys</span><span class="p">:</span>
            <span class="n">from_col</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">to_table</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">to_col</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;FOREIGN KEY(</span><span class="si">{</span><span class="n">from_col</span><span class="si">}</span><span class="s2">) REFERENCES </span><span class="si">{</span><span class="n">to_table</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">to_col</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS agents_new&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE agents_new (&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_defs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;INSERT INTO agents_new (&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insert_columns</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;) SELECT &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insert_columns</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; FROM agents&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE agents&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE agents_new RENAME TO agents&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agents_role_id ON agents (role_id)&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA foreign_keys=</span><span class="si">{</span><span class="s1">&#39;ON&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">foreign_keys_on</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;OFF&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_drop_columns_sqlite</span><span class="p">(</span>
    <span class="n">connection</span><span class="p">,</span>
    <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">drop_columns</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">index_statements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">table_columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">table_columns</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">drop_columns</span> <span class="o">&amp;</span> <span class="n">table_columns</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">dependent_views</span> <span class="o">=</span> <span class="n">_capture_sqlite_views_for_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="n">foreign_keys_on</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys=OFF&quot;</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_drop_sqlite_views</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">dependent_views</span><span class="p">)</span>
        <span class="n">info_rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA table_info(</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">column_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pk_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">insert_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">info_rows</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">drop_columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">notnull</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">column_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">col_type</span><span class="p">,</span>
                    <span class="s2">&quot;notnull&quot;</span><span class="p">:</span> <span class="n">notnull</span><span class="p">,</span>
                    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">default</span><span class="p">,</span>
                    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">insert_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pk</span><span class="p">:</span>
                <span class="n">pk_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">column_info</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">column_defs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_info</span><span class="p">:</span>
            <span class="n">col_def</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;notnull&quot;</span><span class="p">]:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="s2">&quot; NOT NULL&quot;</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; DEFAULT </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pk_columns</span><span class="p">:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="s2">&quot; PRIMARY KEY&quot;</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_def</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRIMARY KEY (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">foreign_keys</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA foreign_key_list(</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">foreign_keys</span><span class="p">:</span>
            <span class="n">from_col</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">to_table</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">to_col</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">from_col</span> <span class="ow">in</span> <span class="n">drop_columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;FOREIGN KEY(</span><span class="si">{</span><span class="n">from_col</span><span class="si">}</span><span class="s2">) REFERENCES </span><span class="si">{</span><span class="n">to_table</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">to_col</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DROP TABLE IF EXISTS </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">_new&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CREATE TABLE </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">_new (&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_defs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;INSERT INTO </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">_new (&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insert_columns</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;) SELECT &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insert_columns</span><span class="p">)</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DROP TABLE </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ALTER TABLE </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">_new RENAME TO </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">index_statements</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">index_statements</span><span class="p">:</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">statement</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_restore_sqlite_views</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">dependent_views</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA foreign_keys=</span><span class="si">{</span><span class="s1">&#39;ON&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">foreign_keys_on</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;OFF&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_drop_agent_is_active_column</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_drop_columns_sqlite</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="s2">&quot;agents&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;is_active&quot;</span><span class="p">},</span>
        <span class="n">index_statements</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agents_role_id ON agents (role_id)&quot;</span>
        <span class="p">],</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_drop_run_is_active_column</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_drop_columns_sqlite</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="s2">&quot;runs&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;is_active&quot;</span><span class="p">},</span>
        <span class="n">index_statements</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_runs_agent_id ON runs (agent_id)&quot;</span>
        <span class="p">],</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_script_storage</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;scripts&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;file_path&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT id, file_name, content, file_path FROM scripts&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">_mapping</span>
        <span class="n">script_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;script-</span><span class="si">{</span><span class="n">script_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">existing_path</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;file_path&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">existing_path</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">existing_path</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">write_script_file</span><span class="p">(</span><span class="n">script_id</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;UPDATE scripts SET file_path = :file_path WHERE id = :id&quot;</span><span class="p">),</span>
            <span class="p">{</span><span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">script_id</span><span class="p">},</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_script_positions</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">task_columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;agent_task_scripts&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;position&quot;</span> <span class="ow">in</span> <span class="n">task_columns</span><span class="p">:</span>
        <span class="n">_assign_missing_script_positions</span><span class="p">(</span>
            <span class="n">connection</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="s2">&quot;agent_task_scripts&quot;</span><span class="p">,</span>
            <span class="n">owner_id_column</span><span class="o">=</span><span class="s2">&quot;agent_task_id&quot;</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_assign_missing_script_positions</span><span class="p">(</span>
    <span class="n">connection</span><span class="p">,</span>
    <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">owner_id_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">existing_rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;SELECT &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">owner_id_column</span><span class="si">}</span><span class="s2"> as owner_id, scripts.script_type, MAX(position) as max_pos &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;JOIN scripts ON scripts.id = </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">.script_id &quot;</span>
            <span class="s2">&quot;WHERE position IS NOT NULL &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;GROUP BY </span><span class="si">{</span><span class="n">owner_id_column</span><span class="si">}</span><span class="s2">, scripts.script_type&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">next_positions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">existing_rows</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">_mapping</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;owner_id&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;script_type&quot;</span><span class="p">])</span>
        <span class="n">next_positions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;max_pos&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;SELECT &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">owner_id_column</span><span class="si">}</span><span class="s2"> as owner_id, </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">.script_id, scripts.script_type &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;JOIN scripts ON scripts.id = </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">.script_id &quot;</span>
            <span class="s2">&quot;WHERE position IS NULL &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ORDER BY </span><span class="si">{</span><span class="n">owner_id_column</span><span class="si">}</span><span class="s2">, scripts.script_type, </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">.script_id&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">_mapping</span>
        <span class="n">owner_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;owner_id&quot;</span><span class="p">]</span>
        <span class="n">script_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;script_id&quot;</span><span class="p">]</span>
        <span class="n">script_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;script_type&quot;</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">owner_id</span><span class="p">,</span> <span class="n">script_type</span><span class="p">)</span>
        <span class="n">next_positions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;UPDATE </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> SET position = :position &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;WHERE </span><span class="si">{</span><span class="n">owner_id_column</span><span class="si">}</span><span class="s2"> = :owner_id AND script_id = :script_id&quot;</span>
            <span class="p">),</span>
            <span class="p">{</span>
                <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">next_positions</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                <span class="s2">&quot;owner_id&quot;</span><span class="p">:</span> <span class="n">owner_id</span><span class="p">,</span>
                <span class="s2">&quot;script_id&quot;</span><span class="p">:</span> <span class="n">script_id</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_agent_role_column</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">agent_columns</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">foreign_keys_on</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys=OFF&quot;</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS agents_new&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE TABLE agents_new (&quot;</span>
                <span class="s2">&quot;id INTEGER NOT NULL, &quot;</span>
                <span class="s2">&quot;name VARCHAR(255) NOT NULL, &quot;</span>
                <span class="s2">&quot;role_id INTEGER, &quot;</span>
                <span class="s2">&quot;prompt_json TEXT NOT NULL, &quot;</span>
                <span class="s2">&quot;prompt_text TEXT, &quot;</span>
                <span class="s2">&quot;autonomous_prompt TEXT, &quot;</span>
                <span class="s2">&quot;task_id VARCHAR(255), &quot;</span>
                <span class="s2">&quot;last_output TEXT, &quot;</span>
                <span class="s2">&quot;last_error TEXT, &quot;</span>
                <span class="s2">&quot;last_started_at DATETIME, &quot;</span>
                <span class="s2">&quot;last_stopped_at DATETIME, &quot;</span>
                <span class="s2">&quot;last_run_at DATETIME, &quot;</span>
                <span class="s2">&quot;created_at DATETIME NOT NULL, &quot;</span>
                <span class="s2">&quot;updated_at DATETIME NOT NULL, &quot;</span>
                <span class="s2">&quot;PRIMARY KEY (id), &quot;</span>
                <span class="s2">&quot;FOREIGN KEY(role_id) REFERENCES roles (id)&quot;</span>
                <span class="s2">&quot;)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">insert_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;role_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prompt_json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prompt_text&quot;</span><span class="p">,</span>
            <span class="s2">&quot;autonomous_prompt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;task_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_output&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_started_at&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_stopped_at&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_run_at&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prompt_json&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">select_exprs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">insert_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="o">==</span> <span class="s2">&quot;role_id&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;role_id&quot;</span> <span class="ow">in</span> <span class="n">agent_columns</span><span class="p">:</span>
                    <span class="n">select_exprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;role_id&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;agent_type_id&quot;</span> <span class="ow">in</span> <span class="n">agent_columns</span><span class="p">:</span>
                    <span class="n">select_exprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;agent_type_id&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">select_exprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;NULL&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">agent_columns</span><span class="p">:</span>
                <span class="n">select_exprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">select_exprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="s2">&quot;NULL&quot;</span><span class="p">))</span>

        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;INSERT INTO agents_new (&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insert_columns</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;) SELECT &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">select_exprs</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; FROM agents&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE agents&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE agents_new RENAME TO agents&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agents_role_id ON agents (role_id)&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA foreign_keys=</span><span class="si">{</span><span class="s1">&#39;ON&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">foreign_keys_on</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;OFF&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_drop_pipeline_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">_drop_columns_sqlite</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="s2">&quot;agent_tasks&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;pipeline_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pipeline_run_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pipeline_step_id&quot;</span><span class="p">},</span>
        <span class="n">index_statements</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_agent_id ON agent_tasks (agent_id)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_run_id ON agent_tasks (run_id)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_task_template_id ON agent_tasks (task_template_id)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_flowchart_id ON agent_tasks (flowchart_id)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_flowchart_run_id ON agent_tasks (flowchart_run_id)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_flowchart_node_id ON agent_tasks (flowchart_node_id)&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS pipeline_step_attachments&quot;</span><span class="p">))</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS pipeline_steps&quot;</span><span class="p">))</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS pipeline_runs&quot;</span><span class="p">))</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS pipelines&quot;</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_agent_task_agent_nullable</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">info_rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA table_info(agent_tasks)&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">info_rows</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">agent_row</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">info_rows</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;agent_id&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">agent_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">agent_row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">dependent_views</span> <span class="o">=</span> <span class="n">_capture_sqlite_views_for_table</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;agent_tasks&quot;</span><span class="p">)</span>
    <span class="n">foreign_keys_on</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys=OFF&quot;</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_drop_sqlite_views</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">dependent_views</span><span class="p">)</span>
        <span class="n">column_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pk_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">insert_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">info_rows</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">col_type</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">notnull</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">column_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">col_type</span><span class="p">,</span>
                    <span class="s2">&quot;notnull&quot;</span><span class="p">:</span> <span class="n">notnull</span><span class="p">,</span>
                    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">default</span><span class="p">,</span>
                    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="n">pk</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">insert_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pk</span><span class="p">:</span>
                <span class="n">pk_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">column_info</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">column_defs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_info</span><span class="p">:</span>
            <span class="n">col_def</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># This migration only relaxes agent_id nullability.</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;agent_id&quot;</span> <span class="ow">and</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;notnull&quot;</span><span class="p">]:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="s2">&quot; NOT NULL&quot;</span>
            <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; DEFAULT </span><span class="si">{</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">col</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pk_columns</span><span class="p">:</span>
                <span class="n">col_def</span> <span class="o">+=</span> <span class="s2">&quot; PRIMARY KEY&quot;</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_def</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRIMARY KEY (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pk_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">foreign_keys</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_key_list(agent_tasks)&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">foreign_keys</span><span class="p">:</span>
            <span class="n">from_col</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">to_table</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">to_col</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;FOREIGN KEY(</span><span class="si">{</span><span class="n">from_col</span><span class="si">}</span><span class="s2">) REFERENCES </span><span class="si">{</span><span class="n">to_table</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">to_col</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS agent_tasks_new&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE agent_tasks_new (&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_defs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;INSERT INTO agent_tasks_new &quot;</span>
                <span class="s2">&quot;(&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insert_columns</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;) SELECT &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">insert_columns</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; FROM agent_tasks&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE agent_tasks&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;ALTER TABLE agent_tasks_new RENAME TO agent_tasks&quot;</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_restore_sqlite_views</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">dependent_views</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRAGMA foreign_keys=</span><span class="si">{</span><span class="s1">&#39;ON&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">foreign_keys_on</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;OFF&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_agent_task_kind_values</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">task_columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;agent_tasks&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;kind&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task_columns</span> <span class="ow">or</span> <span class="s2">&quot;flowchart_node_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task_columns</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">flowchart_node_columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;flowchart_nodes&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;node_type&quot;</span> <span class="ow">in</span> <span class="n">flowchart_node_columns</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;UPDATE agent_tasks &quot;</span>
                <span class="s2">&quot;SET kind = (&quot;</span>
                <span class="s2">&quot;  SELECT &#39;flowchart_&#39; || lower(trim(flowchart_nodes.node_type)) &quot;</span>
                <span class="s2">&quot;  FROM flowchart_nodes &quot;</span>
                <span class="s2">&quot;  WHERE flowchart_nodes.id = agent_tasks.flowchart_node_id&quot;</span>
                <span class="s2">&quot;) &quot;</span>
                <span class="s2">&quot;WHERE flowchart_node_id IS NOT NULL &quot;</span>
                <span class="s2">&quot;AND EXISTS (&quot;</span>
                <span class="s2">&quot;  SELECT 1 FROM flowchart_nodes &quot;</span>
                <span class="s2">&quot;  WHERE flowchart_nodes.id = agent_tasks.flowchart_node_id&quot;</span>
                <span class="s2">&quot;) &quot;</span>
                <span class="s2">&quot;AND (kind IS NULL OR trim(kind) = &#39;&#39; OR lower(trim(kind)) != (&quot;</span>
                <span class="s2">&quot;  SELECT &#39;flowchart_&#39; || lower(trim(flowchart_nodes.node_type)) &quot;</span>
                <span class="s2">&quot;  FROM flowchart_nodes &quot;</span>
                <span class="s2">&quot;  WHERE flowchart_nodes.id = agent_tasks.flowchart_node_id&quot;</span>
                <span class="s2">&quot;))&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE agent_tasks &quot;</span>
            <span class="s2">&quot;SET kind = NULL &quot;</span>
            <span class="s2">&quot;WHERE flowchart_node_id IS NULL &quot;</span>
            <span class="s2">&quot;AND kind IS NOT NULL &quot;</span>
            <span class="s2">&quot;AND (&quot;</span>
            <span class="s2">&quot;  lower(trim(kind)) IN (&#39;task&#39;, &#39;node&#39;, &#39;flowchart&#39;, &#39;flowchart_node&#39;) &quot;</span>
            <span class="s2">&quot;  OR lower(trim(kind)) LIKE &#39;flowchart_%&#39;&quot;</span>
            <span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_milestone_status</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">milestone_columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;milestones&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;status&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">milestone_columns</span> <span class="ow">or</span> <span class="s2">&quot;completed&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">milestone_columns</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE milestones &quot;</span>
            <span class="s2">&quot;SET status = &#39;done&#39; &quot;</span>
            <span class="s2">&quot;WHERE completed = 1 AND (status IS NULL OR status != &#39;done&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE milestones &quot;</span>
            <span class="s2">&quot;SET completed = 1 &quot;</span>
            <span class="s2">&quot;WHERE status = &#39;done&#39; AND (completed IS NULL OR completed = 0)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_flowchart_edge_modes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;flowchart_edges&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;flowchart_edges&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;edge_mode&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE flowchart_edges &quot;</span>
            <span class="s2">&quot;SET edge_mode = &#39;solid&#39; &quot;</span>
            <span class="s2">&quot;WHERE edge_mode IS NULL &quot;</span>
            <span class="s2">&quot;OR trim(edge_mode) = &#39;&#39; &quot;</span>
            <span class="s2">&quot;OR lower(trim(edge_mode)) NOT IN (&#39;solid&#39;, &#39;dotted&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_agent_priority_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE TABLE IF NOT EXISTS agent_priorities (&quot;</span>
            <span class="s2">&quot;id INTEGER PRIMARY KEY, &quot;</span>
            <span class="s2">&quot;agent_id INTEGER NOT NULL, &quot;</span>
            <span class="s2">&quot;position INTEGER NOT NULL DEFAULT 1, &quot;</span>
            <span class="s2">&quot;content TEXT NOT NULL, &quot;</span>
            <span class="s2">&quot;created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(agent_id) REFERENCES agents (id)&quot;</span>
            <span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_ensure_columns</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="s2">&quot;agent_priorities&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL DEFAULT 1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_priorities_agent_id &quot;</span>
            <span class="s2">&quot;ON agent_priorities (agent_id)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_parse_optional_positive_int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cleaned</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">parsed</span> <span class="k">if</span> <span class="n">parsed</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_extract_agent_id_from_node_config</span><span class="p">(</span><span class="n">raw_config_json</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_config_json</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_config_json</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">_parse_optional_positive_int</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_id&quot;</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_agent_skill_binding_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE TABLE IF NOT EXISTS agent_skill_bindings (&quot;</span>
            <span class="s2">&quot;agent_id INTEGER NOT NULL, &quot;</span>
            <span class="s2">&quot;skill_id INTEGER NOT NULL, &quot;</span>
            <span class="s2">&quot;position INTEGER NOT NULL DEFAULT 1, &quot;</span>
            <span class="s2">&quot;created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;PRIMARY KEY (agent_id, skill_id), &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(agent_id) REFERENCES agents (id), &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(skill_id) REFERENCES skills (id)&quot;</span>
            <span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_ensure_columns</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="s2">&quot;agent_skill_bindings&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;skill_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL DEFAULT 1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_skill_bindings_agent_id &quot;</span>
            <span class="s2">&quot;ON agent_skill_bindings (agent_id)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_skill_bindings_skill_id &quot;</span>
            <span class="s2">&quot;ON agent_skill_bindings (skill_id)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE TABLE IF NOT EXISTS legacy_unmapped_node_skills (&quot;</span>
            <span class="s2">&quot;id INTEGER PRIMARY KEY, &quot;</span>
            <span class="s2">&quot;flowchart_node_id INTEGER NOT NULL, &quot;</span>
            <span class="s2">&quot;skill_id INTEGER NOT NULL, &quot;</span>
            <span class="s2">&quot;legacy_position INTEGER, &quot;</span>
            <span class="s2">&quot;node_ref_id INTEGER, &quot;</span>
            <span class="s2">&quot;node_config_json TEXT, &quot;</span>
            <span class="s2">&quot;reason TEXT NOT NULL, &quot;</span>
            <span class="s2">&quot;created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;UNIQUE(flowchart_node_id, skill_id)&quot;</span>
            <span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_ensure_columns</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="s2">&quot;legacy_unmapped_node_skills&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;flowchart_node_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;skill_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;legacy_position&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;node_ref_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;node_config_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_legacy_unmapped_node_skills_flowchart_node_id &quot;</span>
            <span class="s2">&quot;ON legacy_unmapped_node_skills (flowchart_node_id)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_legacy_unmapped_node_skills_skill_id &quot;</span>
            <span class="s2">&quot;ON legacy_unmapped_node_skills (skill_id)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_ensure_node_skill_binding_deprecation_triggers</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_flowchart_node_attachment_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE TABLE IF NOT EXISTS flowchart_node_attachments (&quot;</span>
            <span class="s2">&quot;flowchart_node_id INTEGER NOT NULL, &quot;</span>
            <span class="s2">&quot;attachment_id INTEGER NOT NULL, &quot;</span>
            <span class="s2">&quot;created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;PRIMARY KEY (flowchart_node_id, attachment_id), &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(flowchart_node_id) REFERENCES flowchart_nodes (id), &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(attachment_id) REFERENCES attachments (id)&quot;</span>
            <span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_ensure_columns</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="s2">&quot;flowchart_node_attachments&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;flowchart_node_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attachment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_flowchart_node_attachments_flowchart_node_id &quot;</span>
            <span class="s2">&quot;ON flowchart_node_attachments (flowchart_node_id)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_flowchart_node_attachments_attachment_id &quot;</span>
            <span class="s2">&quot;ON flowchart_node_attachments (attachment_id)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_node_skill_binding_deprecation_triggers</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE TRIGGER IF NOT EXISTS trg_flowchart_node_skills_reject_insert &quot;</span>
            <span class="s2">&quot;BEFORE INSERT ON flowchart_node_skills &quot;</span>
            <span class="s2">&quot;WHEN EXISTS (&quot;</span>
            <span class="s2">&quot;  SELECT 1 FROM integration_settings &quot;</span>
            <span class="s2">&quot;  WHERE provider = &#39;llm&#39; &quot;</span>
            <span class="s2">&quot;    AND key = &#39;node_skill_binding_mode&#39; &quot;</span>
            <span class="s2">&quot;    AND lower(trim(value)) = &#39;reject&#39;&quot;</span>
            <span class="s2">&quot;) &quot;</span>
            <span class="s2">&quot;BEGIN &quot;</span>
            <span class="s2">&quot;  SELECT RAISE(ABORT, &#39;Node-level skill bindings are deprecated. Assign skills to the Agent.&#39;); &quot;</span>
            <span class="s2">&quot;END&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE TRIGGER IF NOT EXISTS trg_flowchart_node_skills_reject_update &quot;</span>
            <span class="s2">&quot;BEFORE UPDATE ON flowchart_node_skills &quot;</span>
            <span class="s2">&quot;WHEN EXISTS (&quot;</span>
            <span class="s2">&quot;  SELECT 1 FROM integration_settings &quot;</span>
            <span class="s2">&quot;  WHERE provider = &#39;llm&#39; &quot;</span>
            <span class="s2">&quot;    AND key = &#39;node_skill_binding_mode&#39; &quot;</span>
            <span class="s2">&quot;    AND lower(trim(value)) = &#39;reject&#39;&quot;</span>
            <span class="s2">&quot;) &quot;</span>
            <span class="s2">&quot;BEGIN &quot;</span>
            <span class="s2">&quot;  SELECT RAISE(ABORT, &#39;Node-level skill bindings are deprecated. Assign skills to the Agent.&#39;); &quot;</span>
            <span class="s2">&quot;END&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_flowchart_node_skills_to_agent_bindings</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="n">required_tables</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;flowchart_node_skills&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flowchart_nodes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;task_templates&quot;</span><span class="p">,</span>
        <span class="s2">&quot;agents&quot;</span><span class="p">,</span>
        <span class="s2">&quot;skills&quot;</span><span class="p">,</span>
        <span class="s2">&quot;agent_skill_bindings&quot;</span><span class="p">,</span>
        <span class="s2">&quot;legacy_unmapped_node_skills&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">required_tables</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">tables</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="n">valid_agent_ids</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT id FROM agents&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">}</span>
    <span class="n">valid_skill_ids</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT id FROM skills&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">}</span>
    <span class="n">template_agent_by_id</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;SELECT id, agent_id &quot;</span>
                <span class="s2">&quot;FROM task_templates &quot;</span>
                <span class="s2">&quot;WHERE agent_id IS NOT NULL&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">}</span>

    <span class="n">existing_pairs</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">max_position_by_agent</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">existing_rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;SELECT agent_id, skill_id, position &quot;</span>
            <span class="s2">&quot;FROM agent_skill_bindings &quot;</span>
            <span class="s2">&quot;ORDER BY agent_id ASC, position ASC, skill_id ASC&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">existing_rows</span><span class="p">:</span>
        <span class="n">agent_id</span> <span class="o">=</span> <span class="n">_parse_optional_positive_int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">skill_id</span> <span class="o">=</span> <span class="n">_parse_optional_positive_int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">agent_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">skill_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">existing_pairs</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">skill_id</span><span class="p">))</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">_parse_optional_positive_int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="n">max_position_by_agent</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">max_position_by_agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">position</span>
        <span class="p">)</span>

    <span class="n">legacy_rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;SELECT &quot;</span>
            <span class="s2">&quot;  fns.flowchart_node_id, &quot;</span>
            <span class="s2">&quot;  fns.skill_id, &quot;</span>
            <span class="s2">&quot;  fns.position, &quot;</span>
            <span class="s2">&quot;  fn.ref_id, &quot;</span>
            <span class="s2">&quot;  fn.config_json &quot;</span>
            <span class="s2">&quot;FROM flowchart_node_skills AS fns &quot;</span>
            <span class="s2">&quot;JOIN flowchart_nodes AS fn &quot;</span>
            <span class="s2">&quot;  ON fn.id = fns.flowchart_node_id &quot;</span>
            <span class="s2">&quot;ORDER BY &quot;</span>
            <span class="s2">&quot;  fns.flowchart_node_id ASC, &quot;</span>
            <span class="s2">&quot;  CASE WHEN fns.position IS NULL THEN 1 ELSE 0 END ASC, &quot;</span>
            <span class="s2">&quot;  fns.position ASC, &quot;</span>
            <span class="s2">&quot;  fns.skill_id ASC&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">legacy_rows</span><span class="p">:</span>
        <span class="n">flowchart_node_id</span> <span class="o">=</span> <span class="n">_parse_optional_positive_int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">skill_id</span> <span class="o">=</span> <span class="n">_parse_optional_positive_int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">legacy_position</span> <span class="o">=</span> <span class="n">_parse_optional_positive_int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">node_ref_id</span> <span class="o">=</span> <span class="n">_parse_optional_positive_int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">node_config_json</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">flowchart_node_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">skill_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">skill_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_skill_ids</span><span class="p">:</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">text</span><span class="p">(</span>
                    <span class="s2">&quot;INSERT OR IGNORE INTO legacy_unmapped_node_skills (&quot;</span>
                    <span class="s2">&quot;flowchart_node_id, skill_id, legacy_position, node_ref_id, node_config_json, reason&quot;</span>
                    <span class="s2">&quot;) VALUES (&quot;</span>
                    <span class="s2">&quot;:flowchart_node_id, :skill_id, :legacy_position, :node_ref_id, :node_config_json, :reason&quot;</span>
                    <span class="s2">&quot;)&quot;</span>
                <span class="p">),</span>
                <span class="p">{</span>
                    <span class="s2">&quot;flowchart_node_id&quot;</span><span class="p">:</span> <span class="n">flowchart_node_id</span><span class="p">,</span>
                    <span class="s2">&quot;skill_id&quot;</span><span class="p">:</span> <span class="n">skill_id</span><span class="p">,</span>
                    <span class="s2">&quot;legacy_position&quot;</span><span class="p">:</span> <span class="n">legacy_position</span><span class="p">,</span>
                    <span class="s2">&quot;node_ref_id&quot;</span><span class="p">:</span> <span class="n">node_ref_id</span><span class="p">,</span>
                    <span class="s2">&quot;node_config_json&quot;</span><span class="p">:</span> <span class="n">node_config_json</span><span class="p">,</span>
                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;skill_not_found&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">resolved_agent_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">config_agent_id</span> <span class="o">=</span> <span class="n">_extract_agent_id_from_node_config</span><span class="p">(</span><span class="n">node_config_json</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config_agent_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">config_agent_id</span> <span class="ow">in</span> <span class="n">valid_agent_ids</span><span class="p">:</span>
            <span class="n">resolved_agent_id</span> <span class="o">=</span> <span class="n">config_agent_id</span>
        <span class="k">elif</span> <span class="n">node_ref_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">template_agent_id</span> <span class="o">=</span> <span class="n">template_agent_by_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_ref_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">template_agent_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">template_agent_id</span> <span class="ow">in</span> <span class="n">valid_agent_ids</span><span class="p">:</span>
                <span class="n">resolved_agent_id</span> <span class="o">=</span> <span class="n">template_agent_id</span>

        <span class="k">if</span> <span class="n">resolved_agent_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;missing_agent_mapping&quot;</span>
            <span class="k">if</span> <span class="n">config_agent_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">config_agent_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_agent_ids</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;node_config_agent_not_found&quot;</span>
            <span class="k">elif</span> <span class="n">node_ref_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">node_ref_id</span> <span class="ow">in</span> <span class="n">template_agent_by_id</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;task_template_agent_not_found&quot;</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">text</span><span class="p">(</span>
                    <span class="s2">&quot;INSERT OR IGNORE INTO legacy_unmapped_node_skills (&quot;</span>
                    <span class="s2">&quot;flowchart_node_id, skill_id, legacy_position, node_ref_id, node_config_json, reason&quot;</span>
                    <span class="s2">&quot;) VALUES (&quot;</span>
                    <span class="s2">&quot;:flowchart_node_id, :skill_id, :legacy_position, :node_ref_id, :node_config_json, :reason&quot;</span>
                    <span class="s2">&quot;)&quot;</span>
                <span class="p">),</span>
                <span class="p">{</span>
                    <span class="s2">&quot;flowchart_node_id&quot;</span><span class="p">:</span> <span class="n">flowchart_node_id</span><span class="p">,</span>
                    <span class="s2">&quot;skill_id&quot;</span><span class="p">:</span> <span class="n">skill_id</span><span class="p">,</span>
                    <span class="s2">&quot;legacy_position&quot;</span><span class="p">:</span> <span class="n">legacy_position</span><span class="p">,</span>
                    <span class="s2">&quot;node_ref_id&quot;</span><span class="p">:</span> <span class="n">node_ref_id</span><span class="p">,</span>
                    <span class="s2">&quot;node_config_json&quot;</span><span class="p">:</span> <span class="n">node_config_json</span><span class="p">,</span>
                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">resolved_agent_id</span><span class="p">,</span> <span class="n">skill_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">existing_pairs</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">next_position</span> <span class="o">=</span> <span class="n">max_position_by_agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resolved_agent_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;INSERT OR IGNORE INTO agent_skill_bindings (&quot;</span>
                <span class="s2">&quot;agent_id, skill_id, position&quot;</span>
                <span class="s2">&quot;) VALUES (&quot;</span>
                <span class="s2">&quot;:agent_id, :skill_id, :position&quot;</span>
                <span class="s2">&quot;)&quot;</span>
            <span class="p">),</span>
            <span class="p">{</span>
                <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="n">resolved_agent_id</span><span class="p">,</span>
                <span class="s2">&quot;skill_id&quot;</span><span class="p">:</span> <span class="n">skill_id</span><span class="p">,</span>
                <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">next_position</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">existing_pairs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="n">max_position_by_agent</span><span class="p">[</span><span class="n">resolved_agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_position</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_rag_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="n">rag_source_columns</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128) NOT NULL DEFAULT &#39;&#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(16) NOT NULL DEFAULT &#39;local&#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;local_path&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;git_repo&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(255)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;git_branch&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;git_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;drive_folder_id&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(255)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;collection&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128) NOT NULL DEFAULT &#39;&#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;last_indexed_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span>
        <span class="s2">&quot;last_error&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;indexed_file_count&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
        <span class="s2">&quot;indexed_chunk_count&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
        <span class="s2">&quot;indexed_file_types&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;index_schedule_value&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
        <span class="s2">&quot;index_schedule_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(16)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;index_schedule_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(16) NOT NULL DEFAULT &#39;fresh&#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;next_index_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span>
        <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="s2">&quot;rag_sources&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;rag_sources&quot;</span><span class="p">,</span> <span class="n">rag_source_columns</span><span class="p">)</span>

    <span class="n">rag_file_state_columns</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;source_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
        <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fingerprint&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(80)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;indexed&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL DEFAULT 0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;doc_type&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;chunk_count&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL DEFAULT 0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="s2">&quot;rag_source_file_states&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;rag_source_file_states&quot;</span><span class="p">,</span> <span class="n">rag_file_state_columns</span><span class="p">)</span>

    <span class="n">rag_settings_columns</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;provider&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(64)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="s2">&quot;rag_settings&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;rag_settings&quot;</span><span class="p">,</span> <span class="n">rag_settings_columns</span><span class="p">)</span>

    <span class="n">rag_retrieval_audit_columns</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;runtime_kind&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32) NOT NULL DEFAULT &#39;unknown&#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flowchart_run_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flowchart_node_run_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
        <span class="s2">&quot;provider&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32) NOT NULL DEFAULT &#39;chroma&#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;collection&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(255)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;source_id&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(255)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;chunk_id&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(255)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="s2">&quot;FLOAT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;snippet&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;retrieval_rank&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
        <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="s2">&quot;rag_retrieval_audits&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">_ensure_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;rag_retrieval_audits&quot;</span><span class="p">,</span> <span class="n">rag_retrieval_audit_columns</span><span class="p">)</span>

    <span class="n">_migrate_rag_source_schedule_modes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="n">_drop_rag_index_job_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_rag_source_schedule_modes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;rag_sources&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;rag_sources&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;index_schedule_mode&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE rag_sources &quot;</span>
            <span class="s2">&quot;SET index_schedule_mode = &#39;fresh&#39; &quot;</span>
            <span class="s2">&quot;WHERE index_schedule_mode IS NULL &quot;</span>
            <span class="s2">&quot;OR trim(index_schedule_mode) = &#39;&#39; &quot;</span>
            <span class="s2">&quot;OR lower(trim(index_schedule_mode)) NOT IN (&#39;fresh&#39;, &#39;delta&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_rag_index_job_modes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;rag_index_jobs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;rag_index_jobs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;mode&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE rag_index_jobs &quot;</span>
            <span class="s2">&quot;SET mode = &#39;fresh&#39; &quot;</span>
            <span class="s2">&quot;WHERE mode IS NULL &quot;</span>
            <span class="s2">&quot;OR trim(mode) = &#39;&#39; &quot;</span>
            <span class="s2">&quot;OR lower(trim(mode)) NOT IN (&#39;fresh&#39;, &#39;delta&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_rag_index_job_trigger_modes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;rag_index_jobs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;rag_index_jobs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;trigger_mode&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE rag_index_jobs &quot;</span>
            <span class="s2">&quot;SET trigger_mode = &#39;manual&#39; &quot;</span>
            <span class="s2">&quot;WHERE trigger_mode IS NULL &quot;</span>
            <span class="s2">&quot;OR trim(trigger_mode) = &#39;&#39; &quot;</span>
            <span class="s2">&quot;OR lower(trim(trigger_mode)) NOT IN (&#39;manual&#39;, &#39;scheduled&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_migrate_rag_index_job_statuses</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;rag_index_jobs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">_table_columns</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="s2">&quot;rag_index_jobs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;status&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;UPDATE rag_index_jobs &quot;</span>
            <span class="s2">&quot;SET status = &#39;queued&#39; &quot;</span>
            <span class="s2">&quot;WHERE status IS NULL &quot;</span>
            <span class="s2">&quot;OR trim(status) = &#39;&#39; &quot;</span>
            <span class="s2">&quot;OR lower(trim(status)) NOT IN &quot;</span>
            <span class="s2">&quot;(&#39;queued&#39;, &#39;running&#39;, &#39;pausing&#39;, &#39;paused&#39;, &#39;succeeded&#39;, &#39;failed&#39;, &#39;cancelled&#39;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_drop_rag_index_job_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Stage 6 cutover: Index Jobs are fully decommissioned in favor of flowchart RAG nodes.</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS ix_rag_index_jobs_source_id&quot;</span><span class="p">))</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS ix_rag_index_jobs_status&quot;</span><span class="p">))</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP INDEX IF EXISTS ix_rag_index_jobs_created_at&quot;</span><span class="p">))</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS rag_index_jobs&quot;</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_rag_indexes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;rag_sources&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_rag_sources_kind ON rag_sources (kind)&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS &quot;</span>
                <span class="s2">&quot;ix_rag_sources_next_index_at ON rag_sources (next_index_at)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS &quot;</span>
                <span class="s2">&quot;ix_rag_sources_schedule_mode ON rag_sources (index_schedule_mode)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;rag_source_file_states&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS &quot;</span>
                <span class="s2">&quot;ix_rag_source_file_states_source_id ON rag_source_file_states (source_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;rag_settings&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS &quot;</span>
                <span class="s2">&quot;ix_rag_settings_provider ON rag_settings (provider)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;rag_retrieval_audits&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS &quot;</span>
                <span class="s2">&quot;ix_rag_retrieval_audits_request_id ON rag_retrieval_audits (request_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS &quot;</span>
                <span class="s2">&quot;ix_rag_retrieval_audits_runtime_kind ON rag_retrieval_audits (runtime_kind)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS &quot;</span>
                <span class="s2">&quot;ix_rag_retrieval_audits_flowchart_run_id ON rag_retrieval_audits (flowchart_run_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS &quot;</span>
                <span class="s2">&quot;ix_rag_retrieval_audits_flowchart_node_run_id ON rag_retrieval_audits (flowchart_node_run_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_chat_schema</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE TABLE IF NOT EXISTS chat_threads (&quot;</span>
            <span class="s2">&quot;id INTEGER PRIMARY KEY, &quot;</span>
            <span class="s2">&quot;title VARCHAR(255) NOT NULL DEFAULT &#39;New Chat&#39;, &quot;</span>
            <span class="s2">&quot;status VARCHAR(32) NOT NULL DEFAULT &#39;active&#39;, &quot;</span>
            <span class="s2">&quot;model_id INTEGER, &quot;</span>
            <span class="s2">&quot;response_complexity VARCHAR(32) NOT NULL DEFAULT &#39;medium&#39;, &quot;</span>
            <span class="s2">&quot;selected_rag_collections_json TEXT, &quot;</span>
            <span class="s2">&quot;compaction_summary_json TEXT, &quot;</span>
            <span class="s2">&quot;last_activity_at DATETIME, &quot;</span>
            <span class="s2">&quot;created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(model_id) REFERENCES llm_models (id)&quot;</span>
            <span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_ensure_columns</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="s2">&quot;chat_threads&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(255) NOT NULL DEFAULT &#39;New Chat&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32) NOT NULL DEFAULT &#39;active&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;response_complexity&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32) NOT NULL DEFAULT &#39;medium&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;selected_rag_collections_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compaction_summary_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_activity_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE TABLE IF NOT EXISTS chat_messages (&quot;</span>
            <span class="s2">&quot;id INTEGER PRIMARY KEY, &quot;</span>
            <span class="s2">&quot;thread_id INTEGER NOT NULL, &quot;</span>
            <span class="s2">&quot;role VARCHAR(32) NOT NULL, &quot;</span>
            <span class="s2">&quot;content TEXT NOT NULL, &quot;</span>
            <span class="s2">&quot;token_estimate INTEGER, &quot;</span>
            <span class="s2">&quot;metadata_json TEXT, &quot;</span>
            <span class="s2">&quot;created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(thread_id) REFERENCES chat_threads (id)&quot;</span>
            <span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_ensure_columns</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="s2">&quot;chat_messages&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32) NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;token_estimate&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;metadata_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE TABLE IF NOT EXISTS chat_turns (&quot;</span>
            <span class="s2">&quot;id INTEGER PRIMARY KEY, &quot;</span>
            <span class="s2">&quot;thread_id INTEGER NOT NULL, &quot;</span>
            <span class="s2">&quot;request_id VARCHAR(64) NOT NULL, &quot;</span>
            <span class="s2">&quot;model_id INTEGER, &quot;</span>
            <span class="s2">&quot;user_message_id INTEGER, &quot;</span>
            <span class="s2">&quot;assistant_message_id INTEGER, &quot;</span>
            <span class="s2">&quot;status VARCHAR(32) NOT NULL DEFAULT &#39;succeeded&#39;, &quot;</span>
            <span class="s2">&quot;reason_code VARCHAR(128), &quot;</span>
            <span class="s2">&quot;error_message TEXT, &quot;</span>
            <span class="s2">&quot;selected_rag_collections_json TEXT, &quot;</span>
            <span class="s2">&quot;selected_mcp_server_keys_json TEXT, &quot;</span>
            <span class="s2">&quot;rag_health_state VARCHAR(64), &quot;</span>
            <span class="s2">&quot;context_limit_tokens INTEGER, &quot;</span>
            <span class="s2">&quot;context_usage_before INTEGER, &quot;</span>
            <span class="s2">&quot;context_usage_after INTEGER, &quot;</span>
            <span class="s2">&quot;history_tokens INTEGER, &quot;</span>
            <span class="s2">&quot;rag_tokens INTEGER, &quot;</span>
            <span class="s2">&quot;mcp_tokens INTEGER, &quot;</span>
            <span class="s2">&quot;compaction_applied BOOLEAN NOT NULL DEFAULT 0, &quot;</span>
            <span class="s2">&quot;compaction_metadata_json TEXT, &quot;</span>
            <span class="s2">&quot;citation_metadata_json TEXT, &quot;</span>
            <span class="s2">&quot;runtime_metadata_json TEXT, &quot;</span>
            <span class="s2">&quot;created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(thread_id) REFERENCES chat_threads (id), &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(model_id) REFERENCES llm_models (id), &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(user_message_id) REFERENCES chat_messages (id), &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(assistant_message_id) REFERENCES chat_messages (id)&quot;</span>
            <span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_ensure_columns</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="s2">&quot;chat_turns&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(64) NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;user_message_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;assistant_message_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(32) NOT NULL DEFAULT &#39;succeeded&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reason_code&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;selected_rag_collections_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;selected_mcp_server_keys_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rag_health_state&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(64)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;context_limit_tokens&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;context_usage_before&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;context_usage_after&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;history_tokens&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rag_tokens&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mcp_tokens&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compaction_applied&quot;</span><span class="p">:</span> <span class="s2">&quot;BOOLEAN NOT NULL DEFAULT 0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;compaction_metadata_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;citation_metadata_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;runtime_metadata_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE TABLE IF NOT EXISTS chat_activity_events (&quot;</span>
            <span class="s2">&quot;id INTEGER PRIMARY KEY, &quot;</span>
            <span class="s2">&quot;thread_id INTEGER NOT NULL, &quot;</span>
            <span class="s2">&quot;turn_id INTEGER, &quot;</span>
            <span class="s2">&quot;event_class VARCHAR(64) NOT NULL, &quot;</span>
            <span class="s2">&quot;event_type VARCHAR(64) NOT NULL, &quot;</span>
            <span class="s2">&quot;reason_code VARCHAR(128), &quot;</span>
            <span class="s2">&quot;message TEXT, &quot;</span>
            <span class="s2">&quot;metadata_json TEXT, &quot;</span>
            <span class="s2">&quot;created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(thread_id) REFERENCES chat_threads (id), &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(turn_id) REFERENCES chat_turns (id)&quot;</span>
            <span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_ensure_columns</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="s2">&quot;chat_activity_events&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;turn_id&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;event_class&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(64) NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(64) NOT NULL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reason_code&quot;</span><span class="p">:</span> <span class="s2">&quot;VARCHAR(128)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;metadata_json&quot;</span><span class="p">:</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE TABLE IF NOT EXISTS chat_thread_mcp_servers (&quot;</span>
            <span class="s2">&quot;chat_thread_id INTEGER NOT NULL, &quot;</span>
            <span class="s2">&quot;mcp_server_id INTEGER NOT NULL, &quot;</span>
            <span class="s2">&quot;PRIMARY KEY (chat_thread_id, mcp_server_id), &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(chat_thread_id) REFERENCES chat_threads (id), &quot;</span>
            <span class="s2">&quot;FOREIGN KEY(mcp_server_id) REFERENCES mcp_servers (id)&quot;</span>
            <span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_chat_indexes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;chat_threads&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_chat_threads_status &quot;</span>
                <span class="s2">&quot;ON chat_threads (status)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_chat_threads_model_id &quot;</span>
                <span class="s2">&quot;ON chat_threads (model_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_chat_threads_last_activity_at &quot;</span>
                <span class="s2">&quot;ON chat_threads (last_activity_at)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;chat_messages&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_chat_messages_thread_id &quot;</span>
                <span class="s2">&quot;ON chat_messages (thread_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;chat_turns&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_chat_turns_thread_id &quot;</span>
                <span class="s2">&quot;ON chat_turns (thread_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_chat_turns_request_id &quot;</span>
                <span class="s2">&quot;ON chat_turns (request_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_chat_turns_reason_code &quot;</span>
                <span class="s2">&quot;ON chat_turns (reason_code)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE UNIQUE INDEX IF NOT EXISTS uq_chat_turns_thread_request &quot;</span>
                <span class="s2">&quot;ON chat_turns (thread_id, request_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;chat_activity_events&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_chat_activity_events_thread_id &quot;</span>
                <span class="s2">&quot;ON chat_activity_events (thread_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_chat_activity_events_turn_id &quot;</span>
                <span class="s2">&quot;ON chat_activity_events (turn_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_chat_activity_events_event_class &quot;</span>
                <span class="s2">&quot;ON chat_activity_events (event_class)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_chat_activity_events_event_type &quot;</span>
                <span class="s2">&quot;ON chat_activity_events (event_type)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_chat_activity_events_reason_code &quot;</span>
                <span class="s2">&quot;ON chat_activity_events (reason_code)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_flowchart_indexes</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="n">required_tables</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;flowchart_nodes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flowchart_edges&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flowchart_runs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flowchart_run_nodes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;agent_tasks&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">required_tables</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">tables</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="n">statements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_flowchart_nodes_flowchart_id ON flowchart_nodes (flowchart_id)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_flowchart_edges_flowchart_id ON flowchart_edges (flowchart_id)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_flowchart_edges_source_node_id ON flowchart_edges (source_node_id)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_flowchart_edges_target_node_id ON flowchart_edges (target_node_id)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_flowchart_runs_flowchart_id ON flowchart_runs (flowchart_id)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_flowchart_run_nodes_flowchart_run_id ON flowchart_run_nodes (flowchart_run_id)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_flowchart_run_nodes_flowchart_node_id ON flowchart_run_nodes (flowchart_node_id)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_flowchart_run_nodes_agent_task_id ON flowchart_run_nodes (agent_task_id)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_flowchart_id ON agent_tasks (flowchart_id)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_flowchart_run_id ON agent_tasks (flowchart_run_id)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_flowchart_node_id ON agent_tasks (flowchart_node_id)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_workspace_identity_created_at ON agent_tasks (workspace_identity, created_at DESC)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_fallback_attempted_created_at ON agent_tasks (fallback_attempted, created_at DESC)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_cli_fallback_used_created_at ON agent_tasks (cli_fallback_used, created_at DESC)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_api_failure_category_created_at ON agent_tasks (api_failure_category, created_at DESC)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_dispatch_status_created_at ON agent_tasks (dispatch_status, created_at DESC)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_final_provider_created_at ON agent_tasks (final_provider, created_at DESC)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_dispatch_uncertain_created_at ON agent_tasks (dispatch_uncertain, created_at DESC)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agent_tasks_fallback_reason_created_at ON agent_tasks (fallback_reason, created_at DESC)&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">statement</span><span class="p">))</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;CREATE UNIQUE INDEX IF NOT EXISTS uq_agent_tasks_provider_dispatch_id &quot;</span>
            <span class="s2">&quot;ON agent_tasks (provider_dispatch_id) &quot;</span>
            <span class="s2">&quot;WHERE provider_dispatch_id IS NOT NULL&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;flowchart_node_skills&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS &quot;</span>
                <span class="s2">&quot;ix_flowchart_node_skills_skill_id ON flowchart_node_skills (skill_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;flowchart_node_attachments&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE INDEX IF NOT EXISTS &quot;</span>
                <span class="s2">&quot;ix_flowchart_node_attachments_attachment_id &quot;</span>
                <span class="s2">&quot;ON flowchart_node_attachments (attachment_id)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># SQLite supports partial indexes; this enforces exactly one start node per flowchart.</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;CREATE UNIQUE INDEX IF NOT EXISTS &quot;</span>
                <span class="s2">&quot;uq_flowchart_nodes_start_per_flowchart &quot;</span>
                <span class="s2">&quot;ON flowchart_nodes (flowchart_id) WHERE node_type = &#39;start&#39;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_drop_agent_utility_ownership</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_drop_columns_sqlite</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span>
        <span class="s2">&quot;agents&quot;</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;model_id&quot;</span><span class="p">},</span>
        <span class="n">index_statements</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;CREATE INDEX IF NOT EXISTS ix_agents_role_id ON agents (role_id)&quot;</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS agent_mcp_servers&quot;</span><span class="p">))</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS agent_scripts&quot;</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_canonical_workflow_views</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">_table_names</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;task_templates&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP VIEW IF EXISTS tasks&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;CREATE VIEW tasks AS SELECT * FROM task_templates&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="s2">&quot;agent_tasks&quot;</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;DROP VIEW IF EXISTS node_runs&quot;</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;CREATE VIEW node_runs AS SELECT * FROM agent_tasks&quot;</span><span class="p">))</span>


<div class="viewcode-block" id="session_scope">
<a class="viewcode-back" href="../../api/core.db.html#core.db.session_scope">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">session_scope</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">SessionLocal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database session is not initialized&quot;</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">SessionLocal</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">session</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, llmctl contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>