apiVersion: apps/v1
kind: Deployment
metadata:
  name: llmctl-studio-frontend
  namespace: llmctl
spec:
  template:
    spec:
      containers:
        - name: studio-frontend
          image: node:22-alpine
          workingDir: /app/app/llmctl-studio-frontend
          command:
            - /bin/sh
            - -lc
          args:
            - |
              set -eu
              hash_file="node_modules/.llmctl-lock-hash"
              install_mode_file="node_modules/.llmctl-install-mode"
              if [ -f package-lock.json ]; then
                lock_hash="$(sha256sum package-lock.json | awk '{print $1}')"
                if [ ! -f "$hash_file" ] || [ "$lock_hash" != "$(cat "$hash_file")" ] || [ ! -f "$install_mode_file" ] || [ "$(cat "$install_mode_file")" != "ci" ]; then
                  npm ci --no-audit --no-fund
                  printf '%s' "$lock_hash" > "$hash_file"
                  printf 'ci' > "$install_mode_file"
                fi
              else
                pkg_hash="$(sha256sum package.json | awk '{print $1}')"
                if [ ! -f "$hash_file" ] || [ "$pkg_hash" != "$(cat "$hash_file")" ] || [ ! -f "$install_mode_file" ] || [ "$(cat "$install_mode_file")" != "install" ]; then
                  npm install --no-audit --no-fund
                  printf '%s' "$pkg_hash" > "$hash_file"
                  printf 'install' > "$install_mode_file"
                fi
              fi
              exec npm run dev -- --host 0.0.0.0 --port 8080 --strictPort
          env:
            - name: CHOKIDAR_USEPOLLING
              value: "true"
            - name: CHOKIDAR_INTERVAL
              value: "250"
            - name: WATCHPACK_POLLING
              value: "true"
            - name: VITE_DEV_API_PROXY_TARGET
              value: http://llmctl-studio-backend.llmctl.svc.cluster.local:5155
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 15
            periodSeconds: 20
          volumeMounts:
            - name: studio-frontend-project-code
              mountPath: /app
            - name: studio-frontend-node-modules
              mountPath: /app/app/llmctl-studio-frontend/node_modules
      volumes:
        - name: studio-frontend-project-code
          hostPath:
            path: /workspace/llmctl
            type: Directory
        - name: studio-frontend-node-modules
          emptyDir: {}
