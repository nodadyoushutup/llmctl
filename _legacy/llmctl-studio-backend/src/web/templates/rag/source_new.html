{% extends "base.html" %}

{% block action_header %}
  <div class="action-header-actions">
    <a class="btn btn-secondary" href="{{ url_for('rag.sources_page') }}">
      <i class="fa-solid fa-arrow-left"></i>
      back to sources
    </a>
  </div>
{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header">
    <div>
      <h2 class="section-title">New Source</h2>
      <p class="muted" style="margin-top: 6px;">
        Configure a source and optional indexing schedule.
      </p>
    </div>
  </div>

  {% if not github_connected %}
    <div class="alert alert-warning" style="margin-top: 16px;">
      GitHub PAT is not set in Integrations. GitHub source repo loading will fail until configured.
    </div>
  {% endif %}

  {% if not google_drive_connected %}
    <div class="alert alert-warning" style="margin-top: 16px;">
      Google Workspace service account JSON is not set in Integrations. Google Drive verification and indexing will fail.
    </div>
  {% elif google_drive_service_email %}
    <div class="alert alert-info" style="margin-top: 16px;">
      Google Workspace service account: <span class="mono">{{ google_drive_service_email }}</span>
    </div>
  {% endif %}

  <form method="post" action="{{ url_for('rag.create_source_page') }}" class="form-grid" data-rag-source-form>
    <label class="label">
      Source name
      <input class="input" type="text" name="source_name" placeholder="Engineering Docs" required />
    </label>

    <label class="label">
      Source kind
      <select class="input" name="source_kind" id="source-kind" required>
        <option value="{{ source_kind_local }}">Local folder</option>
        <option value="{{ source_kind_github }}">GitHub repo</option>
        <option value="{{ source_kind_google_drive }}">Google Drive folder</option>
      </select>
    </label>

    <label class="label" style="grid-column: 1 / -1;">
      Schedule
      <div class="form-grid" style="grid-template-columns: minmax(140px, 0.8fr) minmax(160px, 1fr) minmax(180px, 1fr); gap: 10px;">
        <input
          class="input"
          type="number"
          min="1"
          step="1"
          name="source_index_schedule_value"
          placeholder="2"
        />
        <select class="input" name="source_index_schedule_unit">
          <option value="">Not scheduled</option>
          <option value="minutes">Minutes</option>
          <option value="hours">Hours</option>
          <option value="days">Days</option>
          <option value="weeks">Weeks</option>
        </select>
        <select class="input" name="source_index_schedule_mode">
          <option value="{{ index_mode_fresh }}">Fresh mode</option>
          <option value="{{ index_mode_delta }}">Delta mode</option>
        </select>
      </div>
      <span class="muted" style="font-size: 12px; margin-top: 6px; display: block;">
        Provide interval value + unit to enable a schedule.
      </span>
    </label>

    <label class="label rag-source-field-local" style="grid-column: 1 / -1;">
      Local path
      <input class="input" type="text" name="source_local_path" placeholder="/workspace/docs" />
    </label>

    <label class="label rag-source-field-github" style="grid-column: 1 / -1; display: none;">
      GitHub repository
      <select class="input" name="source_git_repo" id="github-repo-select" data-selected-value="">
        <option value="">Select repository</option>
      </select>
      <span class="muted" id="github-repo-status" style="font-size: 12px; margin-top: 6px; display: block;">
        Load repositories from your configured GitHub PAT.
      </span>
    </label>

    <label class="label rag-source-field-github" style="grid-column: 1 / -1; display: none;">
      Branch
      <input class="input" type="text" name="source_git_branch" placeholder="main" />
    </label>

    <label class="label rag-source-field-google-drive" style="grid-column: 1 / -1; display: none;">
      Google Drive folder ID
      <div class="input-row">
        <input
          class="input"
          type="text"
          name="source_drive_folder_id"
          id="drive-folder-id"
          placeholder="1AbCdEfGhIjKlMn..."
        />
        <button type="button" class="btn btn-secondary" id="drive-folder-verify-btn">
          <i class="fa-solid fa-check"></i>
          verify
        </button>
      </div>
      <span class="muted" id="drive-folder-status" style="font-size: 12px; margin-top: 6px; display: block;">
        Verify that the Google Workspace service account can access this folder.
      </span>
    </label>

    <div class="form-actions">
      <button class="btn btn-primary" type="submit">
        <i class="fa-solid fa-plus"></i>
        create source
      </button>
    </div>
  </form>
</section>

<script src="{{ url_for('static', filename='rag/app.js') }}"></script>
{% endblock %}
