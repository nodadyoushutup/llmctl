{% extends "base.html" %}

{% block action_header %}
  <div class="action-header-actions">
    <a class="btn btn-secondary" href="{{ url_for('rag.source_detail_page', source_id=source.id) }}">
      <i class="fa-solid fa-arrow-left"></i>
      back to source
    </a>
  </div>
{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header">
    <div>
      <h2 class="section-title">Edit Source</h2>
      <p class="muted" style="margin-top: 6px;">
        Update source configuration and schedule settings.
      </p>
    </div>
  </div>

  {% if not github_connected %}
    <div class="alert alert-warning" style="margin-top: 16px;">
      GitHub PAT is not set in Integrations. GitHub source repo loading will fail until configured.
    </div>
  {% endif %}

  {% if not google_drive_connected %}
    <div class="alert alert-warning" style="margin-top: 16px;">
      Google Workspace service account JSON is not set in Integrations. Google Drive verification and indexing will fail.
    </div>
  {% elif google_drive_service_email %}
    <div class="alert alert-info" style="margin-top: 16px;">
      Google Workspace service account: <span class="mono">{{ google_drive_service_email }}</span>
    </div>
  {% endif %}

  <form method="post" action="{{ url_for('rag.update_source_page', source_id=source.id) }}" class="form-grid" data-rag-source-form>
    <label class="label">
      Source name
      <input class="input" type="text" name="source_name" value="{{ source.name }}" required />
    </label>

    <label class="label">
      Source kind
      <select class="input" name="source_kind" id="source-kind" required>
        <option value="{{ source_kind_local }}" {% if source.kind == source_kind_local %}selected{% endif %}>Local folder</option>
        <option value="{{ source_kind_github }}" {% if source.kind == source_kind_github %}selected{% endif %}>GitHub repo</option>
        <option value="{{ source_kind_google_drive }}" {% if source.kind == source_kind_google_drive %}selected{% endif %}>Google Drive folder</option>
      </select>
    </label>

    <label class="label" style="grid-column: 1 / -1;">
      Schedule
      <div class="form-grid" style="grid-template-columns: minmax(140px, 0.8fr) minmax(160px, 1fr) minmax(180px, 1fr); gap: 10px;">
        <input
          class="input"
          type="number"
          min="1"
          step="1"
          name="source_index_schedule_value"
          value="{{ source.index_schedule_value or '' }}"
          placeholder="2"
        />
        {% set schedule_unit = source.index_schedule_unit or '' %}
        <select class="input" name="source_index_schedule_unit">
          <option value="" {% if not schedule_unit %}selected{% endif %}>Not scheduled</option>
          <option value="minutes" {% if schedule_unit == 'minutes' %}selected{% endif %}>Minutes</option>
          <option value="hours" {% if schedule_unit == 'hours' %}selected{% endif %}>Hours</option>
          <option value="days" {% if schedule_unit == 'days' %}selected{% endif %}>Days</option>
          <option value="weeks" {% if schedule_unit == 'weeks' %}selected{% endif %}>Weeks</option>
        </select>
        {% set schedule_mode = source.index_schedule_mode or index_mode_fresh %}
        <select class="input" name="source_index_schedule_mode">
          <option value="{{ index_mode_fresh }}" {% if schedule_mode == index_mode_fresh %}selected{% endif %}>Fresh mode</option>
          <option value="{{ index_mode_delta }}" {% if schedule_mode == index_mode_delta %}selected{% endif %}>Delta mode</option>
        </select>
      </div>
      <span class="muted" style="font-size: 12px; margin-top: 6px; display: block;">
        Provide interval value + unit to enable a schedule.
      </span>
    </label>

    <label class="label rag-source-field-local" style="grid-column: 1 / -1;">
      Local path
      <input class="input" type="text" name="source_local_path" value="{{ source.local_path or '' }}" />
    </label>

    <label class="label rag-source-field-github" style="grid-column: 1 / -1; display: none;">
      GitHub repository
      <select
        class="input"
        name="source_git_repo"
        id="github-repo-select"
        data-selected-value="{{ source.git_repo or '' }}"
      >
        {% if source.git_repo %}
          <option value="{{ source.git_repo }}" selected>{{ source.git_repo }}</option>
        {% else %}
          <option value="">Select repository</option>
        {% endif %}
      </select>
      <span class="muted" id="github-repo-status" style="font-size: 12px; margin-top: 6px; display: block;">
        Load repositories from your configured GitHub PAT.
      </span>
    </label>

    <label class="label rag-source-field-github" style="grid-column: 1 / -1; display: none;">
      Branch
      <input class="input" type="text" name="source_git_branch" value="{{ source.git_branch or '' }}" placeholder="main" />
    </label>

    <label class="label rag-source-field-google-drive" style="grid-column: 1 / -1; display: none;">
      Google Drive folder ID
      <div class="input-row">
        <input
          class="input"
          type="text"
          name="source_drive_folder_id"
          id="drive-folder-id"
          value="{{ source.drive_folder_id or '' }}"
          placeholder="1AbCdEfGhIjKlMn..."
        />
        <button type="button" class="btn btn-secondary" id="drive-folder-verify-btn">
          <i class="fa-solid fa-check"></i>
          verify
        </button>
      </div>
      <span class="muted" id="drive-folder-status" style="font-size: 12px; margin-top: 6px; display: block;">
        Verify that the Google Workspace service account can access this folder.
      </span>
    </label>

    <div class="form-actions">
      <button class="btn btn-primary" type="submit">
        <i class="fa-solid fa-floppy-disk"></i>
        save source
      </button>
    </div>
  </form>
</section>

<script src="{{ url_for('static', filename='rag/app.js') }}"></script>
{% endblock %}
