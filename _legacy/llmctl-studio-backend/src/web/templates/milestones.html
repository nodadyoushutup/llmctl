{% extends "base.html" %}

{% macro pagination_controls(pagination) %}
  <nav class="pagination" aria-label="Milestones pages">
    {% if pagination.prev_url %}
      <a class="pagination-btn" href="{{ pagination.prev_url }}">Prev</a>
    {% else %}
      <span class="pagination-btn is-disabled" aria-disabled="true">Prev</span>
    {% endif %}
    <div class="pagination-pages">
      {% for item in pagination.page_items %}
        {% if item.is_gap %}
          <span class="pagination-ellipsis">&hellip;</span>
        {% elif item.is_current %}
          <span class="pagination-link is-active" aria-current="page">{{ item.label }}</span>
        {% else %}
          <a class="pagination-link" href="{{ item.url }}">{{ item.label }}</a>
        {% endif %}
      {% endfor %}
    </div>
    {% if pagination.next_url %}
      <a class="pagination-btn" href="{{ pagination.next_url }}">Next</a>
    {% else %}
      <span class="pagination-btn is-disabled" aria-disabled="true">Next</span>
    {% endif %}
  </nav>
{% endmacro %}

{% block action_header %}
  <div class="pagination-bar pagination-bar-header">
    {{ pagination_controls(pagination) }}
  </div>
{% endblock %}

{% block content %}
<section class="card workflow-list-card">
  <div class="card-header">
    <h2 class="section-title">Milestones</h2>
  </div>
  {% if milestones %}
    <div class="workflow-list-table-shell">
      <table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Owner</th>
            <th>Progress</th>
            <th>Due date</th>
            <th class="table-actions-cell">Edit</th>
          </tr>
        </thead>
        <tbody>
          {% for milestone in milestones %}
            <tr
              class="table-row-link"
              data-href="{{ url_for('agents.view_milestone', milestone_id=milestone.id) }}"
            >
              <td>
                <a href="{{ url_for('agents.view_milestone', milestone_id=milestone.id) }}">
                  <p>{{ milestone.name }}</p>
                </a>
              </td>
              <td>
                {% set status = milestone_status_value(milestone) %}
                <span class="status {{ milestone_status_classes.get(status, 'status-idle') }}">
                  {{ milestone_status_labels.get(status, status) }}
                </span>
              </td>
              <td class="muted">{{ milestone_priority_labels.get(milestone_priority_value(milestone), "-") }}</td>
              <td class="muted">{{ milestone.owner | default("-", true) }}</td>
              <td class="muted">
                {% set progress = milestone_progress_value(milestone) %}
                {{ progress }}%
              </td>
              <td class="muted">
                {{ human_time(milestone.due_date) }}
              </td>
              <td class="table-actions-cell">
                <a
                  class="icon-button"
                  href="{{ url_for('agents.edit_milestone', milestone_id=milestone.id) }}"
                  aria-label="Edit milestone"
                >
                  <i class="fa-solid fa-pen-to-square"></i>
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 16px;">
      No milestones found yet. Add a Milestone node in a flowchart to create one.
    </p>
  {% endif %}
</section>

<script>
  const milestoneRows = document.querySelectorAll(".table-row-link");
  milestoneRows.forEach((row) => {
    row.addEventListener("click", (event) => {
      const target = event.target;
      if (
        target.closest("a") ||
        target.closest("button") ||
        target.closest("input") ||
        target.closest("select") ||
        target.closest("textarea") ||
        target.closest("label") ||
        target.closest("summary") ||
        target.closest("details")
      ) {
        return;
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });
  });
</script>
{% endblock %}
