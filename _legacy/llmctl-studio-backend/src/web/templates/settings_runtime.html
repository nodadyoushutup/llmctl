{% extends "settings_layout.html" %}
{% set runtime_section = runtime_section if runtime_section is defined else "node" %}
{% set runtime_nav = [
  {
    "id": "node",
    "label": "Node Runtime",
    "icon": "fa-solid fa-diagram-project",
    "url": url_for("agents.settings_runtime"),
  },
  {
    "id": "rag",
    "label": "RAG Runtime",
    "icon": "fa-solid fa-database",
    "url": url_for("agents.settings_runtime_rag"),
  },
  {
    "id": "chat",
    "label": "Chat Runtime",
    "icon": "fa-solid fa-comments",
    "url": url_for("agents.settings_runtime_chat"),
  },
] %}

{% block topbar_actions %}
{% endblock %}

{% block settings_content %}
<style>
  .runtime-layout {
    display: grid;
    grid-template-columns: minmax(220px, 260px) minmax(0, 1fr);
    gap: 18px;
    align-items: start;
  }

  .runtime-sidebar {
    border-radius: 18px;
    border: 1px solid var(--line);
    background: rgba(17, 24, 33, 0.9);
    padding: 14px;
    box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
    position: sticky;
    top: 0;
  }

  .runtime-sidebar-title {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    color: var(--muted);
  }

  .runtime-sidebar-nav {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .runtime-sidebar-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    border-radius: 12px;
    border: 1px solid var(--line);
    background: rgba(11, 15, 20, 0.6);
    color: var(--muted);
    padding: 10px 12px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    font-weight: 600;
    transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease;
  }

  .runtime-sidebar-link-main {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .runtime-sidebar-link-main i {
    width: 14px;
    text-align: center;
  }

  .runtime-sidebar-link .fa-chevron-right {
    font-size: 10px;
    color: var(--muted);
  }

  .runtime-sidebar-link:hover {
    border-color: rgba(255, 122, 24, 0.4);
    color: #fff;
  }

  .runtime-sidebar-link.is-active {
    background: rgba(255, 122, 24, 0.15);
    border-color: rgba(255, 122, 24, 0.55);
    color: #fff;
  }

  .runtime-sidebar-link.is-active .fa-chevron-right {
    color: var(--accent);
  }

  .runtime-layout > .stack {
    min-width: 0;
  }

  @media (max-width: 980px) {
    .runtime-layout {
      grid-template-columns: minmax(0, 1fr);
    }

    .runtime-sidebar {
      position: static;
    }

    .runtime-sidebar-nav {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
  }

  @media (max-width: 640px) {
    .runtime-sidebar-nav {
      grid-template-columns: minmax(0, 1fr);
    }
  }
</style>
<section class="runtime-layout">
  <aside class="runtime-sidebar" aria-label="Runtime sections">
    <p class="runtime-sidebar-title">Runtime Sections</p>
    <nav class="runtime-sidebar-nav">
      {% for item in runtime_nav %}
        <a
          href="{{ item.url }}"
          class="runtime-sidebar-link{% if runtime_section == item.id %} is-active{% endif %}"
        >
          <span class="runtime-sidebar-link-main">
            <i class="{{ item.icon }}"></i>
            <span>{{ item.label }}</span>
          </span>
          <i class="fa-solid fa-chevron-right"></i>
        </a>
      {% endfor %}
    </nav>
  </aside>
  <section class="stack">
  {% if runtime_section == "node" %}
    <section class="card">
      <div class="card-header">
        <h2 class="section-title">Runtime Hints</h2>
      </div>
      <p class="muted" style="margin-top: 12px;">
        Expectations for polling, revocation, and provider defaults.
      </p>
      <div class="grid grid-3" style="margin-top: 20px;">
        <div class="subcard">
          <p class="eyebrow">polling</p>
          <p style="margin-top: 8px;">
            Agents check in every {{ config.AGENT_POLL_SECONDS }} seconds.
          </p>
        </div>
        <div class="subcard">
          <p class="eyebrow">revocation</p>
          <p style="margin-top: 8px;">
            Revoke on stop is
            {{ "enabled" if config.CELERY_REVOKE_ON_STOP else "disabled" }}.
          </p>
        </div>
        <div class="subcard">
          <p class="eyebrow">provider</p>
          <p style="margin-top: 8px;">
            {% if llm_config.provider %}
              Using {{ llm_config.label }} via {{ llm_config.command }} (model {{ llm_config.model }}).
            {% else %}
              No default provider configured. Agents use the default model if set.
            {% endif %}
          </p>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top: 16px;">
      <div class="card-header">
        <h2 class="section-title">Node Executor Runtime</h2>
      </div>
      <p class="muted" style="margin-top: 12px;">
        Configure Kubernetes-only node execution, timeouts, and pod lifecycle settings.
      </p>
      <form method="post" action="{{ url_for('agents.update_node_executor_runtime_settings_route') }}" class="form-grid" style="margin-top: 16px;">
        <div class="grid grid-2" style="grid-column: 1 / -1; gap: 10px;">
          <label class="label">
            Provider
            <select class="input" name="provider" disabled>
              {% for option in node_executor_options.provider_options %}
                <option value="{{ option.value }}" {% if option.value == node_executor_settings.provider %}selected{% endif %}>
                  {{ option.label }}
                </option>
              {% endfor %}
            </select>
          </label>
          <label class="label">
            Workspace Identity Key
            <input class="input" type="text" name="workspace_identity_key" value="{{ node_executor_settings.workspace_identity_key }}" />
          </label>
        </div>
        <input type="hidden" name="provider" value="kubernetes" />

        <div class="grid grid-3" style="grid-column: 1 / -1; gap: 10px;">
          <label class="label">
            Dispatch Timeout (seconds)
            <input class="input" type="number" min="5" max="3600" name="dispatch_timeout_seconds" value="{{ node_executor_settings.dispatch_timeout_seconds }}" />
          </label>
          <label class="label">
            Execution Timeout (seconds)
            <input class="input" type="number" min="30" max="86400" name="execution_timeout_seconds" value="{{ node_executor_settings.execution_timeout_seconds }}" />
          </label>
          <label class="label">
            Log Collection Timeout (seconds)
            <input class="input" type="number" min="1" max="600" name="log_collection_timeout_seconds" value="{{ node_executor_settings.log_collection_timeout_seconds }}" />
          </label>
        </div>

        <div class="grid grid-3" style="grid-column: 1 / -1; gap: 10px;">
          <label class="label">
            Cancel Grace Timeout (seconds)
            <input class="input" type="number" min="1" max="300" name="cancel_grace_timeout_seconds" value="{{ node_executor_settings.cancel_grace_timeout_seconds }}" />
          </label>
          <label class="label">
            Job TTL After Completion (seconds)
            <input class="input" type="number" min="60" max="86400" name="k8s_job_ttl_seconds" value="{{ node_executor_settings.k8s_job_ttl_seconds }}" />
          </label>
        </div>

        <div class="grid grid-2" style="grid-column: 1 / -1; gap: 10px;">
          <label class="label">
            Kubernetes Kubeconfig (write-only)
            <textarea class="input" name="k8s_kubeconfig" rows="3" placeholder="Paste kubeconfig to replace current secret.">{{ node_executor_settings.k8s_kubeconfig }}</textarea>
            <p class="muted" style="margin-top: 8px; font-size: 12px;">
              {% if node_executor_settings.k8s_kubeconfig_is_set == "true" %}
                secret is configured
              {% else %}
                secret is not configured
              {% endif %}
            </p>
            {% if node_executor_settings.k8s_kubeconfig_fingerprint %}
              <p class="muted" style="margin-top: 6px; font-size: 12px;">
                fingerprint: {{ node_executor_settings.k8s_kubeconfig_fingerprint }}
              </p>
            {% endif %}
            {% if node_executor_settings.k8s_kubeconfig_updated_at %}
              <p class="muted" style="margin-top: 6px; font-size: 12px;">
                updated: {{ node_executor_settings.k8s_kubeconfig_updated_at }}
              </p>
            {% endif %}
            <label style="display: inline-flex; gap: 8px; align-items: center; margin-top: 6px;">
              <input type="checkbox" name="k8s_kubeconfig_clear" value="true" />
              clear stored kubeconfig secret
            </label>
          </label>
        </div>

        <div class="grid grid-3" style="grid-column: 1 / -1; gap: 10px;">
          <label class="label">
            Kubernetes Namespace
            <input class="input" type="text" name="k8s_namespace" value="{{ node_executor_settings.k8s_namespace }}" />
          </label>
          <label class="label">
            Kubernetes Image
            <input class="input" type="text" name="k8s_image" value="{{ node_executor_settings.k8s_image }}" />
          </label>
          <label class="label">
            Kubernetes Service Account
            <input class="input" type="text" name="k8s_service_account" value="{{ node_executor_settings.k8s_service_account }}" />
          </label>
        </div>

        <div class="grid grid-2" style="grid-column: 1 / -1; gap: 10px;">
          <label class="label">
            Kubernetes GPU Limit (nvidia.com/gpu)
            <input class="input" type="number" min="0" max="8" name="k8s_gpu_limit" value="{{ node_executor_settings.k8s_gpu_limit }}" />
            <p class="muted" style="margin-top: 8px; font-size: 12px;">
              Set to <code>0</code> to disable GPU requests for executor Jobs.
            </p>
          </label>
        </div>

        <label class="label" style="grid-column: 1 / -1;">
          Kubernetes Image Pull Secrets JSON
          <textarea class="input" name="k8s_image_pull_secrets_json" rows="3">{{ node_executor_settings.k8s_image_pull_secrets_json }}</textarea>
        </label>

        <div class="row" style="grid-column: 1 / -1; gap: 16px; margin-top: 8px;">
          <label style="display: inline-flex; gap: 8px; align-items: center;">
            <input type="checkbox" name="cancel_force_kill_enabled" value="true" {% if node_executor_settings.cancel_force_kill_enabled == "true" %}checked{% endif %} />
            force kill after grace timeout
          </label>
          <label style="display: inline-flex; gap: 8px; align-items: center;">
            <input type="checkbox" name="k8s_in_cluster" value="true" {% if node_executor_settings.k8s_in_cluster == "true" %}checked{% endif %} />
            use in-cluster kubernetes auth
          </label>
        </div>

        <button type="submit" class="btn btn-secondary" style="margin-top: 12px;">
          <i class="fa-solid fa-floppy-disk"></i>
          save node executor settings
        </button>
      </form>
    </section>

    <section class="card" style="margin-top: 16px;">
      <div class="card-header">
        <h2 class="section-title">Node Skill Compatibility</h2>
      </div>
      <p class="muted" style="margin-top: 12px;">
        Controls transition behavior for legacy clients that still send node-level <code>skill_ids</code>.
      </p>
      <form method="post" action="{{ url_for('agents.update_node_skill_binding_mode_route') }}" style="margin-top: 16px;">
        <label for="node-skill-binding-mode" style="display: block; margin-bottom: 8px;">Compatibility mode</label>
        <select id="node-skill-binding-mode" name="node_skill_binding_mode" class="input" style="max-width: 280px;">
          {% for option in node_skill_binding_modes %}
            <option value="{{ option.value }}" {% if option.value == node_skill_binding_mode %}selected{% endif %}>
              {{ option.label }}
            </option>
          {% endfor %}
        </select>
        <ul class="muted" style="margin: 12px 0 0 20px;">
          {% for option in node_skill_binding_modes %}
            <li><code>{{ option.value }}</code>: {{ option.description }}</li>
          {% endfor %}
        </ul>
        <button type="submit" class="btn btn-secondary" style="margin-top: 12px;">
          <i class="fa-solid fa-floppy-disk"></i>
          save node skill compatibility mode
        </button>
      </form>
    </section>

    <section class="card" style="margin-top: 16px;">
      <div class="card-header">
        <h2 class="section-title">Instruction Adapter Flags</h2>
      </div>
      <p class="muted" style="margin-top: 12px;">
        Native file materialization and prompt-envelope fallback policy per provider.
      </p>
      <form method="post" action="{{ url_for('agents.update_instruction_runtime_settings_route') }}" style="margin-top: 16px;">
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Provider</th>
                <th>Native mode</th>
                <th>Fallback mode</th>
              </tr>
            </thead>
            <tbody>
              {% for row in instruction_runtime_flags %}
                <tr>
                  <td>{{ row.label }}</td>
                  <td>
                    <label style="display: inline-flex; gap: 8px; align-items: center;">
                      <input
                        type="checkbox"
                        name="{{ row.native_key }}"
                        value="true"
                        {% if row.native_enabled %}checked{% endif %}
                        {% if not row.supports_native %}disabled{% endif %}
                      />
                      enabled
                    </label>
                  </td>
                  <td>
                    <label style="display: inline-flex; gap: 8px; align-items: center;">
                      <input
                        type="checkbox"
                        name="{{ row.fallback_key }}"
                        value="true"
                        {% if row.fallback_enabled %}checked{% endif %}
                      />
                      enabled
                    </label>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <button type="submit" class="btn btn-secondary" style="margin-top: 12px;">
          <i class="fa-solid fa-floppy-disk"></i>
          save instruction adapter flags
        </button>
      </form>
    </section>
  {% endif %}

  {% if runtime_section == "rag" %}
    <section class="card">
      <div class="card-header">
        <div>
          <h2 class="section-title">RAG Runtime</h2>
          <p class="muted" style="margin-top: 6px;">
            RAG-specific providers, model defaults, indexing workers, and chat controls.
          </p>
        </div>
        <span class="status {% if rag_chroma_ready %}status-success{% else %}status-warning{% endif %}">
          {% if rag_chroma_ready %}ready{% else %}needs chroma config{% endif %}
        </span>
      </div>
      {% if not rag_chroma_ready %}
        <div class="alert alert-warning" style="margin-top: 16px;">
          RAG is set to use ChromaDB, but Chroma integration host/port is missing.
        </div>
      {% endif %}
      <form method="post" action="{{ url_for('agents.update_rag_settings') }}" class="form-grid">
        <div class="grid grid-3" style="grid-column: 1 / -1; gap: 10px;">
          <label class="label">
            RAG DB Provider
            <select class="input" name="rag_db_provider">
              {% for provider in rag_db_provider_choices %}
                <option
                  value="{{ provider }}"
                  {% if provider == rag_settings.get('db_provider', 'chroma') %}selected{% endif %}
                >
                  {% if provider == 'chroma' %}ChromaDB (v1){% else %}{{ provider }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </label>
          <label class="label">
            Embedding Provider
            <select class="input" name="rag_embed_provider">
              {% for provider in rag_model_provider_choices %}
                <option
                  value="{{ provider }}"
                  {% if provider == rag_settings.get('embed_provider', 'openai') %}selected{% endif %}
                >
                  {{ provider|upper }}
                </option>
              {% endfor %}
            </select>
          </label>
          <label class="label">
            Chat Provider
            <select class="input" name="rag_chat_provider">
              {% for provider in rag_model_provider_choices %}
                <option
                  value="{{ provider }}"
                  {% if provider == rag_settings.get('chat_provider', 'openai') %}selected{% endif %}
                >
                  {{ provider|upper }}
                </option>
              {% endfor %}
            </select>
          </label>
        </div>

        <p class="muted" style="grid-column: 1 / -1; margin-top: 6px;">
          Provider auth is managed in <a href="{{ url_for('agents.settings_provider') }}">Settings > Provider</a>.
          RAG runtime reuses those credentials.
        </p>

        <div class="grid grid-2" style="grid-column: 1 / -1; gap: 10px; margin-top: 8px;">
          <div class="subcard">
            <div class="row-between">
              <p class="eyebrow">OpenAI</p>
              <span class="status {% if rag_openai_auth_configured %}status-success{% else %}status-warning{% endif %}">
                {% if rag_openai_auth_configured %}auth configured{% else %}configure in provider{% endif %}
              </span>
            </div>
            <div class="grid" style="margin-top: 10px; gap: 10px;">
              <label class="label">
                Embedding Model
                <select class="input" name="rag_openai_embed_model">
                  {% for option in rag_openai_embed_model_options %}
                    <option value="{{ option.value }}" {% if option.value == rag_settings.get('openai_embed_model') %}selected{% endif %}>
                      {{ option.label }}
                    </option>
                  {% endfor %}
                </select>
              </label>
              <label class="label">
                Chat Model
                <select class="input" name="rag_openai_chat_model">
                  {% for option in rag_openai_chat_model_options %}
                    <option value="{{ option.value }}" {% if option.value == rag_settings.get('openai_chat_model') %}selected{% endif %}>
                      {{ option.label }}
                    </option>
                  {% endfor %}
                </select>
              </label>
            </div>
          </div>

          <div class="subcard">
            <div class="row-between">
              <p class="eyebrow">Gemini</p>
              <span class="status {% if rag_gemini_auth_configured %}status-success{% else %}status-warning{% endif %}">
                {% if rag_gemini_auth_configured %}auth configured{% else %}configure in provider{% endif %}
              </span>
            </div>
            <div class="grid" style="margin-top: 10px; gap: 10px;">
              <label class="label">
                Embedding Model
                <select class="input" name="rag_gemini_embed_model">
                  {% for option in rag_gemini_embed_model_options %}
                    <option value="{{ option.value }}" {% if option.value == rag_settings.get('gemini_embed_model') %}selected{% endif %}>
                      {{ option.label }}
                    </option>
                  {% endfor %}
                </select>
              </label>
              <label class="label">
                Chat Model
                <select class="input" name="rag_gemini_chat_model">
                  {% for option in rag_gemini_chat_model_options %}
                    <option value="{{ option.value }}" {% if option.value == rag_settings.get('gemini_chat_model') %}selected{% endif %}>
                      {{ option.label }}
                    </option>
                  {% endfor %}
                </select>
              </label>
            </div>
          </div>
        </div>

        <label class="label">
          Chat Temperature
          <input
            class="input"
            type="number"
            step="0.1"
            min="0"
            max="2"
            name="rag_chat_temperature"
            value="{{ rag_settings.get('chat_temperature', '0.2') }}"
          />
        </label>
        <label class="label">
          Default Response Style
          <select class="input" name="rag_chat_response_style">
            {% for style in rag_chat_response_style_choices %}
              <option
                value="{{ style }}"
                {% if style == rag_settings.get('chat_response_style', 'high') %}selected{% endif %}
              >
                {{ style|capitalize }}
              </option>
            {% endfor %}
          </select>
        </label>
        <label class="label">
          Default Top K
          <input
            class="input"
            type="number"
            min="1"
            max="20"
            name="rag_chat_top_k"
            value="{{ rag_settings.get('chat_top_k', '5') }}"
          />
        </label>
        <label class="label">
          Default Max History
          <input
            class="input"
            type="number"
            min="1"
            max="50"
            name="rag_chat_max_history"
            value="{{ rag_settings.get('chat_max_history', '8') }}"
          />
        </label>
        <label class="label">
          Max Context Characters
          <input
            class="input"
            type="number"
            min="1000"
            name="rag_chat_max_context_chars"
            value="{{ rag_settings.get('chat_max_context_chars', '12000') }}"
          />
        </label>
        <label class="label">
          Snippet Characters
          <input
            class="input"
            type="number"
            min="100"
            name="rag_chat_snippet_chars"
            value="{{ rag_settings.get('chat_snippet_chars', '600') }}"
          />
        </label>
        <label class="label">
          Context Budget Tokens
          <input
            class="input"
            type="number"
            min="256"
            name="rag_chat_context_budget_tokens"
            value="{{ rag_settings.get('chat_context_budget_tokens', '8000') }}"
          />
        </label>
        <label class="label">
          Index Parallel Workers
          <input
            class="input"
            type="number"
            min="1"
            max="64"
            name="rag_index_parallel_workers"
            value="{{ rag_settings.get('index_parallel_workers', '1') }}"
          />
        </label>
        <label class="label">
          Embed Parallel Requests
          <input
            class="input"
            type="number"
            min="1"
            max="64"
            name="rag_embed_parallel_requests"
            value="{{ rag_settings.get('embed_parallel_requests', '1') }}"
          />
        </label>
        <div class="form-actions">
          <button class="btn btn-primary" type="submit">
            <i class="fa-solid fa-floppy-disk"></i>
            save rag runtime
          </button>
        </div>
      </form>
    </section>
  {% endif %}

  {% if runtime_section == "chat" %}
    {% set chat_runtime_form_id = "runtime-chat-settings-form" %}
    {% set chat_runtime_submit_label = "save chat runtime" %}
    {% set chat_runtime_return_to = "runtime" %}
    {% include "partials/chat_runtime_settings_panel.html" %}
  {% endif %}
  </section>
</section>
{% endblock %}
