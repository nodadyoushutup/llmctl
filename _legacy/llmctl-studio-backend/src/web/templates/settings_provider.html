{% extends "settings_layout.html" %}
{% set provider_section = provider_section if provider_section is defined else "controls" %}
{% set provider_nav = [
  {
    "id": "controls",
    "label": "Provider Controls",
    "icon": "fa-solid fa-wave-square",
    "url": url_for("agents.settings_provider"),
  },
  {
    "id": "codex",
    "label": "Codex",
    "icon": "fa-solid fa-robot",
    "url": url_for("agents.settings_provider_codex"),
  },
  {
    "id": "gemini",
    "label": "Gemini",
    "icon": "fa-solid fa-star",
    "url": url_for("agents.settings_provider_gemini"),
  },
  {
    "id": "claude",
    "label": "Claude",
    "icon": "fa-solid fa-brain",
    "url": url_for("agents.settings_provider_claude"),
  },
  {
    "id": "vllm_local",
    "label": "vLLM Local",
    "icon": "fa-solid fa-computer",
    "url": url_for("agents.settings_provider_vllm_local"),
  },
  {
    "id": "vllm_remote",
    "label": "vLLM Remote",
    "icon": "fa-solid fa-globe",
    "url": url_for("agents.settings_provider_vllm_remote"),
  },
] %}

{% block topbar_actions %}
{% endblock %}

{% block action_header %}
  <div class="action-header-actions">
    {% if provider_section == "controls" %}
      <button class="btn btn-primary" type="submit" form="provider-controls-form">
        <i class="fa-solid fa-floppy-disk"></i>
        save providers
      </button>
    {% elif provider_section == "codex" %}
      <button class="btn btn-primary" type="submit" form="provider-codex-form">
        <i class="fa-solid fa-floppy-disk"></i>
        save codex auth
      </button>
    {% elif provider_section == "gemini" %}
      <button class="btn btn-primary" type="submit" form="provider-gemini-form">
        <i class="fa-solid fa-floppy-disk"></i>
        save gemini auth
      </button>
    {% elif provider_section == "claude" %}
      <button class="btn btn-primary" type="submit" form="provider-claude-form">
        <i class="fa-solid fa-floppy-disk"></i>
        save claude auth
      </button>
    {% elif provider_section == "vllm_local" %}
      <button class="btn btn-primary" type="submit" form="provider-vllm-local-form">
        <i class="fa-solid fa-floppy-disk"></i>
        save vllm local settings
      </button>
    {% elif provider_section == "vllm_remote" %}
      <button class="btn btn-primary" type="submit" form="provider-vllm-remote-form">
        <i class="fa-solid fa-floppy-disk"></i>
        save vllm remote settings
      </button>
    {% endif %}
  </div>
{% endblock %}

{% block settings_content %}
<style>
  .provider-layout {
    display: grid;
    grid-template-columns: minmax(220px, 260px) minmax(0, 1fr);
    gap: 18px;
    align-items: start;
  }

  .provider-sidebar {
    border-radius: 18px;
    border: 1px solid var(--line);
    background: rgba(17, 24, 33, 0.9);
    padding: 14px;
    box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
    position: sticky;
    top: 0;
  }

  .provider-sidebar-title {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    color: var(--muted);
  }

  .provider-sidebar-nav {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .provider-sidebar-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    border-radius: 12px;
    border: 1px solid var(--line);
    background: rgba(11, 15, 20, 0.6);
    color: var(--muted);
    padding: 10px 12px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    font-weight: 600;
    transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease;
  }

  .provider-sidebar-link-main {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .provider-sidebar-link-main i {
    width: 14px;
    text-align: center;
  }

  .provider-sidebar-link .fa-chevron-right {
    font-size: 10px;
    color: var(--muted);
  }

  .provider-sidebar-link:hover {
    border-color: rgba(255, 122, 24, 0.4);
    color: #fff;
  }

  .provider-sidebar-link.is-active {
    background: rgba(255, 122, 24, 0.15);
    border-color: rgba(255, 122, 24, 0.55);
    color: #fff;
  }

  .provider-sidebar-link.is-active .fa-chevron-right {
    color: var(--accent);
  }

  .provider-layout > .stack {
    min-width: 0;
  }

  @media (max-width: 980px) {
    .provider-layout {
      grid-template-columns: minmax(0, 1fr);
    }

    .provider-sidebar {
      position: static;
    }

    .provider-sidebar-nav {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
  }

  @media (max-width: 640px) {
    .provider-sidebar-nav {
      grid-template-columns: minmax(0, 1fr);
    }
  }
</style>
<section class="provider-layout">
  <aside class="provider-sidebar" aria-label="Provider sections">
    <p class="provider-sidebar-title">Provider Sections</p>
    <nav class="provider-sidebar-nav">
      {% for item in provider_nav %}
        <a
          href="{{ item.url }}"
          class="provider-sidebar-link{% if provider_section == item.id %} is-active{% endif %}"
        >
          <span class="provider-sidebar-link-main">
            <i class="{{ item.icon }}"></i>
            <span>{{ item.label }}</span>
          </span>
          <i class="fa-solid fa-chevron-right"></i>
        </a>
      {% endfor %}
    </nav>
  </aside>
<section class="stack">
  {% if provider_section == "controls" %}
    <section class="card">
      <div class="card-header">
        <h2 class="section-title">Provider Controls</h2>
      </div>
      <p class="muted" style="margin-top: 12px;">
        Enable providers and choose an optional default for agents without a model.
      </p>
      <form
        id="provider-controls-form"
        method="post"
        action="{{ url_for('agents.update_provider_settings') }}"
        class="form-grid"
        style="margin-top: 20px;"
      >
        <div class="stack" style="grid-column: 1 / -1;">
          {% for provider in provider_details %}
            <div class="subcard" data-provider="{{ provider.id }}">
              <div class="row-between">
                <div>
                  <p class="eyebrow">{{ provider.label }}</p>
                  <p class="muted" style="margin-top: 6px; font-size: 12px;">
                    Command {{ provider.command }}. Default model {{ provider.model }}.
                  </p>
                </div>
                <div class="row" style="gap: 20px;">
                  <div class="row" style="gap: 8px;">
                    <span class="muted" style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.2em;">
                      enabled
                    </span>
                    <label class="switch">
                      <input
                        type="checkbox"
                        name="provider_enabled_{{ provider.id }}"
                        value="true"
                        class="provider-enabled-toggle"
                        data-provider="{{ provider.id }}"
                        {% if provider.enabled %}checked{% endif %}
                      />
                      <span class="switch-slider"></span>
                    </label>
                  </div>
                  <div class="row" style="gap: 8px;">
                    <span class="muted" style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.2em;">
                      default
                    </span>
                    <label class="switch">
                      <input
                        type="checkbox"
                        name="default_provider"
                        value="{{ provider.id }}"
                        class="default-provider-toggle"
                        data-provider="{{ provider.id }}"
                        {% if provider.is_default %}checked{% endif %}
                      />
                      <span class="switch-slider"></span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </form>
      <p class="muted" style="margin-top: 16px; font-size: 12px;">
        Default model selection overrides provider defaults when assigned to an agent.
      </p>
    </section>
  {% endif %}

  {% if provider_section == "codex" %}
    <section class="card">
      <div class="card-header">
        <h2 class="section-title">Codex Auth</h2>
      </div>
      <p class="muted" style="margin-top: 12px;">
        Configure API credentials for Codex.
      </p>
      <form
        id="provider-codex-form"
        method="post"
        action="{{ url_for('agents.update_codex_settings') }}"
        class="form-grid"
        style="margin-top: 20px;"
      >
        <label class="label" style="grid-column: 1 / -1;">
          Codex API key
          <input
            class="input"
            type="password"
            name="codex_api_key"
            value="{{ codex_settings.api_key }}"
            placeholder="sk-..."
          />
        </label>
      </form>
    </section>
  {% endif %}

  {% if provider_section == "gemini" %}
    <section class="card">
      <div class="card-header">
        <h2 class="section-title">Gemini Auth</h2>
      </div>
      <p class="muted" style="margin-top: 12px;">
        Configure API credentials for Gemini.
      </p>
      <form
        id="provider-gemini-form"
        method="post"
        action="{{ url_for('agents.update_gemini_settings') }}"
        class="form-grid"
        style="margin-top: 20px;"
      >
        <label class="label" style="grid-column: 1 / -1;">
          Gemini API key
          <input
            class="input"
            type="password"
            name="gemini_api_key"
            value="{{ gemini_settings.api_key }}"
            placeholder="AIza..."
          />
        </label>
      </form>
    </section>
  {% endif %}

  {% if provider_section == "claude" %}
    {% set claude_runtime = claude_settings.runtime %}
    <section class="card">
      <div class="card-header">
        <div>
          <h2 class="section-title">Claude Auth</h2>
          <p class="muted" style="margin-top: 6px; font-size: 12px;">
            Runtime command {{ claude_runtime.command }}.
          </p>
        </div>
        <span class="status {% if claude_runtime.cli_ready and (claude_runtime.auth_ready or not claude_runtime.auth_required) %}status-success{% else %}status-warning{% endif %}">
          {% if claude_runtime.cli_ready and (claude_runtime.auth_ready or not claude_runtime.auth_required) %}
            ready
          {% elif not claude_runtime.cli_ready %}
            cli missing
          {% else %}
            auth required
          {% endif %}
        </span>
      </div>
      <p class="muted" style="margin-top: 12px;">
        Configure API credentials for Claude (Anthropic).
      </p>
      <form
        id="provider-claude-form"
        method="post"
        action="{{ url_for('agents.update_claude_settings') }}"
        class="form-grid"
        style="margin-top: 20px;"
      >
        <label class="label" style="grid-column: 1 / -1;">
          Anthropic API key
          <input
            class="input"
            type="password"
            name="claude_api_key"
            value="{{ claude_settings.api_key }}"
            placeholder="sk-ant-..."
          />
        </label>
        <label class="label" style="grid-column: 1 / -1;">
          Runtime diagnostics
          <div class="subcard" style="margin-top: 10px;">
            <p class="muted" style="font-size: 12px;">
              CLI status:
              {% if claude_runtime.cli_ready %}
                ready ({{ claude_runtime.cli_version }})
              {% else %}
                unavailable
              {% endif %}
            </p>
            <p class="muted" style="margin-top: 6px; font-size: 12px;">
              CLI path:
              {% if claude_runtime.cli_path %}
                {{ claude_runtime.cli_path }}
              {% else %}
                not found
              {% endif %}
            </p>
            {% if claude_runtime.cli_error %}
              <p class="muted" style="margin-top: 6px; font-size: 12px;">
                CLI check: {{ claude_runtime.cli_error }}
              </p>
            {% endif %}
            <p class="muted" style="margin-top: 6px; font-size: 12px;">
              Auth status:
              {% if claude_runtime.auth_ready %}
                configured ({{ claude_runtime.auth_source }})
              {% elif claude_runtime.auth_required %}
                missing API key
              {% else %}
                optional
              {% endif %}
            </p>
            <p class="muted" style="margin-top: 6px; font-size: 12px;">
              Auto-install:
              {% if claude_runtime.auto_install_enabled %}enabled{% else %}disabled{% endif %}
              â€¢ fail-fast:
              {% if claude_runtime.require_cli_ready %}enabled{% else %}disabled{% endif %}
            </p>
          </div>
        </label>
      </form>
    </section>
  {% endif %}

  {% if provider_section == "vllm_local" %}
    <section class="card">
      <div class="card-header">
        <h2 class="section-title">vLLM Local Provider</h2>
      </div>
      <p class="muted" style="margin-top: 12px;">
        Configure in-container vLLM CLI usage and discovered local default model.
        HuggingFace token/download controls are managed in Integrations.
      </p>
      <form
        id="provider-vllm-local-form"
        method="post"
        action="{{ url_for('agents.update_vllm_local_settings') }}"
        class="form-grid"
        style="margin-top: 20px;"
      >
        <label class="label" style="grid-column: 1 / -1;">
          Local CLI command
          <p class="muted" style="margin-top: 8px; font-size: 12px;">
            {{ vllm_local_settings.command }} run-batch
          </p>
        </label>
        <label class="label" style="grid-column: 1 / -1;">
          Local default model
          <select class="input" name="vllm_local_model">
            {% for option in vllm_local_settings.models %}
              <option value="{{ option.value }}" {% if option.value == vllm_local_settings.model %}selected{% endif %}>
                {{ option.label }} ({{ option.source }})
              </option>
            {% endfor %}
          </select>
          <p class="muted" style="margin-top: 6px; font-size: 12px;">
            custom dir: {{ vllm_local_settings.custom_dir }}
          </p>
        </label>
        <p class="muted" style="grid-column: 1 / -1; margin-top: 6px; font-size: 12px;">
          Manage HuggingFace token and model downloads in
          <a href="{{ url_for('agents.settings_integrations_huggingface') }}">Settings / Integrations / Hugging Face</a>.
        </p>
      </form>
    </section>
  {% endif %}

  {% if provider_section == "vllm_remote" %}
    <section class="card">
      <div class="card-header">
        <h2 class="section-title">vLLM Remote Provider</h2>
      </div>
      <p class="muted" style="margin-top: 12px;">
        Configure remote vLLM endpoint/auth and default remote model options.
      </p>
      <form
        id="provider-vllm-remote-form"
        method="post"
        action="{{ url_for('agents.update_vllm_remote_settings') }}"
        class="form-grid"
        style="margin-top: 20px;"
      >
        <label class="label">
          Remote base URL
          <input
            class="input"
            type="text"
            name="vllm_remote_base_url"
            value="{{ vllm_remote_settings.base_url }}"
            placeholder="https://vllm.example.com/v1"
          />
        </label>
        <label class="label">
          Remote API key (optional)
          <input
            class="input"
            type="password"
            name="vllm_remote_api_key"
            value="{{ vllm_remote_settings.api_key }}"
            placeholder="optional"
          />
        </label>
        <label class="label" style="grid-column: 1 / -1;">
          Remote default model
          <input
            class="input"
            type="text"
            name="vllm_remote_model"
            value="{{ vllm_remote_settings.model }}"
            list="vllm-remote-default-model-options"
            placeholder="GLM-4.7-Flash"
          />
          <datalist id="vllm-remote-default-model-options">
            {% for option in vllm_remote_settings.models %}
              <option value="{{ option }}"></option>
            {% endfor %}
          </datalist>
        </label>
        <label class="label" style="grid-column: 1 / -1;">
          Remote model options (comma or newline separated)
          <textarea
            class="textarea"
            name="vllm_remote_models"
            placeholder="GLM-4.7-Flash"
          >{{ vllm_remote_settings.models | join('\n') }}</textarea>
        </label>
      </form>
    </section>
  {% endif %}
  </section>
</section>

{% if provider_section == "controls" %}
  <script>
    const defaultProviderToggles = document.querySelectorAll(".default-provider-toggle");
    const enabledProviderToggles = document.querySelectorAll(".provider-enabled-toggle");

    defaultProviderToggles.forEach((toggle) => {
      toggle.addEventListener("change", () => {
        if (!toggle.checked) {
          return;
        }
        defaultProviderToggles.forEach((other) => {
          if (other !== toggle) {
            other.checked = false;
          }
        });
        const provider = toggle.dataset.provider;
        const enabledToggle = document.querySelector(
          `.provider-enabled-toggle[data-provider="${provider}"]`
        );
        if (enabledToggle) {
          enabledToggle.checked = true;
        }
      });
    });

    enabledProviderToggles.forEach((toggle) => {
      toggle.addEventListener("change", () => {
        if (toggle.checked) {
          return;
        }
        const provider = toggle.dataset.provider;
        const defaultToggle = document.querySelector(
          `.default-provider-toggle[data-provider="${provider}"]`
        );
        if (defaultToggle) {
          defaultToggle.checked = false;
        }
      });
    });
  </script>
{% endif %}
{% endblock %}
