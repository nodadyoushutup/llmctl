{% extends "base.html" %}

{% macro pagination_controls(pagination) %}
  <nav class="pagination" aria-label="Tasks pages">
    {% if pagination.prev_url %}
      <a class="pagination-btn" href="{{ pagination.prev_url }}">Prev</a>
    {% else %}
      <span class="pagination-btn is-disabled" aria-disabled="true">Prev</span>
    {% endif %}
    <div class="pagination-pages">
      {% for item in pagination.page_items %}
        {% if item.is_gap %}
          <span class="pagination-ellipsis">&hellip;</span>
        {% elif item.is_current %}
          <span class="pagination-link is-active" aria-current="page">{{ item.label }}</span>
        {% else %}
          <a class="pagination-link" href="{{ item.url }}">{{ item.label }}</a>
        {% endif %}
      {% endfor %}
    </div>
    {% if pagination.next_url %}
      <a class="pagination-btn" href="{{ pagination.next_url }}">Next</a>
    {% else %}
      <span class="pagination-btn is-disabled" aria-disabled="true">Next</span>
    {% endif %}
  </nav>
{% endmacro %}

{% block action_header %}
  <div class="pagination-bar pagination-bar-header">
    {{ pagination_controls(pagination) }}
  </div>
{% endblock %}

{% block content %}
<section class="card workflow-list-card">
  {% if task_nodes %}
    <div class="workflow-list-table-shell">
      <table class="table">
        <thead>
          <tr>
            <th>Task</th>
            <th>Type</th>
            <th>Flowchart</th>
            <th>Prompt</th>
          </tr>
        </thead>
        <tbody>
          {% for task in task_nodes %}
            <tr
              class="table-row-link"
              data-href="{{ url_for('agents.view_flowchart', flowchart_id=task.flowchart_id) }}?node={{ task.node_id }}"
            >
              <td>
                <a href="{{ url_for('agents.view_flowchart', flowchart_id=task.flowchart_id) }}?node={{ task.node_id }}">
                  <p>{{ task.task_name }}</p>
                </a>
              </td>
              <td class="muted">
                {{ task.node_type }}
              </td>
              <td class="muted">
                {{ task.flowchart_name }}
              </td>
              <td class="muted">
                {{ task.prompt_preview }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted">
      No workflow nodes found yet. Add a Task or RAG node in any flowchart.
    </p>
  {% endif %}
</section>

<script>
  const taskRows = document.querySelectorAll(".table-row-link");
  taskRows.forEach((row) => {
    row.addEventListener("click", (event) => {
      const target = event.target;
      if (
        target.closest("a") ||
        target.closest("button") ||
        target.closest("input") ||
        target.closest("select") ||
        target.closest("textarea") ||
        target.closest("label") ||
        target.closest("summary") ||
        target.closest("details")
      ) {
        return;
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });
  });
</script>
{% endblock %}
