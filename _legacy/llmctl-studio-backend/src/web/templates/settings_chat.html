{% extends "settings_layout.html" %}

{% block action_header %}
  <button class="btn btn-primary" type="submit" form="chat-default-settings-form">
    <i class="fa-solid fa-floppy-disk"></i>
    save chat settings
  </button>
{% endblock %}

{% block settings_content %}
<section class="stack">
  <section class="card">
    <div class="card-header">
      <h2 class="section-title">Chat Defaults</h2>
    </div>
    <p class="muted" style="margin-top: 12px;">
      Defaults here are applied when creating a new chat thread.
    </p>
    <p class="muted" style="margin-top: 8px;">
      Runtime controls (compaction, context budget, retrieval) are managed in
      <a href="{{ url_for('agents.settings_runtime_chat') }}">Settings > Runtime > Chat Runtime</a>.
    </p>
  </section>

  <section class="card">
    <form
      id="chat-default-settings-form"
      method="post"
      action="{{ url_for('agents.update_chat_default_settings_route') }}"
      class="form-grid"
    >
      <label class="label">
        Default Model
        <select class="input" name="default_model_id">
          <option value="">Use provider/global default</option>
          {% for model in models %}
            <option
              value="{{ model.id }}"
              {% if chat_default_settings.default_model_id == model.id %}selected{% endif %}
            >
              {{ model.name }} ({{ model.provider }})
            </option>
          {% endfor %}
        </select>
      </label>

      <label class="label">
        Default Complexity
        <select class="input" name="default_response_complexity">
          <option value="low" {% if chat_default_settings.default_response_complexity == 'low' %}selected{% endif %}>Low</option>
          <option value="medium" {% if chat_default_settings.default_response_complexity == 'medium' %}selected{% endif %}>Medium</option>
          <option value="high" {% if chat_default_settings.default_response_complexity == 'high' %}selected{% endif %}>High</option>
          <option value="extra_high" {% if chat_default_settings.default_response_complexity == 'extra_high' %}selected{% endif %}>Extra High</option>
        </select>
      </label>

      <section class="subcard" style="grid-column: 1 / -1;">
        <p class="eyebrow">default mcp servers</p>
        <p class="muted" style="margin-top: 8px; font-size: 12px;">
          These MCP servers are pre-selected for new threads.
        </p>
        {% if mcp_servers %}
          <div class="grid grid-2" style="margin-top: 12px; gap: 10px;">
            {% for server in mcp_servers %}
              <label style="display: flex; align-items: center; gap: 8px;">
                <input
                  type="checkbox"
                  name="default_mcp_server_ids"
                  value="{{ server.id }}"
                  {% if server.id in chat_default_settings.default_mcp_server_ids %}checked{% endif %}
                />
                <span>{{ server.name }}</span>
                {% if (server.server_type or "custom") == "integrated" %}
                  <span class="status status-success">integrated</span>
                {% endif %}
              </label>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted" style="margin-top: 10px;">No MCP servers available.</p>
        {% endif %}
      </section>

      <section class="subcard" style="grid-column: 1 / -1;">
        <p class="eyebrow">default rag collections</p>
        <p class="muted" style="margin-top: 8px; font-size: 12px;">
          Collections to pre-select for new threads when RAG is healthy.
        </p>
        {% if rag_health.state == 'configured_healthy' and rag_collections %}
          <div class="grid grid-2" style="margin-top: 12px; gap: 10px;">
            {% for collection in rag_collections %}
              <label style="display: flex; align-items: center; gap: 8px;">
                <input
                  type="checkbox"
                  name="default_rag_collections"
                  value="{{ collection.id }}"
                  {% if collection.id in chat_default_settings.default_rag_collections %}checked{% endif %}
                />
                <span>{{ collection.name }}</span>
              </label>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted" style="margin-top: 10px;">
            RAG state: {{ rag_health.state }}{% if rag_health.error %} ({{ rag_health.error }}){% endif %}
          </p>
        {% endif %}
      </section>
    </form>
    <p class="muted" style="margin-top: 14px; font-size: 12px;">
      Chat threads are session-scoped. Agent-level defaults are not yet part of chat thread schema.
    </p>
  </section>
</section>
{% endblock %}
