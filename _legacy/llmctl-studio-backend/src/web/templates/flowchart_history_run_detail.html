{% extends "base.html" %}

{% block topbar_actions %}
  <a class="btn btn-secondary" href="{{ url_for('agents.view_flowchart_history', flowchart_id=flowchart.id) }}">
    <i class="fa-solid fa-arrow-left"></i>
    back to history
  </a>
  <a class="btn btn-secondary" href="{{ url_for('agents.view_flowchart', flowchart_id=flowchart.id) }}">
    <i class="fa-solid fa-diagram-project"></i>
    open flowchart
  </a>
{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Run {{ flowchart_run.id }}</h2>
  </div>
  <div style="margin-top: 20px; overflow-x: auto;">
    <table class="table">
      <thead>
        <tr>
          <th>Status</th>
          <th>Cycles</th>
          <th>Node runs</th>
          <th>Created</th>
          <th>Started</th>
          <th>Finished</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <span class="status {{ status_class(flowchart_run.status) }}">{{ flowchart_run.status }}</span>
          </td>
          <td class="muted">{{ flowchart_run.cycle_count }}</td>
          <td class="muted">{{ flowchart_run.node_run_count }}</td>
          <td class="muted">{{ flowchart_run.created_at or "-" }}</td>
          <td class="muted">{{ flowchart_run.started_at or "-" }}</td>
          <td class="muted">{{ flowchart_run.finished_at or "-" }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

{% if flowchart_run.status in ["queued", "running", "stopping"] %}
  <section class="card">
    <div class="card-header">
      <h2 class="section-title">Run Controls</h2>
    </div>
    <div class="row" style="margin-top: 16px; gap: 10px; flex-wrap: wrap;">
      {% if flowchart_run.status in ["queued", "running"] %}
        <form method="post" action="{{ url_for('agents.cancel_flowchart_run', run_id=flowchart_run.id) }}">
          <input type="hidden" name="next" value="{{ request.path }}" />
          <button type="submit" class="btn btn-secondary">
            <i class="fa-solid fa-stop"></i>
            stop after current node
          </button>
        </form>
      {% endif %}
      <form
        method="post"
        action="{{ url_for('agents.cancel_flowchart_run', run_id=flowchart_run.id) }}"
        onsubmit="return confirm('Force stop this run immediately?');"
      >
        <input type="hidden" name="next" value="{{ request.path }}" />
        <input type="hidden" name="force" value="true" />
        <button type="submit" class="btn btn-danger">
          <i class="fa-solid fa-power-off"></i>
          force stop now
        </button>
      </form>
    </div>
    {% if flowchart_run.status == "stopping" %}
      <p class="muted" style="margin-top: 12px;">
        Stop requested. This run will stop after the current node finishes.
      </p>
    {% endif %}
  </section>
{% endif %}

<section class="card">
  <div class="card-header">
    <h2 class="section-title">Node Runs</h2>
  </div>
  {% if node_runs %}
    <div style="margin-top: 20px; overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Node run</th>
            <th>Cycle</th>
            <th>Node</th>
            <th>Status</th>
            <th>Execution</th>
            <th>Runtime</th>
            <th>Dispatch / Fallback</th>
            <th>Triggered By (Solid)</th>
            <th>Pulled Context (Dotted)</th>
            <th>Node task</th>
            <th>Started</th>
            <th>Finished</th>
          </tr>
        </thead>
        <tbody>
          {% for node_run in node_runs %}
            <tr
              {% if node_run.agent_task_id %}
                class="table-row-link"
                data-href="{{ url_for('agents.view_node', task_id=node_run.agent_task_id) }}"
              {% endif %}
            >
              <td>
                {% if node_run.agent_task_id %}
                  <a href="{{ url_for('agents.view_node', task_id=node_run.agent_task_id) }}">
                    {{ node_run.id }}
                  </a>
                {% else %}
                  {{ node_run.id }}
                {% endif %}
              </td>
              <td class="muted">{{ node_run.cycle_index }}</td>
              <td>
                <p>{{ node_run.node_title }}</p>
                <p class="muted" style="font-size: 12px; margin-top: 4px;">{{ node_run.node_type }}</p>
              </td>
              <td>
                <span class="status {{ status_class(node_run.status) }}">{{ node_run.status }}</span>
              </td>
              <td class="muted">{{ node_run.execution_index }}</td>
              <td>
                <p class="muted" style="margin: 0; font-size: 12px;">
                  {{ node_run.provider_route or "-" }}
                </p>
                <p class="muted" style="margin: 4px 0 0; font-size: 12px;">
                  dispatch id: {{ node_run.provider_dispatch_id or "-" }}
                </p>
                <p class="muted" style="margin: 4px 0 0; font-size: 12px;">
                  workspace: {{ node_run.workspace_identity or "-" }}
                </p>
              </td>
              <td>
                <p class="muted" style="margin: 0; font-size: 12px;">
                  {{ node_run.dispatch_status or "-" }}
                  {% if node_run.dispatch_uncertain %}
                    (uncertain)
                  {% endif %}
                </p>
                {% if node_run.fallback_attempted %}
                  <p class="muted" style="margin: 4px 0 0; font-size: 12px;">
                    fallback: {{ node_run.fallback_reason or "unknown" }}
                  </p>
                {% endif %}
                {% if node_run.api_failure_category %}
                  <p class="muted" style="margin: 4px 0 0; font-size: 12px;">
                    api failure: {{ node_run.api_failure_category }}
                  </p>
                {% endif %}
                {% if node_run.cli_fallback_used %}
                  <p class="muted" style="margin: 4px 0 0; font-size: 12px;">
                    cli fallback: {{ "preflight ok" if node_run.cli_preflight_passed else "preflight unknown" }}
                  </p>
                {% endif %}
              </td>
              <td>
                {% if node_run.trigger_sources %}
                  {% for source in node_run.trigger_sources %}
                    <p class="muted" style="margin: 0; font-size: 12px;">
                      edge {{ source.source_edge_id or "-" }} from node {{ source.source_node_id or "-" }}
                      {% if source.source_node_type %}
                        ({{ source.source_node_type }})
                      {% endif %}
                    </p>
                  {% endfor %}
                {% else %}
                  <span class="muted">-</span>
                {% endif %}
              </td>
              <td>
                {% if node_run.pulled_dotted_sources %}
                  {% for source in node_run.pulled_dotted_sources %}
                    <p class="muted" style="margin: 0; font-size: 12px;">
                      edge {{ source.source_edge_id or "-" }} from node {{ source.source_node_id or "-" }}
                      {% if source.source_node_type %}
                        ({{ source.source_node_type }})
                      {% endif %}
                    </p>
                  {% endfor %}
                {% else %}
                  <span class="muted">-</span>
                {% endif %}
              </td>
              <td>
                {% if node_run.agent_task_id %}
                  <a href="{{ url_for('agents.view_node', task_id=node_run.agent_task_id) }}">
                    {{ node_run.agent_task_id }}
                  </a>
                {% else %}
                  <span class="muted">-</span>
                {% endif %}
              </td>
              <td class="muted">{{ node_run.started_at or "-" }}</td>
              <td class="muted">{{ node_run.finished_at or "-" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 12px;">No node runs recorded for this flowchart run yet.</p>
  {% endif %}
</section>

{% if flowchart_run.status in ["queued", "running", "stopping"] %}
  <script>
    (() => {
      const flowchartId = Number("{{ flowchart.id }}");
      const runId = Number("{{ flowchart_run.id }}");
      const fallbackDelayMs = 4000;
      let fallbackTimer = null;
      let fallbackEnabled = false;
      let reloadPending = false;
      let realtimeController = null;

      const scheduleReload = (delayMs = 120) => {
        if (reloadPending) {
          return;
        }
        reloadPending = true;
        window.setTimeout(() => {
          window.location.reload();
        }, delayMs);
      };

      const scheduleFallbackReload = () => {
        if (!fallbackEnabled) {
          return;
        }
        fallbackTimer = window.setTimeout(() => {
          scheduleReload(0);
        }, fallbackDelayMs);
      };

      const startFallback = () => {
        if (fallbackEnabled) {
          return;
        }
        fallbackEnabled = true;
        scheduleFallbackReload();
      };

      const stopFallback = () => {
        fallbackEnabled = false;
        if (fallbackTimer) {
          window.clearTimeout(fallbackTimer);
          fallbackTimer = null;
        }
      };

      if (!window.llmctlRealtime || typeof window.llmctlRealtime.connect !== "function") {
        startFallback();
        return;
      }

      realtimeController = window.llmctlRealtime.connect({
        roomKeys: [`flowchart:${flowchartId}`, `flowchart_run:${runId}`],
        onSocketReady: () => {
          stopFallback();
        },
        onSocketFailure: () => {
          startFallback();
        },
        onEvent: (eventName, envelope) => {
          const data = envelope && typeof envelope === "object" ? envelope : {};
          const eventType = String(data.event_type || eventName || "").trim();
          if (!eventType.startsWith("flowchart.")) {
            return;
          }
          const payload = data.payload && typeof data.payload === "object" ? data.payload : {};
          const payloadFlowchartId = Number(payload.flowchart_id || "0");
          const payloadRunId = Number(payload.flowchart_run_id || "0");
          if (payloadFlowchartId !== flowchartId || payloadRunId !== runId) {
            return;
          }
          scheduleReload();
        },
      });

      if (!realtimeController) {
        startFallback();
        return;
      }

      window.addEventListener("beforeunload", () => {
        stopFallback();
        if (realtimeController) {
          realtimeController.disconnect();
          realtimeController = null;
        }
      });
    })();
  </script>
{% endif %}

<script>
  const nodeRunRows = document.querySelectorAll(".table-row-link");
  const isInteractiveTarget = (target) =>
    target.closest(
      "a, button, input, select, textarea, label, summary, details"
    );
  nodeRunRows.forEach((row) => {
    row.addEventListener("click", (event) => {
      if (isInteractiveTarget(event.target)) {
        return;
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });
  });
</script>
{% endblock %}
