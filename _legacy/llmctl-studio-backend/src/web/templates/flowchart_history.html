{% extends "base.html" %}

{% block topbar_actions %}
  <a class="btn btn-secondary" href="{{ url_for('agents.view_flowchart', flowchart_id=flowchart.id) }}">
    <i class="fa-solid fa-arrow-left"></i>
    back to flowchart
  </a>
{% endblock %}

{% block content %}
<section class="card">
  <div class="card-header">
    <h2 class="section-title">Flowchart History</h2>
  </div>
  <p class="muted" style="margin-top: 12px;">
    {{ flowchart.name }}. Each run begins at Start. If execution routes back to Start, the current run completes and a new run is queued.
  </p>

  {% if runs %}
    <div style="margin-top: 20px; overflow-x: auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Run</th>
            <th>Status</th>
            <th>Cycles</th>
            <th>Node runs</th>
            <th>Created</th>
            <th>Started</th>
            <th>Finished</th>
          </tr>
        </thead>
        <tbody>
          {% for run in runs %}
            <tr
              class="table-row-link"
              data-href="{{ url_for('agents.view_flowchart_history_run', flowchart_id=flowchart.id, run_id=run.id) }}"
            >
              <td>
                <a href="{{ url_for('agents.view_flowchart_history_run', flowchart_id=flowchart.id, run_id=run.id) }}">
                  run {{ run.id }}
                </a>
              </td>
              <td>
                <span class="status {{ status_class(run.status) }}">{{ run.status }}</span>
              </td>
              <td class="muted">{{ run.cycle_count }}</td>
              <td class="muted">{{ run.node_run_count }}</td>
              <td class="muted">{{ run.created_at or "-" }}</td>
              <td class="muted">{{ run.started_at or "-" }}</td>
              <td class="muted">{{ run.finished_at or "-" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted" style="margin-top: 16px;">No flowchart history yet.</p>
  {% endif %}
</section>

<script>
  const historyRows = document.querySelectorAll(".table-row-link");
  const isInteractiveTarget = (target) =>
    target.closest(
      "a, button, input, select, textarea, label, summary, details"
    );

  historyRows.forEach((row) => {
    row.addEventListener("click", (event) => {
      if (isInteractiveTarget(event.target)) {
        return;
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });
  });
</script>
{% endblock %}
